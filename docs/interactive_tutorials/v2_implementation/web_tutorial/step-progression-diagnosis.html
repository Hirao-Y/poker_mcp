<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸš¨ ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œç•°å¸¸ ç·Šæ€¥è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #fff0f0; }
        .critical-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; border: 3px solid #dc3545; }
        .diagnostic-panel { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; }
        .result-panel { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .critical { background: #f5c6cb; border: 2px solid #dc3545; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-critical { background: #dc3545; color: white; font-size: 16px; }
        .btn-diagnostic { background: #007bff; color: white; }
        .btn-fix { background: #28a745; color: white; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; white-space: pre-wrap; }
        .step-flow { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .step-box { padding: 10px; text-align: center; border-radius: 6px; font-weight: bold; }
        .step-normal { background: #e9ecef; color: #495057; }
        .step-current { background: #007bff; color: white; }
        .step-error { background: #dc3545; color: white; }
        .step-skip { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <h1>ğŸš¨ ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œç•°å¸¸ ç·Šæ€¥è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="critical-panel">
        <h2>âš ï¸ æ·±åˆ»ãªé€²è¡Œç•°å¸¸ã‚’æ¤œå‡º</h2>
        <p><strong>å ±å‘Šã•ã‚ŒãŸç•°å¸¸:</strong></p>
        <ul>
            <li>âŒ Step 1 â†’ Step 2 ã¸ã®é€²è¡Œå¤±æ•—ï¼ˆStep 3ã«ã‚¹ã‚­ãƒƒãƒ—ï¼‰</li>
            <li>âŒ Step 3 â†’ Step 4 ã¸ã®é€²è¡Œå¤±æ•—ï¼ˆé€²è¡Œåœæ­¢ï¼‰</li>
        </ul>
        
        <div class="step-flow">
            <div class="step-box step-normal">Step 1</div>
            <div class="step-box step-error">Step 2<br>ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹</div>
            <div class="step-box step-skip">Step 3<br>ç•°å¸¸åˆ°é”</div>
            <div class="step-box step-error">Step 4<br>åˆ°é”ä¸èƒ½</div>
            <div class="step-box step-normal">Step 5</div>
        </div>
        
        <button onclick="emergencyStepDiagnosis()" class="btn-critical">ğŸ” ç·Šæ€¥ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­</button>
        <button onclick="testAllStepProgression()" class="btn-diagnostic">ğŸ§ª å…¨ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œãƒ†ã‚¹ãƒˆ</button>
        <button onclick="fixStepProgression()" class="btn-fix">âš¡ é€²è¡Œä¿®å¾©å®Ÿè¡Œ</button>
        <button onclick="resetToStep1()" class="btn-fix">ğŸ”„ Step 1ã¸ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="diagnosticResults"></div>
    
    <div class="diagnostic-panel">
        <h3>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²è¡Œç›£è¦–</h3>
        <div id="progressMonitor"></div>
        <button onclick="startContinuousMonitoring()" class="btn-diagnostic">ğŸ“ˆ é€£ç¶šç›£è¦–é–‹å§‹</button>
        <button onclick="stopMonitoring()" class="btn-critical">â¹ï¸ ç›£è¦–åœæ­¢</button>
    </div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>

    <script>
        let resultsDiv = document.getElementById('diagnosticResults');
        let progressMonitor = document.getElementById('progressMonitor');
        let monitoringInterval = null;

        function addResult(title, type, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-panel ${type}`;
            resultDiv.innerHTML = `
                <h3>${getIcon(type)} ${title}</h3>
                <p><strong>è¨ºæ–­çµæœ:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
                <small>è¨ºæ–­æ™‚åˆ»: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return 'âœ…';
                case 'error': return 'âŒ';
                case 'warning': return 'âš ï¸';
                case 'critical': return 'ğŸš¨';
                default: return 'â„¹ï¸';
            }
        }

        function emergencyStepDiagnosis() {
            resultsDiv.innerHTML = '';
            console.log('ğŸš¨ ç·Šæ€¥ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­é–‹å§‹...');

            // 1. ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«çŠ¶æ…‹ã®å®Œå…¨ç¢ºèª
            diagnoseCurrentState();
            
            // 2. nextStep()ãƒ¡ã‚½ãƒƒãƒ‰ã®è©³ç´°åˆ†æ
            diagnoseNextStepMethod();
            
            // 3. ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
            diagnoseStepDataIntegrity();
            
            // 4. é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ç¢ºèª
            diagnoseProgressionLogic();
            
            // 5. DOMè¦ç´ ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºèª
            diagnoseDOMEvents();
        }

        function diagnoseCurrentState() {
            try {
                if (!window.tutorial) {
                    addResult('ç¾åœ¨çŠ¶æ…‹è¨ºæ–­', 'critical', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                const currentState = {
                    currentStep: tutorial.currentStep,
                    totalSteps: tutorial.totalSteps,
                    tutorialStepsLoaded: tutorial.tutorialSteps?.length,
                    tutorialStepsValid: Array.isArray(tutorial.tutorialSteps),
                    stepNumbers: tutorial.tutorialSteps?.map(s => s?.step),
                    currentStepTitle: document.getElementById('stepTitle')?.textContent,
                    currentStepBadge: document.getElementById('stepBadge')?.textContent,
                    modalVisible: document.getElementById('modalOverlay')?.style?.display === 'flex',
                    nextBtnDisabled: tutorial.nextBtn?.disabled
                };

                // ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¢ºèª
                const anomalies = [];
                if (currentState.currentStep !== 1 && currentState.currentStep !== 2 && currentState.currentStep !== 3) {
                    anomalies.push(`ç•°å¸¸ãªcurrentStepå€¤: ${currentState.currentStep}`);
                }
                if (currentState.stepNumbers && !currentState.stepNumbers.includes(currentState.currentStep)) {
                    anomalies.push(`currentStepãŒtutorialStepsã«å­˜åœ¨ã—ãªã„`);
                }
                if (currentState.tutorialStepsLoaded !== 5) {
                    anomalies.push(`æœŸå¾…å€¤5ã«å¯¾ã—ã¦ã‚¹ãƒ†ãƒƒãƒ—æ•°ãŒ${currentState.tutorialStepsLoaded}`);
                }

                addResult('ç¾åœ¨çŠ¶æ…‹è¨ºæ–­', anomalies.length > 0 ? 'error' : 'success',
                    anomalies.length > 0 ? `${anomalies.length}ä»¶ã®ç•°å¸¸ã‚’æ¤œå‡º` : 'åŸºæœ¬çŠ¶æ…‹ã¯æ­£å¸¸',
                    `ç¾åœ¨çŠ¶æ…‹:\n${JSON.stringify(currentState, null, 2)}\n\nç•°å¸¸:\n${anomalies.join('\n')}`
                );

            } catch (error) {
                addResult('ç¾åœ¨çŠ¶æ…‹è¨ºæ–­', 'critical', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`, error.stack);
            }
        }

        function diagnoseNextStepMethod() {
            try {
                if (!window.tutorial) return;

                const tutorial = window.tutorial;
                
                // nextStepãƒ¡ã‚½ãƒƒãƒ‰ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—
                const nextStepCode = tutorial.nextStep.toString();
                
                // é‡è¦ãªå‡¦ç†ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const codeAnalysis = {
                    hasCurrentStepIncrement: nextStepCode.includes('this.currentStep++'),
                    hasUpdateStepContent: nextStepCode.includes('updateStepContent'),
                    hasResetCode: nextStepCode.includes('resetCode'),
                    hasUpdateProgress: nextStepCode.includes('updateProgress'),
                    hasTotalStepsCheck: nextStepCode.includes('this.totalSteps'),
                    hasHideModal: nextStepCode.includes('hideCompletionModal'),
                    methodLength: nextStepCode.length
                };

                // æ‰‹å‹•ã§nextStep()ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ï¼ˆç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼‰
                const beforeStep = tutorial.currentStep;
                console.log('ğŸ§ª nextStep()æ‰‹å‹•å®Ÿè¡Œãƒ†ã‚¹ãƒˆ...');
                
                // å®‰å…¨ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                try {
                    const originalStep = tutorial.currentStep;
                    tutorial.nextStep();
                    
                    setTimeout(() => {
                        const afterStep = tutorial.currentStep;
                        const stepChanged = afterStep !== originalStep;
                        const expectedNextStep = originalStep + 1;
                        const correctProgression = afterStep === expectedNextStep;
                        
                        const testResult = {
                            beforeStep: originalStep,
                            afterStep: afterStep,
                            stepChanged: stepChanged,
                            correctProgression: correctProgression,
                            stepSkipped: afterStep > expectedNextStep,
                            progressionDifference: afterStep - originalStep
                        };

                        if (correctProgression) {
                            addResult('nextStep()å®Ÿè¡Œãƒ†ã‚¹ãƒˆ', 'success',
                                'nextStep()ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™',
                                `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResult, null, 2)}\n\nãƒ¡ã‚½ãƒƒãƒ‰åˆ†æ:\n${JSON.stringify(codeAnalysis, null, 2)}`
                            );
                        } else {
                            addResult('nextStep()å®Ÿè¡Œãƒ†ã‚¹ãƒˆ', 'error',
                                `nextStep()ã«ç•°å¸¸ãŒã‚ã‚Šã¾ã™: ${originalStep} â†’ ${afterStep}`,
                                `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResult, null, 2)}\n\nãƒ¡ã‚½ãƒƒãƒ‰åˆ†æ:\n${JSON.stringify(codeAnalysis, null, 2)}`
                            );
                        }
                        
                        // ãƒ†ã‚¹ãƒˆç”¨ã«å…ƒã«æˆ»ã™
                        tutorial.currentStep = originalStep;
                        tutorial.updateStepContent();
                        tutorial.updateProgress();
                        
                    }, 300);

                } catch (methodError) {
                    addResult('nextStep()å®Ÿè¡Œãƒ†ã‚¹ãƒˆ', 'critical',
                        `nextStep()å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼: ${methodError.message}`,
                        `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${methodError.stack}\n\nãƒ¡ã‚½ãƒƒãƒ‰åˆ†æ:\n${JSON.stringify(codeAnalysis, null, 2)}`
                    );
                }

            } catch (error) {
                addResult('nextStep()ãƒ¡ã‚½ãƒƒãƒ‰è¨ºæ–­', 'error', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function diagnoseStepDataIntegrity() {
            try {
                if (!window.tutorial || !window.tutorial.tutorialSteps) {
                    addResult('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§', 'error', 'tutorialStepsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const steps = window.tutorial.tutorialSteps;
                
                // å„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°ç¢ºèª
                const stepDetails = steps.map(step => ({
                    step: step?.step,
                    title: step?.title?.substring(0, 30),
                    hasTemplate: !!step?.template,
                    hasPhysicsBackground: !!step?.physics_background,
                    hasInstructions: !!step?.instructions,
                    templateLength: step?.template?.length
                }));

                // æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                const issues = [];
                const stepNumbers = steps.map(s => s?.step).sort((a, b) => a - b);
                const expectedNumbers = [1, 2, 3, 4, 5];
                
                if (JSON.stringify(stepNumbers) !== JSON.stringify(expectedNumbers)) {
                    issues.push(`ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã®ä¸æ•´åˆ: æœŸå¾…å€¤[1,2,3,4,5] å®Ÿéš›[${stepNumbers.join(',')}]`);
                }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const duplicates = stepNumbers.filter((item, index) => stepNumbers.indexOf(item) !== index);
                if (duplicates.length > 0) {
                    issues.push(`é‡è¤‡ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·: [${duplicates.join(',')}]`);
                }

                // æ¬ æãƒã‚§ãƒƒã‚¯
                const missing = expectedNumbers.filter(num => !stepNumbers.includes(num));
                if (missing.length > 0) {
                    issues.push(`æ¬ æã‚¹ãƒ†ãƒƒãƒ—ç•ªå·: [${missing.join(',')}]`);
                }

                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¢ºèª
                const templatesIssues = stepDetails.filter(s => s.step <= 4 && !s.hasTemplate);
                if (templatesIssues.length > 0) {
                    issues.push(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¬ æ: Step ${templatesIssues.map(s => s.step).join(',')}`);
                }

                addResult('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§', issues.length === 0 ? 'success' : 'error',
                    issues.length === 0 ? 'ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¯æ­£å¸¸' : `${issues.length}ä»¶ã®æ•´åˆæ€§å•é¡Œã‚’æ¤œå‡º`,
                    `ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°:\n${JSON.stringify(stepDetails, null, 2)}\n\nå•é¡Œ:\n${issues.join('\n')}`
                );

            } catch (error) {
                addResult('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§', 'error', `ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function diagnoseProgressionLogic() {
            try {
                if (!window.tutorial) return;

                const tutorial = window.tutorial;
                
                // é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã®çŠ¶æ³ç¢ºèª
                const progressionState = {
                    currentStep: tutorial.currentStep,
                    totalSteps: tutorial.totalSteps,
                    canProgressCheck: tutorial.currentStep < tutorial.totalSteps,
                    nextStepWouldBe: tutorial.currentStep + 1,
                    targetStepExists: tutorial.tutorialSteps?.find(s => s?.step === (tutorial.currentStep + 1)),
                    currentStepData: tutorial.tutorialSteps?.find(s => s?.step === tutorial.currentStep)
                };

                // å„ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®é€²è¡Œå¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                const progressionTests = [];
                for (let targetStep = 1; targetStep <= 5; targetStep++) {
                    const stepData = tutorial.tutorialSteps?.find(s => s?.step === targetStep);
                    progressionTests.push({
                        targetStep: targetStep,
                        exists: !!stepData,
                        title: stepData?.title,
                        canAccess: !!stepData,
                        hasTemplate: !!stepData?.template
                    });
                }

                // Step 1â†’2â†’3ã®é€²è¡Œãƒ‘ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                console.log('ğŸ”„ é€²è¡Œãƒ‘ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...');
                const simulationResults = [];
                
                // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
                const originalStep = tutorial.currentStep;
                
                try {
                    // Step 1ã«è¨­å®š
                    tutorial.currentStep = 1;
                    const step1Data = tutorial.tutorialSteps?.find(s => s?.step === 1);
                    simulationResults.push({
                        fromStep: 'initial',
                        toStep: 1,
                        success: !!step1Data,
                        data: !!step1Data
                    });

                    // Step 1â†’2ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    tutorial.currentStep = 2;
                    const step2Data = tutorial.tutorialSteps?.find(s => s?.step === 2);
                    simulationResults.push({
                        fromStep: 1,
                        toStep: 2,
                        success: !!step2Data,
                        data: !!step2Data
                    });

                    // Step 2â†’3ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    tutorial.currentStep = 3;
                    const step3Data = tutorial.tutorialSteps?.find(s => s?.step === 3);
                    simulationResults.push({
                        fromStep: 2,
                        toStep: 3,
                        success: !!step3Data,
                        data: !!step3Data
                    });

                } finally {
                    // å…ƒã®çŠ¶æ…‹ã«å¾©æ—§
                    tutorial.currentStep = originalStep;
                }

                addResult('é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯è¨ºæ–­', 'success',
                    'é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°åˆ†æãŒå®Œäº†',
                    `é€²è¡ŒçŠ¶æ³:\n${JSON.stringify(progressionState, null, 2)}\n\né€²è¡Œãƒ†ã‚¹ãƒˆ:\n${JSON.stringify(progressionTests, null, 2)}\n\nã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:\n${JSON.stringify(simulationResults, null, 2)}`
                );

            } catch (error) {
                addResult('é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯è¨ºæ–­', 'error', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function diagnoseDOMEvents() {
            try {
                const continueBtn = document.getElementById('continueBtn');
                const nextBtn = document.getElementById('nextBtn');
                const modalOverlay = document.getElementById('modalOverlay');
                
                const domState = {
                    continueBtn: {
                        exists: !!continueBtn,
                        disabled: continueBtn?.disabled,
                        visible: continueBtn ? window.getComputedStyle(continueBtn).display !== 'none' : false,
                        hasOnClick: !!continueBtn?.onclick,
                        text: continueBtn?.textContent
                    },
                    nextBtn: {
                        exists: !!nextBtn,
                        disabled: nextBtn?.disabled,
                        visible: nextBtn ? window.getComputedStyle(nextBtn).display !== 'none' : false,
                        hasOnClick: !!nextBtn?.onclick,
                        text: nextBtn?.textContent
                    },
                    modalOverlay: {
                        exists: !!modalOverlay,
                        visible: modalOverlay?.style?.display === 'flex'
                    },
                    tutorialReference: {
                        continueBtnRef: window.tutorial?.continueBtn === continueBtn,
                        nextBtnRef: window.tutorial?.nextBtn === nextBtn,
                        modalRef: window.tutorial?.modalOverlay === modalOverlay
                    }
                };

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ãƒ†ã‚¹ãƒˆ
                let eventTestResults = [];
                
                if (continueBtn && window.tutorial) {
                    // ä¸€æ™‚çš„ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã«ã¯ç™ºç«ã•ã›ãªã„ï¼‰
                    eventTestResults.push({
                        element: 'continueBtn',
                        hasEventListener: true, // ã“ã®åˆ¤å®šã¯ç°¡ç•¥åŒ–
                        canTrigger: typeof window.tutorial.nextStep === 'function'
                    });
                }

                addResult('DOMãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨ºæ–­', 'success',
                    'DOMè¦ç´ ã¨ã‚¤ãƒ™ãƒ³ãƒˆçŠ¶æ³ã®ç¢ºèªå®Œäº†',
                    `DOMçŠ¶æ³:\n${JSON.stringify(domState, null, 2)}\n\nã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ:\n${JSON.stringify(eventTestResults, null, 2)}`
                );

            } catch (error) {
                addResult('DOMãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨ºæ–­', 'error', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function testAllStepProgression() {
            console.log('ğŸ§ª å…¨ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            if (!window.tutorial) {
                addResult('å…¨ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }

            const tutorial = window.tutorial;
            const originalStep = tutorial.currentStep;
            const testResults = [];

            // Step 1ã‹ã‚‰é †ç•ªã«ãƒ†ã‚¹ãƒˆ
            let currentTestStep = 1;
            
            const runStepTest = () => {
                if (currentTestStep > 5) {
                    // å…¨ãƒ†ã‚¹ãƒˆå®Œäº†
                    tutorial.currentStep = originalStep;
                    tutorial.updateStepContent();
                    tutorial.updateProgress();
                    
                    addResult('å…¨ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ', 'success',
                        'å…¨5ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†',
                        `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResults, null, 2)}`
                    );
                    return;
                }

                console.log(`Step ${currentTestStep} ãƒ†ã‚¹ãƒˆä¸­...`);
                
                // ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®š
                tutorial.currentStep = currentTestStep;
                
                try {
                    tutorial.updateStepContent();
                    tutorial.resetCode();
                    tutorial.updateProgress();
                    
                    setTimeout(() => {
                        const stepTitle = document.getElementById('stepTitle')?.textContent;
                        const stepBadge = document.getElementById('stepBadge')?.textContent;
                        const hasCode = document.getElementById('codeEditor')?.textContent?.length > 0;
                        
                        testResults.push({
                            step: currentTestStep,
                            success: !!stepTitle && stepBadge?.includes(`Step ${currentTestStep}`),
                            title: stepTitle,
                            badge: stepBadge,
                            hasCode: hasCode,
                            timestamp: new Date().toLocaleTimeString()
                        });

                        currentTestStep++;
                        runStepTest();
                    }, 200);

                } catch (error) {
                    testResults.push({
                        step: currentTestStep,
                        success: false,
                        error: error.message,
                        timestamp: new Date().toLocaleTimeString()
                    });

                    currentTestStep++;
                    runStepTest();
                }
            };

            runStepTest();
        }

        function fixStepProgression() {
            console.log('âš¡ ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œä¿®å¾©é–‹å§‹...');
            
            if (!window.tutorial) {
                addResult('é€²è¡Œä¿®å¾©', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }

            try {
                const tutorial = window.tutorial;
                
                // 1. Step 1ã«å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
                tutorial.currentStep = 1;
                tutorial.updateStepContent();
                tutorial.resetCode();
                tutorial.updateProgress();
                tutorial.clearResults();
                
                // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                if (tutorial.modalOverlay) {
                    tutorial.modalOverlay.style.display = 'none';
                }
                
                // 3. ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (tutorial.nextBtn) {
                    tutorial.nextBtn.disabled = false;
                }
                
                // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                if (tutorial.continueBtn) {
                    tutorial.continueBtn.onclick = (e) => {
                        e.preventDefault();
                        console.log('ğŸ”„ ä¿®å¾©ã•ã‚ŒãŸcontinueBtn ã‚¯ãƒªãƒƒã‚¯!');
                        tutorial.nextStep();
                    };
                }

                setTimeout(() => {
                    const currentTitle = document.getElementById('stepTitle')?.textContent;
                    const currentBadge = document.getElementById('stepBadge')?.textContent;
                    
                    addResult('é€²è¡Œä¿®å¾©', 'success',
                        'ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã®ä¿®å¾©ãŒå®Œäº†ã—ã¾ã—ãŸ',
                        `ä¿®å¾©çµæœ:\ncurrentStep: ${tutorial.currentStep}\nã‚¹ãƒ†ãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ«: ${currentTitle}\nã‚¹ãƒ†ãƒƒãƒ—ãƒãƒƒã‚¸: ${currentBadge}\nãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹: éè¡¨ç¤º\nãƒœã‚¿ãƒ³çŠ¶æ…‹: æœ‰åŠ¹`
                    );
                }, 500);

            } catch (error) {
                addResult('é€²è¡Œä¿®å¾©', 'error', `ä¿®å¾©ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function resetToStep1() {
            console.log('ğŸ”„ Step 1ã¸ã®ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ...');
            
            try {
                if (window.tutorial) {
                    const tutorial = window.tutorial;
                    tutorial.currentStep = 1;
                    tutorial.updateStepContent();
                    tutorial.resetCode();
                    tutorial.updateProgress();
                    tutorial.clearResults();
                    
                    if (tutorial.modalOverlay) {
                        tutorial.modalOverlay.style.display = 'none';
                    }
                    
                    if (tutorial.nextBtn) {
                        tutorial.nextBtn.disabled = false;
                    }
                    
                    addResult('Step 1ãƒªã‚»ãƒƒãƒˆ', 'success', 'Step 1ã¸ã® ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                } else {
                    addResult('Step 1ãƒªã‚»ãƒƒãƒˆ', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } catch (error) {
                addResult('Step 1ãƒªã‚»ãƒƒãƒˆ', 'error', `ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function startContinuousMonitoring() {
            if (monitoringInterval) stopMonitoring();

            monitoringInterval = setInterval(() => {
                if (window.tutorial) {
                    const tutorial = window.tutorial;
                    const now = new Date().toLocaleTimeString();
                    
                    const status = {
                        time: now,
                        currentStep: tutorial.currentStep,
                        stepTitle: document.getElementById('stepTitle')?.textContent?.substring(0, 25),
                        stepBadge: document.getElementById('stepBadge')?.textContent,
                        modalVisible: document.getElementById('modalOverlay')?.style?.display === 'flex',
                        nextBtnDisabled: tutorial.nextBtn?.disabled,
                        continueBtnExists: !!document.getElementById('continueBtn')
                    };

                    progressMonitor.innerHTML = `
                        <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                            â° ${status.time} | ğŸ“ Step ${status.currentStep} | ğŸ·ï¸ ${status.stepBadge}
                            <br>ğŸ“ ${status.stepTitle} | ğŸ­ Modal: ${status.modalVisible ? 'ON' : 'OFF'} | â¡ï¸ Next: ${status.nextBtnDisabled ? 'OFF' : 'ON'}
                        </div>
                    ` + progressMonitor.innerHTML;

                    // æœ€æ–°10ä»¶ã®ã¿ä¿æŒ
                    const entries = progressMonitor.children;
                    while (entries.length > 10) {
                        entries[entries.length - 1].remove();
                    }

                } else {
                    progressMonitor.innerHTML = `
                        <div style="padding: 8px; margin: 5px 0; background: #f8d7da; border-radius: 4px; border-left: 4px solid #dc3545;">
                            âŒ ${new Date().toLocaleTimeString()} | tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“
                        </div>
                    ` + progressMonitor.innerHTML;
                }
            }, 3000);

            addResult('é€£ç¶šç›£è¦–', 'success', 'é€£ç¶šç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ3ç§’é–“éš”ï¼‰');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                addResult('é€£ç¶šç›£è¦–', 'success', 'é€£ç¶šç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸçŠ¶æ…‹ç¢ºèª
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.tutorial) {
                    addResult('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–', 'success',
                        `è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† - ç¾åœ¨Step ${window.tutorial.currentStep}`,
                        `ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°: ${window.tutorial.totalSteps}\nãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${window.tutorial.tutorialSteps ? 'æˆåŠŸ' : 'å¤±æ•—'}`
                    );
                } else {
                    addResult('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–', 'critical', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—');
                }
            }, 2000);
        });
    </script>
</body>
</html>