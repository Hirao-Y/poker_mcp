<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>🔧 JavaScript読み込み失敗 即座修復システム</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #fff0f0; }
        .fix-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; border: 3px solid #e53e3e; }
        .result-panel { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .success { background: #c6f6d5; border: 1px solid #68d391; color: #22543d; }
        .error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .warning { background: #faf089; border: 1px solid #f6e05e; color: #744210; }
        .info { background: #bee3f8; border: 1px solid #90cdf4; color: #2a4365; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-fix { background: #38a169; color: white; }
        .btn-test { background: #3182ce; color: white; }
        .btn-manual { background: #d69e2e; color: white; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; }
    </style>
</head>
<body>
    <h1>🔧 JavaScript読み込み失敗 即座修復システム</h1>
    
    <div class="fix-panel">
        <h2>🚨 JavaScriptクラス読み込み失敗を検出</h2>
        <p><strong>問題:</strong> Tutorial, PhysicsValidator, CrossSectionVisualizerが読み込まれていません</p>
        <p><strong>原因:</strong> 必要なJavaScriptファイルが参照されていない</p>
        
        <button onclick="loadRequiredScripts()" class="btn-fix">📜 必須スクリプト強制読み込み</button>
        <button onclick="createMinimalTutorial()" class="btn-fix">⚡ 最小Tutorial作成</button>
        <button onclick="testScriptLoading()" class="btn-test">🧪 スクリプト読み込みテスト</button>
        <button onclick="manualScriptInjection()" class="btn-manual">💉 手動スクリプト注入</button>
        <button onclick="emergencyDiagnosis()" class="btn-test">🔬 緊急クラス診断</button>
    </div>

    <div id="fixResults"></div>

    <script>
        let resultsDiv = document.getElementById('fixResults');

        function addResult(title, type, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-panel ${type}`;
            resultDiv.innerHTML = `
                <h3>${getIcon(type)} ${title}</h3>
                <p><strong>結果:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
                <small>実行時刻: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return '✅';
                case 'error': return '❌';
                case 'warning': return '⚠️';
                default: return 'ℹ️';
            }
        }

        async function loadRequiredScripts() {
            console.log('📜 必須スクリプト強制読み込み開始...');
            resultsDiv.innerHTML = '';

            const requiredScripts = [
                { file: 'physics-validator.js', className: 'PhysicsValidator' },
                { file: 'cross-section-visualizer.js', className: 'CrossSectionVisualizer' },
                { file: 'tutorial.js', className: 'Tutorial' }
            ];

            const loadResults = [];

            for (const script of requiredScripts) {
                try {
                    console.log(`📥 ${script.file} 読み込み中...`);
                    
                    await loadScript(script.file);
                    
                    // クラス存在確認
                    const classExists = await checkClassExistsWithRetry(script.className, 3, 1000);
                    
                    loadResults.push({
                        file: script.file,
                        className: script.className,
                        loadSuccess: true,
                        classExists: classExists
                    });

                    addResult(`${script.file} 読み込み`, 
                        classExists ? 'success' : 'warning',
                        classExists ? '読み込み・クラス確認成功' : '読み込み成功、クラス確認失敗',
                        `ファイル: ${script.file}\nクラス: ${script.className}\n存在確認: ${classExists}`
                    );

                } catch (error) {
                    loadResults.push({
                        file: script.file,
                        className: script.className,
                        loadSuccess: false,
                        error: error.message
                    });

                    addResult(`${script.file} 読み込み`, 'error',
                        `読み込み失敗: ${error.message}`,
                        `ファイル: ${script.file}\nエラー詳細: ${error.stack || error.message}`
                    );
                }
            }

            // 全体結果確認
            setTimeout(() => {
                checkOverallStatus(loadResults);
            }, 1000);
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 既存のscriptタグをチェック
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    console.log(`⚠️ ${src} は既に読み込み済み`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                
                script.onload = () => {
                    console.log(`✅ ${src} 読み込み成功`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`❌ ${src} 読み込み失敗:`, error);
                    reject(new Error(`Script load failed: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        function checkClassExists(className) {
            try {
                // グローバルスコープでクラス確認（複数の名前をチェック）
                let classRef = window[className];
                
                // Tutorialの場合は代替名もチェック
                if (!classRef && className === 'Tutorial') {
                    classRef = window['PokerMCPTutorial'] || window['Tutorial'];
                }
                
                const exists = typeof classRef === 'function' || typeof classRef === 'object';
                
                if (exists && className === 'Tutorial') {
                    // Tutorialクラスの場合は両方の名前で登録確認
                    if (window.PokerMCPTutorial && !window.Tutorial) {
                        window.Tutorial = window.PokerMCPTutorial;
                        console.log('✅ PokerMCPTutorial → Tutorial エイリアス作成');
                    }
                }
                
                return exists;
            } catch (error) {
                console.error(`クラス確認エラー (${className}):`, error);
                return false;
            }
        }

        // 再試行付きクラス確認
        async function checkClassExistsWithRetry(className, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                console.log(`🔍 ${className} クラス確認試行 ${i + 1}/${maxRetries}...`);
                
                // クラス確認
                const exists = checkClassExists(className);
                
                if (exists) {
                    console.log(`✅ ${className} クラス確認成功（試行 ${i + 1}）`);
                    return true;
                }
                
                // tutorial.jsの場合は準備完了シグナルもチェック
                if (className === 'Tutorial' && window.tutorialClassReady) {
                    console.log('✅ Tutorial準備完了シグナル検出');
                    const recheckExists = checkClassExists(className);
                    if (recheckExists) {
                        return true;
                    }
                }
                
                // 最後の試行でない場合は待機
                if (i < maxRetries - 1) {
                    console.log(`⏳ ${delay}ms 待機後に再試行...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            console.log(`❌ ${className} クラス確認失敗（${maxRetries}回試行）`);
            return false;
        }

        function checkOverallStatus(loadResults) {
            const allLoaded = loadResults.every(r => r.loadSuccess);
            const allClassesExist = loadResults.every(r => r.classExists);

            const statusInfo = {
                totalScripts: loadResults.length,
                successfulLoads: loadResults.filter(r => r.loadSuccess).length,
                existingClasses: loadResults.filter(r => r.classExists).length,
                allScriptsLoaded: allLoaded,
                allClassesAvailable: allClassesExist,
                results: loadResults
            };

            if (allLoaded && allClassesAvailable) {
                addResult('全体ステータス', 'success',
                    '全ての必須スクリプト・クラスが正常に読み込まれました',
                    `ステータス:\n${JSON.stringify(statusInfo, null, 2)}`
                );
                
                // Tutorial初期化を試行
                setTimeout(() => {
                    attemptTutorialInitialization();
                }, 500);
                
            } else {
                addResult('全体ステータス', 'warning',
                    `一部のスクリプト読み込みに問題があります（成功: ${statusInfo.successfulLoads}/${statusInfo.totalScripts}）`,
                    `ステータス:\n${JSON.stringify(statusInfo, null, 2)}`
                );
            }
        }

        function attemptTutorialInitialization() {
            console.log('🚀 Tutorial初期化試行...');
            
            try {
                // Tutorialクラス確認（複数の可能性をチェック）
                let TutorialClass = window.Tutorial || window.PokerMCPTutorial;
                
                if (!TutorialClass) {
                    throw new Error('Tutorial/PokerMCPTutorialクラスが見つかりません');
                }
                
                // 既存tutorialオブジェクトをクリア
                if (window.tutorial) {
                    delete window.tutorial;
                }
                
                console.log(`📝 ${TutorialClass.name} クラスでTutorial作成中...`);
                
                // 新規Tutorial作成
                window.tutorial = new TutorialClass();
                
                // 両方の名前でクラスを登録（保険）
                if (TutorialClass.name === 'PokerMCPTutorial') {
                    window.Tutorial = TutorialClass;
                }
                
                setTimeout(() => {
                    const initResult = {
                        tutorialExists: !!window.tutorial,
                        tutorialClass: TutorialClass.name,
                        tutorialStepsExists: !!window.tutorial?.tutorialSteps,
                        tutorialStepsLength: window.tutorial?.tutorialSteps?.length,
                        currentStep: window.tutorial?.currentStep,
                        totalSteps: window.tutorial?.totalSteps,
                        step1Title: window.tutorial?.tutorialSteps?.[0]?.title
                    };

                    if (window.tutorial && window.tutorial.tutorialSteps) {
                        addResult('Tutorial初期化', 'success',
                            `${TutorialClass.name}による初期化に成功しました`,
                            `初期化結果:\n${JSON.stringify(initResult, null, 2)}`
                        );
                        
                        // 成功を知らせる追加メッセージ
                        addResult('学習準備完了', 'success',
                            'index.htmlでの学習開始準備が完了しました',
                            `Step 1: ${initResult.step1Title}\n全${initResult.totalSteps}ステップの学習が可能です`
                        );
                        
                    } else {
                        addResult('Tutorial初期化', 'warning',
                            'Tutorialオブジェクトは作成されましたが、データ読み込みに課題があります',
                            `初期化結果:\n${JSON.stringify(initResult, null, 2)}`
                        );
                    }
                }, 2000);

            } catch (error) {
                addResult('Tutorial初期化', 'error',
                    `Tutorial初期化に失敗: ${error.message}`,
                    `エラー詳細:\n${error.stack}\n\n利用可能なクラス:\n- Tutorial: ${!!window.Tutorial}\n- PokerMCPTutorial: ${!!window.PokerMCPTutorial}`
                );
                
                // 最小Tutorial作成を試行
                setTimeout(() => {
                    addResult('代替案提示', 'info',
                        '代替案: "⚡ 最小Tutorial作成" ボタンをお試しください',
                        'フォールバック機能により確実に動作するTutorialを作成できます'
                    );
                }, 1000);
            }
        }

        async function createMinimalTutorial() {
            console.log('⚡ 最小Tutorial作成開始...');
            
            try {
                // 最小限のTutorialクラスを作成
                const MinimalTutorial = class {
                    constructor() {
                        this.currentStep = 1;
                        this.totalSteps = 5;
                        this.tutorialSteps = this.getMinimalSteps();
                        console.log('✅ 最小Tutorial作成完了');
                    }

                    getMinimalSteps() {
                        return [
                            {
                                step: 1,
                                title: "基本的なCo-60線源の作成",
                                physics_background: "Co-60は医療用γ線源として広く使用されており、1.17MeVと1.33MeVの特性γ線を放出します。",
                                instructions: "医療用Co-60線源を原点（0,0,0）に配置するJSONリクエストを作成してください。",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeSource",
  "params": {
    "name": "co60_medical",
    "type": "POINT",
    "position": "0 0 0",
    "inventory": [
      {
        "nuclide": "Co60",
        "radioactivity": 37000000000
      }
    ]
  }
}`,
                                achievement: "線源作成マスター",
                                completion_message: "素晴らしいです！Co-60線源の作成が完了しました。",
                                next_step_preview: "次は、この線源を遮蔽するためのコンクリート球殻を作成します。"
                            },
                            {
                                step: 2,
                                title: "コンクリート遮蔽体の作成",
                                physics_background: "コンクリートは放射線遮蔽材として最も一般的な材料です。",
                                instructions: "線源を囲むコンクリート球殻を作成してください。",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "concrete_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 50
  }
}`,
                                achievement: "遮蔽設計エンジニア",
                                completion_message: "優秀です！コンクリート遮蔽体の作成が完了しました。",
                                next_step_preview: "次は、遮蔽効果を測定するための検出器を配置します。"
                            },
                            {
                                step: 3,
                                title: "線量率検出器の配置",
                                physics_background: "線量率は距離の二乗に反比例して減少します。",
                                instructions: "遮蔽体の外側に検出器を配置し、線量率の空間分布を測定します。",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeDetector",
  "params": {
    "name": "dose_survey",
    "origin": "60 0 0",
    "grid": [
      {
        "edge": "10 0 0",
        "number": 10
      }
    ]
  }
}`,
                                achievement: "線量測定スペシャリスト",
                                completion_message: "素晴らしいです！検出器配置が完了しました。",
                                next_step_preview: "次は、より効果的な鉛遮蔽体を追加して複合遮蔽を学習します。"
                            },
                            {
                                step: 4,
                                title: "複合遮蔽の最適化設計",
                                physics_background: "鉛（密度11.3 g/cm³）はγ線遮蔽に極めて効果的です。",
                                instructions: "コンクリート球の内側に薄い鉛層を追加して複合遮蔽を作成します。",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "lead_inner_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 18
  }
}`,
                                achievement: "遮蔽最適化マスター",
                                completion_message: "卓越した成果です！複合遮蔽の設計が完了しました。",
                                next_step_preview: "最後に、全ての変更をYAMLファイルに適用します。"
                            },
                            {
                                step: 5,
                                title: "実用統合とデータ管理",
                                physics_background: "設計した遮蔽システムを実際の計算で使用するには、YAMLファイルに保存する必要があります。",
                                instructions: "これまで作成した全ての要素をYAMLファイルに保存します。",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_applyChanges",
  "params": {
    "backup_comment": "Interactive Tutorial Completion - Co60 shielding design"
  }
}`,
                                achievement: "放射線遮蔽研究マスター",
                                completion_message: "🎉 おめでとうございます！インタラクティブチュートリアルを完全制覇されました。"
                            }
                        ];
                    }

                    updateStepContent() {
                        const step = this.tutorialSteps.find(s => s.step === this.currentStep);
                        if (step) {
                            console.log(`📝 Step ${this.currentStep}: ${step.title}`);
                            return step;
                        }
                        return null;
                    }

                    nextStep() {
                        if (this.currentStep < this.totalSteps) {
                            this.currentStep++;
                            console.log(`➡️ Step ${this.currentStep}に進行`);
                            return this.updateStepContent();
                        }
                        return null;
                    }
                };

                // グローバルに登録
                window.Tutorial = MinimalTutorial;
                window.tutorial = new MinimalTutorial();

                const creationResult = {
                    tutorialClassExists: typeof window.Tutorial === 'function',
                    tutorialObjectExists: !!window.tutorial,
                    tutorialStepsLength: window.tutorial?.tutorialSteps?.length,
                    currentStep: window.tutorial?.currentStep,
                    totalSteps: window.tutorial?.totalSteps,
                    step1Title: window.tutorial?.tutorialSteps?.[0]?.title
                };

                addResult('最小Tutorial作成', 'success',
                    '最小限のTutorialシステムを作成しました',
                    `作成結果:\n${JSON.stringify(creationResult, null, 2)}`
                );

            } catch (error) {
                addResult('最小Tutorial作成', 'error',
                    `最小Tutorial作成失敗: ${error.message}`,
                    `エラー詳細:\n${error.stack}`
                );
            }
        }

        async function testScriptLoading() {
            console.log('🧪 スクリプト読み込みテスト開始...');

            const testFiles = [
                'tutorial.js',
                'physics-validator.js', 
                'cross-section-visualizer.js',
                'steps.json'
            ];

            const testResults = [];

            for (const file of testFiles) {
                try {
                    console.log(`🔍 ${file} テスト中...`);
                    
                    const response = await fetch(file, { method: 'HEAD' });
                    
                    testResults.push({
                        file: file,
                        exists: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                        contentType: response.headers.get('Content-Type'),
                        contentLength: response.headers.get('Content-Length')
                    });

                } catch (error) {
                    testResults.push({
                        file: file,
                        exists: false,
                        error: error.message
                    });
                }
            }

            const allFilesExist = testResults.every(t => t.exists);

            addResult('スクリプト読み込みテスト', 
                allFilesExist ? 'success' : 'warning',
                `ファイル存在確認: ${testResults.filter(t => t.exists).length}/${testResults.length}`,
                `テスト結果:\n${JSON.stringify(testResults, null, 2)}`
            );
        }

        function manualScriptInjection() {
            console.log('💉 手動スクリプト注入開始...');

            try {
                // PhysicsValidator最小実装
                window.PhysicsValidator = class {
                    constructor() {
                        console.log('✅ PhysicsValidator最小実装作成');
                    }
                    validate() { return { valid: true, message: 'OK' }; }
                };

                // CrossSectionVisualizer最小実装
                window.CrossSectionVisualizer = class {
                    constructor(canvasId) {
                        this.canvasId = canvasId;
                        console.log('✅ CrossSectionVisualizer最小実装作成');
                    }
                    clear() { console.log('Visualizer cleared'); }
                    render() { console.log('Visualizer rendered'); }
                };

                // Tutorial最小実装（createMinimalTutorialと同様）
                if (!window.Tutorial) {
                    createMinimalTutorial();
                }

                const injectionResult = {
                    PhysicsValidatorInjected: typeof window.PhysicsValidator === 'function',
                    CrossSectionVisualizerInjected: typeof window.CrossSectionVisualizer === 'function',
                    TutorialInjected: typeof window.Tutorial === 'function',
                    tutorialObjectExists: !!window.tutorial,
                    allClassesAvailable: typeof window.PhysicsValidator === 'function' && 
                                        typeof window.CrossSectionVisualizer === 'function' &&
                                        typeof window.Tutorial === 'function'
                };

                addResult('手動スクリプト注入', 'success',
                    '全ての必須クラスを手動で注入しました',
                    `注入結果:\n${JSON.stringify(injectionResult, null, 2)}`
                );

            } catch (error) {
                addResult('手動スクリプト注入', 'error',
                    `手動注入失敗: ${error.message}`,
                    `エラー詳細:\n${error.stack}`
                );
            }
        }

        function emergencyDiagnosis() {
            console.log('🔬 緊急クラス診断開始...');
            resultsDiv.innerHTML = '';

            const diagnostics = {
                // 基本的なスクリプト情報
                totalScripts: document.scripts.length,
                scriptSources: Array.from(document.scripts).map(s => s.src || 'inline').filter(s => s !== 'inline'),
                
                // グローバルオブジェクトの状態
                windowKeys: Object.keys(window).filter(k => 
                    k.toLowerCase().includes('tutorial') || 
                    k.toLowerCase().includes('physics') || 
                    k.toLowerCase().includes('cross')
                ),
                
                // 具体的なクラス確認
                Tutorial: {
                    exists: typeof window.Tutorial !== 'undefined',
                    type: typeof window.Tutorial,
                    isFunction: typeof window.Tutorial === 'function',
                    constructor: window.Tutorial?.name,
                    prototype: !!window.Tutorial?.prototype
                },
                
                PokerMCPTutorial: {
                    exists: typeof window.PokerMCPTutorial !== 'undefined',
                    type: typeof window.PokerMCPTutorial,
                    isFunction: typeof window.PokerMCPTutorial === 'function',
                    constructor: window.PokerMCPTutorial?.name,
                    prototype: !!window.PokerMCPTutorial?.prototype
                }
            };

            addResult('緊急クラス診断', 'info',
                '完全なクラス状態診断を実行しました',
                `診断結果:\n${JSON.stringify(diagnostics, null, 2)}`
            );

            // 即座修復試行
            if (diagnostics.PokerMCPTutorial.exists && !diagnostics.Tutorial.exists) {
                try {
                    window.Tutorial = window.PokerMCPTutorial;
                    window.tutorialClassReady = true;
                    addResult('自動修復', 'success',
                        'PokerMCPTutorial → Tutorial エイリアス作成成功',
                        'window.Tutorial = window.PokerMCPTutorial が実行されました'
                    );
                } catch (error) {
                    addResult('自動修復', 'error',
                        'エイリアス作成失敗: ' + error.message,
                        error.stack
                    );
                }
            }
        }

        // 初期状態表示
        window.addEventListener('load', () => {
            addResult('システム初期化', 'info',
                'JavaScript読み込み修復システムが起動しました',
                `現在の状態:\n- Tutorial: ${typeof window.Tutorial !== 'undefined'}\n- PhysicsValidator: ${typeof window.PhysicsValidator !== 'undefined'}\n- CrossSectionVisualizer: ${typeof window.CrossSectionVisualizer !== 'undefined'}`
            );
        });
    </script>
</body>
</html>