<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ JavaScriptèª­ã¿è¾¼ã¿å¤±æ•— å³åº§ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #fff0f0; }
        .fix-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; border: 3px solid #e53e3e; }
        .result-panel { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .success { background: #c6f6d5; border: 1px solid #68d391; color: #22543d; }
        .error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .warning { background: #faf089; border: 1px solid #f6e05e; color: #744210; }
        .info { background: #bee3f8; border: 1px solid #90cdf4; color: #2a4365; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-fix { background: #38a169; color: white; }
        .btn-test { background: #3182ce; color: white; }
        .btn-manual { background: #d69e2e; color: white; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ JavaScriptèª­ã¿è¾¼ã¿å¤±æ•— å³åº§ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="fix-panel">
        <h2>ğŸš¨ JavaScriptã‚¯ãƒ©ã‚¹èª­ã¿è¾¼ã¿å¤±æ•—ã‚’æ¤œå‡º</h2>
        <p><strong>å•é¡Œ:</strong> Tutorial, PhysicsValidator, CrossSectionVisualizerãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>
        <p><strong>åŸå› :</strong> å¿…è¦ãªJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒå‚ç…§ã•ã‚Œã¦ã„ãªã„</p>
        
        <button onclick="loadRequiredScripts()" class="btn-fix">ğŸ“œ å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå¼·åˆ¶èª­ã¿è¾¼ã¿</button>
        <button onclick="createMinimalTutorial()" class="btn-fix">âš¡ æœ€å°Tutorialä½œæˆ</button>
        <button onclick="testScriptLoading()" class="btn-test">ğŸ§ª ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="manualScriptInjection()" class="btn-manual">ğŸ’‰ æ‰‹å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥</button>
        <button onclick="emergencyDiagnosis()" class="btn-test">ğŸ”¬ ç·Šæ€¥ã‚¯ãƒ©ã‚¹è¨ºæ–­</button>
    </div>

    <div id="fixResults"></div>

    <script>
        let resultsDiv = document.getElementById('fixResults');

        function addResult(title, type, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-panel ${type}`;
            resultDiv.innerHTML = `
                <h3>${getIcon(type)} ${title}</h3>
                <p><strong>çµæœ:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
                <small>å®Ÿè¡Œæ™‚åˆ»: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return 'âœ…';
                case 'error': return 'âŒ';
                case 'warning': return 'âš ï¸';
                default: return 'â„¹ï¸';
            }
        }

        async function loadRequiredScripts() {
            console.log('ğŸ“œ å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå¼·åˆ¶èª­ã¿è¾¼ã¿é–‹å§‹...');
            resultsDiv.innerHTML = '';

            const requiredScripts = [
                { file: 'physics-validator.js', className: 'PhysicsValidator' },
                { file: 'cross-section-visualizer.js', className: 'CrossSectionVisualizer' },
                { file: 'tutorial.js', className: 'Tutorial' }
            ];

            const loadResults = [];

            for (const script of requiredScripts) {
                try {
                    console.log(`ğŸ“¥ ${script.file} èª­ã¿è¾¼ã¿ä¸­...`);
                    
                    await loadScript(script.file);
                    
                    // ã‚¯ãƒ©ã‚¹å­˜åœ¨ç¢ºèª
                    const classExists = await checkClassExistsWithRetry(script.className, 3, 1000);
                    
                    loadResults.push({
                        file: script.file,
                        className: script.className,
                        loadSuccess: true,
                        classExists: classExists
                    });

                    addResult(`${script.file} èª­ã¿è¾¼ã¿`, 
                        classExists ? 'success' : 'warning',
                        classExists ? 'èª­ã¿è¾¼ã¿ãƒ»ã‚¯ãƒ©ã‚¹ç¢ºèªæˆåŠŸ' : 'èª­ã¿è¾¼ã¿æˆåŠŸã€ã‚¯ãƒ©ã‚¹ç¢ºèªå¤±æ•—',
                        `ãƒ•ã‚¡ã‚¤ãƒ«: ${script.file}\nã‚¯ãƒ©ã‚¹: ${script.className}\nå­˜åœ¨ç¢ºèª: ${classExists}`
                    );

                } catch (error) {
                    loadResults.push({
                        file: script.file,
                        className: script.className,
                        loadSuccess: false,
                        error: error.message
                    });

                    addResult(`${script.file} èª­ã¿è¾¼ã¿`, 'error',
                        `èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`,
                        `ãƒ•ã‚¡ã‚¤ãƒ«: ${script.file}\nã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack || error.message}`
                    );
                }
            }

            // å…¨ä½“çµæœç¢ºèª
            setTimeout(() => {
                checkOverallStatus(loadResults);
            }, 1000);
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // æ—¢å­˜ã®scriptã‚¿ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    console.log(`âš ï¸ ${src} ã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                
                script.onload = () => {
                    console.log(`âœ… ${src} èª­ã¿è¾¼ã¿æˆåŠŸ`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`âŒ ${src} èª­ã¿è¾¼ã¿å¤±æ•—:`, error);
                    reject(new Error(`Script load failed: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        function checkClassExists(className) {
            try {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚¯ãƒ©ã‚¹ç¢ºèªï¼ˆè¤‡æ•°ã®åå‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                let classRef = window[className];
                
                // Tutorialã®å ´åˆã¯ä»£æ›¿åã‚‚ãƒã‚§ãƒƒã‚¯
                if (!classRef && className === 'Tutorial') {
                    classRef = window['PokerMCPTutorial'] || window['Tutorial'];
                }
                
                const exists = typeof classRef === 'function' || typeof classRef === 'object';
                
                if (exists && className === 'Tutorial') {
                    // Tutorialã‚¯ãƒ©ã‚¹ã®å ´åˆã¯ä¸¡æ–¹ã®åå‰ã§ç™»éŒ²ç¢ºèª
                    if (window.PokerMCPTutorial && !window.Tutorial) {
                        window.Tutorial = window.PokerMCPTutorial;
                        console.log('âœ… PokerMCPTutorial â†’ Tutorial ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½œæˆ');
                    }
                }
                
                return exists;
            } catch (error) {
                console.error(`ã‚¯ãƒ©ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼ (${className}):`, error);
                return false;
            }
        }

        // å†è©¦è¡Œä»˜ãã‚¯ãƒ©ã‚¹ç¢ºèª
        async function checkClassExistsWithRetry(className, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                console.log(`ğŸ” ${className} ã‚¯ãƒ©ã‚¹ç¢ºèªè©¦è¡Œ ${i + 1}/${maxRetries}...`);
                
                // ã‚¯ãƒ©ã‚¹ç¢ºèª
                const exists = checkClassExists(className);
                
                if (exists) {
                    console.log(`âœ… ${className} ã‚¯ãƒ©ã‚¹ç¢ºèªæˆåŠŸï¼ˆè©¦è¡Œ ${i + 1}ï¼‰`);
                    return true;
                }
                
                // tutorial.jsã®å ´åˆã¯æº–å‚™å®Œäº†ã‚·ã‚°ãƒŠãƒ«ã‚‚ãƒã‚§ãƒƒã‚¯
                if (className === 'Tutorial' && window.tutorialClassReady) {
                    console.log('âœ… Tutorialæº–å‚™å®Œäº†ã‚·ã‚°ãƒŠãƒ«æ¤œå‡º');
                    const recheckExists = checkClassExists(className);
                    if (recheckExists) {
                        return true;
                    }
                }
                
                // æœ€å¾Œã®è©¦è¡Œã§ãªã„å ´åˆã¯å¾…æ©Ÿ
                if (i < maxRetries - 1) {
                    console.log(`â³ ${delay}ms å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            console.log(`âŒ ${className} ã‚¯ãƒ©ã‚¹ç¢ºèªå¤±æ•—ï¼ˆ${maxRetries}å›è©¦è¡Œï¼‰`);
            return false;
        }

        function checkOverallStatus(loadResults) {
            const allLoaded = loadResults.every(r => r.loadSuccess);
            const allClassesExist = loadResults.every(r => r.classExists);

            const statusInfo = {
                totalScripts: loadResults.length,
                successfulLoads: loadResults.filter(r => r.loadSuccess).length,
                existingClasses: loadResults.filter(r => r.classExists).length,
                allScriptsLoaded: allLoaded,
                allClassesAvailable: allClassesExist,
                results: loadResults
            };

            if (allLoaded && allClassesAvailable) {
                addResult('å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'success',
                    'å…¨ã¦ã®å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»ã‚¯ãƒ©ã‚¹ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ',
                    `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:\n${JSON.stringify(statusInfo, null, 2)}`
                );
                
                // TutorialåˆæœŸåŒ–ã‚’è©¦è¡Œ
                setTimeout(() => {
                    attemptTutorialInitialization();
                }, 500);
                
            } else {
                addResult('å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'warning',
                    `ä¸€éƒ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼ˆæˆåŠŸ: ${statusInfo.successfulLoads}/${statusInfo.totalScripts}ï¼‰`,
                    `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:\n${JSON.stringify(statusInfo, null, 2)}`
                );
            }
        }

        function attemptTutorialInitialization() {
            console.log('ğŸš€ TutorialåˆæœŸåŒ–è©¦è¡Œ...');
            
            try {
                // Tutorialã‚¯ãƒ©ã‚¹ç¢ºèªï¼ˆè¤‡æ•°ã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                let TutorialClass = window.Tutorial || window.PokerMCPTutorial;
                
                if (!TutorialClass) {
                    throw new Error('Tutorial/PokerMCPTutorialã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // æ—¢å­˜tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (window.tutorial) {
                    delete window.tutorial;
                }
                
                console.log(`ğŸ“ ${TutorialClass.name} ã‚¯ãƒ©ã‚¹ã§Tutorialä½œæˆä¸­...`);
                
                // æ–°è¦Tutorialä½œæˆ
                window.tutorial = new TutorialClass();
                
                // ä¸¡æ–¹ã®åå‰ã§ã‚¯ãƒ©ã‚¹ã‚’ç™»éŒ²ï¼ˆä¿é™ºï¼‰
                if (TutorialClass.name === 'PokerMCPTutorial') {
                    window.Tutorial = TutorialClass;
                }
                
                setTimeout(() => {
                    const initResult = {
                        tutorialExists: !!window.tutorial,
                        tutorialClass: TutorialClass.name,
                        tutorialStepsExists: !!window.tutorial?.tutorialSteps,
                        tutorialStepsLength: window.tutorial?.tutorialSteps?.length,
                        currentStep: window.tutorial?.currentStep,
                        totalSteps: window.tutorial?.totalSteps,
                        step1Title: window.tutorial?.tutorialSteps?.[0]?.title
                    };

                    if (window.tutorial && window.tutorial.tutorialSteps) {
                        addResult('TutorialåˆæœŸåŒ–', 'success',
                            `${TutorialClass.name}ã«ã‚ˆã‚‹åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸ`,
                            `åˆæœŸåŒ–çµæœ:\n${JSON.stringify(initResult, null, 2)}`
                        );
                        
                        // æˆåŠŸã‚’çŸ¥ã‚‰ã›ã‚‹è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        addResult('å­¦ç¿’æº–å‚™å®Œäº†', 'success',
                            'index.htmlã§ã®å­¦ç¿’é–‹å§‹æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ',
                            `Step 1: ${initResult.step1Title}\nå…¨${initResult.totalSteps}ã‚¹ãƒ†ãƒƒãƒ—ã®å­¦ç¿’ãŒå¯èƒ½ã§ã™`
                        );
                        
                    } else {
                        addResult('TutorialåˆæœŸåŒ–', 'warning',
                            'Tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«èª²é¡ŒãŒã‚ã‚Šã¾ã™',
                            `åˆæœŸåŒ–çµæœ:\n${JSON.stringify(initResult, null, 2)}`
                        );
                    }
                }, 2000);

            } catch (error) {
                addResult('TutorialåˆæœŸåŒ–', 'error',
                    `TutorialåˆæœŸåŒ–ã«å¤±æ•—: ${error.message}`,
                    `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.stack}\n\nåˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ©ã‚¹:\n- Tutorial: ${!!window.Tutorial}\n- PokerMCPTutorial: ${!!window.PokerMCPTutorial}`
                );
                
                // æœ€å°Tutorialä½œæˆã‚’è©¦è¡Œ
                setTimeout(() => {
                    addResult('ä»£æ›¿æ¡ˆæç¤º', 'info',
                        'ä»£æ›¿æ¡ˆ: "âš¡ æœ€å°Tutorialä½œæˆ" ãƒœã‚¿ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„',
                        'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚Šç¢ºå®Ÿã«å‹•ä½œã™ã‚‹Tutorialã‚’ä½œæˆã§ãã¾ã™'
                    );
                }, 1000);
            }
        }

        async function createMinimalTutorial() {
            console.log('âš¡ æœ€å°Tutorialä½œæˆé–‹å§‹...');
            
            try {
                // æœ€å°é™ã®Tutorialã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ
                const MinimalTutorial = class {
                    constructor() {
                        this.currentStep = 1;
                        this.totalSteps = 5;
                        this.tutorialSteps = this.getMinimalSteps();
                        console.log('âœ… æœ€å°Tutorialä½œæˆå®Œäº†');
                    }

                    getMinimalSteps() {
                        return [
                            {
                                step: 1,
                                title: "åŸºæœ¬çš„ãªCo-60ç·šæºã®ä½œæˆ",
                                physics_background: "Co-60ã¯åŒ»ç™‚ç”¨Î³ç·šæºã¨ã—ã¦åºƒãä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€1.17MeVã¨1.33MeVã®ç‰¹æ€§Î³ç·šã‚’æ”¾å‡ºã—ã¾ã™ã€‚",
                                instructions: "åŒ»ç™‚ç”¨Co-60ç·šæºã‚’åŸç‚¹ï¼ˆ0,0,0ï¼‰ã«é…ç½®ã™ã‚‹JSONãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeSource",
  "params": {
    "name": "co60_medical",
    "type": "POINT",
    "position": "0 0 0",
    "inventory": [
      {
        "nuclide": "Co60",
        "radioactivity": 37000000000
      }
    ]
  }
}`,
                                achievement: "ç·šæºä½œæˆãƒã‚¹ã‚¿ãƒ¼",
                                completion_message: "ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼Co-60ç·šæºã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚",
                                next_step_preview: "æ¬¡ã¯ã€ã“ã®ç·šæºã‚’é®è”½ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆçƒæ®»ã‚’ä½œæˆã—ã¾ã™ã€‚"
                            },
                            {
                                step: 2,
                                title: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé®è”½ä½“ã®ä½œæˆ",
                                physics_background: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¯æ”¾å°„ç·šé®è”½æã¨ã—ã¦æœ€ã‚‚ä¸€èˆ¬çš„ãªææ–™ã§ã™ã€‚",
                                instructions: "ç·šæºã‚’å›²ã‚€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆçƒæ®»ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "concrete_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 50
  }
}`,
                                achievement: "é®è”½è¨­è¨ˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢",
                                completion_message: "å„ªç§€ã§ã™ï¼ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé®è”½ä½“ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚",
                                next_step_preview: "æ¬¡ã¯ã€é®è”½åŠ¹æœã‚’æ¸¬å®šã™ã‚‹ãŸã‚ã®æ¤œå‡ºå™¨ã‚’é…ç½®ã—ã¾ã™ã€‚"
                            },
                            {
                                step: 3,
                                title: "ç·šé‡ç‡æ¤œå‡ºå™¨ã®é…ç½®",
                                physics_background: "ç·šé‡ç‡ã¯è·é›¢ã®äºŒä¹—ã«åæ¯”ä¾‹ã—ã¦æ¸›å°‘ã—ã¾ã™ã€‚",
                                instructions: "é®è”½ä½“ã®å¤–å´ã«æ¤œå‡ºå™¨ã‚’é…ç½®ã—ã€ç·šé‡ç‡ã®ç©ºé–“åˆ†å¸ƒã‚’æ¸¬å®šã—ã¾ã™ã€‚",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeDetector",
  "params": {
    "name": "dose_survey",
    "origin": "60 0 0",
    "grid": [
      {
        "edge": "10 0 0",
        "number": 10
      }
    ]
  }
}`,
                                achievement: "ç·šé‡æ¸¬å®šã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ",
                                completion_message: "ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼æ¤œå‡ºå™¨é…ç½®ãŒå®Œäº†ã—ã¾ã—ãŸã€‚",
                                next_step_preview: "æ¬¡ã¯ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªé‰›é®è”½ä½“ã‚’è¿½åŠ ã—ã¦è¤‡åˆé®è”½ã‚’å­¦ç¿’ã—ã¾ã™ã€‚"
                            },
                            {
                                step: 4,
                                title: "è¤‡åˆé®è”½ã®æœ€é©åŒ–è¨­è¨ˆ",
                                physics_background: "é‰›ï¼ˆå¯†åº¦11.3 g/cmÂ³ï¼‰ã¯Î³ç·šé®è”½ã«æ¥µã‚ã¦åŠ¹æœçš„ã§ã™ã€‚",
                                instructions: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆçƒã®å†…å´ã«è–„ã„é‰›å±¤ã‚’è¿½åŠ ã—ã¦è¤‡åˆé®è”½ã‚’ä½œæˆã—ã¾ã™ã€‚",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "lead_inner_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 18
  }
}`,
                                achievement: "é®è”½æœ€é©åŒ–ãƒã‚¹ã‚¿ãƒ¼",
                                completion_message: "å“è¶Šã—ãŸæˆæœã§ã™ï¼è¤‡åˆé®è”½ã®è¨­è¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚",
                                next_step_preview: "æœ€å¾Œã«ã€å…¨ã¦ã®å¤‰æ›´ã‚’YAMLãƒ•ã‚¡ã‚¤ãƒ«ã«é©ç”¨ã—ã¾ã™ã€‚"
                            },
                            {
                                step: 5,
                                title: "å®Ÿç”¨çµ±åˆã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†",
                                physics_background: "è¨­è¨ˆã—ãŸé®è”½ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿéš›ã®è¨ˆç®—ã§ä½¿ç”¨ã™ã‚‹ã«ã¯ã€YAMLãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
                                instructions: "ã“ã‚Œã¾ã§ä½œæˆã—ãŸå…¨ã¦ã®è¦ç´ ã‚’YAMLãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚",
                                template: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_applyChanges",
  "params": {
    "backup_comment": "Interactive Tutorial Completion - Co60 shielding design"
  }
}`,
                                achievement: "æ”¾å°„ç·šé®è”½ç ”ç©¶ãƒã‚¹ã‚¿ãƒ¼",
                                completion_message: "ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å®Œå…¨åˆ¶è¦‡ã•ã‚Œã¾ã—ãŸã€‚"
                            }
                        ];
                    }

                    updateStepContent() {
                        const step = this.tutorialSteps.find(s => s.step === this.currentStep);
                        if (step) {
                            console.log(`ğŸ“ Step ${this.currentStep}: ${step.title}`);
                            return step;
                        }
                        return null;
                    }

                    nextStep() {
                        if (this.currentStep < this.totalSteps) {
                            this.currentStep++;
                            console.log(`â¡ï¸ Step ${this.currentStep}ã«é€²è¡Œ`);
                            return this.updateStepContent();
                        }
                        return null;
                    }
                };

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç™»éŒ²
                window.Tutorial = MinimalTutorial;
                window.tutorial = new MinimalTutorial();

                const creationResult = {
                    tutorialClassExists: typeof window.Tutorial === 'function',
                    tutorialObjectExists: !!window.tutorial,
                    tutorialStepsLength: window.tutorial?.tutorialSteps?.length,
                    currentStep: window.tutorial?.currentStep,
                    totalSteps: window.tutorial?.totalSteps,
                    step1Title: window.tutorial?.tutorialSteps?.[0]?.title
                };

                addResult('æœ€å°Tutorialä½œæˆ', 'success',
                    'æœ€å°é™ã®Tutorialã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ',
                    `ä½œæˆçµæœ:\n${JSON.stringify(creationResult, null, 2)}`
                );

            } catch (error) {
                addResult('æœ€å°Tutorialä½œæˆ', 'error',
                    `æœ€å°Tutorialä½œæˆå¤±æ•—: ${error.message}`,
                    `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.stack}`
                );
            }
        }

        async function testScriptLoading() {
            console.log('ğŸ§ª ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');

            const testFiles = [
                'tutorial.js',
                'physics-validator.js', 
                'cross-section-visualizer.js',
                'steps.json'
            ];

            const testResults = [];

            for (const file of testFiles) {
                try {
                    console.log(`ğŸ” ${file} ãƒ†ã‚¹ãƒˆä¸­...`);
                    
                    const response = await fetch(file, { method: 'HEAD' });
                    
                    testResults.push({
                        file: file,
                        exists: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                        contentType: response.headers.get('Content-Type'),
                        contentLength: response.headers.get('Content-Length')
                    });

                } catch (error) {
                    testResults.push({
                        file: file,
                        exists: false,
                        error: error.message
                    });
                }
            }

            const allFilesExist = testResults.every(t => t.exists);

            addResult('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ', 
                allFilesExist ? 'success' : 'warning',
                `ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª: ${testResults.filter(t => t.exists).length}/${testResults.length}`,
                `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResults, null, 2)}`
            );
        }

        function manualScriptInjection() {
            console.log('ğŸ’‰ æ‰‹å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥é–‹å§‹...');

            try {
                // PhysicsValidatoræœ€å°å®Ÿè£…
                window.PhysicsValidator = class {
                    constructor() {
                        console.log('âœ… PhysicsValidatoræœ€å°å®Ÿè£…ä½œæˆ');
                    }
                    validate() { return { valid: true, message: 'OK' }; }
                };

                // CrossSectionVisualizeræœ€å°å®Ÿè£…
                window.CrossSectionVisualizer = class {
                    constructor(canvasId) {
                        this.canvasId = canvasId;
                        console.log('âœ… CrossSectionVisualizeræœ€å°å®Ÿè£…ä½œæˆ');
                    }
                    clear() { console.log('Visualizer cleared'); }
                    render() { console.log('Visualizer rendered'); }
                };

                // Tutorialæœ€å°å®Ÿè£…ï¼ˆcreateMinimalTutorialã¨åŒæ§˜ï¼‰
                if (!window.Tutorial) {
                    createMinimalTutorial();
                }

                const injectionResult = {
                    PhysicsValidatorInjected: typeof window.PhysicsValidator === 'function',
                    CrossSectionVisualizerInjected: typeof window.CrossSectionVisualizer === 'function',
                    TutorialInjected: typeof window.Tutorial === 'function',
                    tutorialObjectExists: !!window.tutorial,
                    allClassesAvailable: typeof window.PhysicsValidator === 'function' && 
                                        typeof window.CrossSectionVisualizer === 'function' &&
                                        typeof window.Tutorial === 'function'
                };

                addResult('æ‰‹å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥', 'success',
                    'å…¨ã¦ã®å¿…é ˆã‚¯ãƒ©ã‚¹ã‚’æ‰‹å‹•ã§æ³¨å…¥ã—ã¾ã—ãŸ',
                    `æ³¨å…¥çµæœ:\n${JSON.stringify(injectionResult, null, 2)}`
                );

            } catch (error) {
                addResult('æ‰‹å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥', 'error',
                    `æ‰‹å‹•æ³¨å…¥å¤±æ•—: ${error.message}`,
                    `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.stack}`
                );
            }
        }

        function emergencyDiagnosis() {
            console.log('ğŸ”¬ ç·Šæ€¥ã‚¯ãƒ©ã‚¹è¨ºæ–­é–‹å§‹...');
            resultsDiv.innerHTML = '';

            const diagnostics = {
                // åŸºæœ¬çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆæƒ…å ±
                totalScripts: document.scripts.length,
                scriptSources: Array.from(document.scripts).map(s => s.src || 'inline').filter(s => s !== 'inline'),
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹
                windowKeys: Object.keys(window).filter(k => 
                    k.toLowerCase().includes('tutorial') || 
                    k.toLowerCase().includes('physics') || 
                    k.toLowerCase().includes('cross')
                ),
                
                // å…·ä½“çš„ãªã‚¯ãƒ©ã‚¹ç¢ºèª
                Tutorial: {
                    exists: typeof window.Tutorial !== 'undefined',
                    type: typeof window.Tutorial,
                    isFunction: typeof window.Tutorial === 'function',
                    constructor: window.Tutorial?.name,
                    prototype: !!window.Tutorial?.prototype
                },
                
                PokerMCPTutorial: {
                    exists: typeof window.PokerMCPTutorial !== 'undefined',
                    type: typeof window.PokerMCPTutorial,
                    isFunction: typeof window.PokerMCPTutorial === 'function',
                    constructor: window.PokerMCPTutorial?.name,
                    prototype: !!window.PokerMCPTutorial?.prototype
                }
            };

            addResult('ç·Šæ€¥ã‚¯ãƒ©ã‚¹è¨ºæ–­', 'info',
                'å®Œå…¨ãªã‚¯ãƒ©ã‚¹çŠ¶æ…‹è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ',
                `è¨ºæ–­çµæœ:\n${JSON.stringify(diagnostics, null, 2)}`
            );

            // å³åº§ä¿®å¾©è©¦è¡Œ
            if (diagnostics.PokerMCPTutorial.exists && !diagnostics.Tutorial.exists) {
                try {
                    window.Tutorial = window.PokerMCPTutorial;
                    window.tutorialClassReady = true;
                    addResult('è‡ªå‹•ä¿®å¾©', 'success',
                        'PokerMCPTutorial â†’ Tutorial ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½œæˆæˆåŠŸ',
                        'window.Tutorial = window.PokerMCPTutorial ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ'
                    );
                } catch (error) {
                    addResult('è‡ªå‹•ä¿®å¾©', 'error',
                        'ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½œæˆå¤±æ•—: ' + error.message,
                        error.stack
                    );
                }
            }
        }

        // åˆæœŸçŠ¶æ…‹è¡¨ç¤º
        window.addEventListener('load', () => {
            addResult('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–', 'info',
                'JavaScriptèª­ã¿è¾¼ã¿ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸ',
                `ç¾åœ¨ã®çŠ¶æ…‹:\n- Tutorial: ${typeof window.Tutorial !== 'undefined'}\n- PhysicsValidator: ${typeof window.PhysicsValidator !== 'undefined'}\n- CrossSectionVisualizer: ${typeof window.CrossSectionVisualizer !== 'undefined'}`
            );
        });
    </script>
</body>
</html>