<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³å‹•ä½œè¨ºæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .diagnostic-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³å‹•ä½œè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="diagnostic-panel info">
        <h2>ğŸ“‹ è¨ºæ–­ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <button onclick="diagnoseElements()" class="btn-primary">ğŸ” DOMè¦ç´ è¨ºæ–­</button>
        <button onclick="diagnoseEventListeners()" class="btn-primary">ğŸ‘‚ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨ºæ–­</button>
        <button onclick="testModalFlow()" class="btn-primary">ğŸ­ ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ</button>
        <button onclick="simulateStep3Completion()" class="btn-danger">âš¡ Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
    </div>

    <div id="diagnosticResults"></div>
    
    <div class="diagnostic-panel">
        <h3>ğŸ§ª ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹ç›£è¦–</h3>
        <div id="realTimeStatus"></div>
        <button onclick="startMonitoring()" class="btn-primary">ğŸ“Š ç›£è¦–é–‹å§‹</button>
        <button onclick="stopMonitoring()" class="btn-danger">â¹ï¸ ç›£è¦–åœæ­¢</button>
    </div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>

    <script>
        let resultsDiv = document.getElementById('diagnosticResults');
        let monitoringInterval = null;

        function addResult(title, status, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `diagnostic-panel ${status}`;
            resultDiv.innerHTML = `
                <h3>${getStatusIcon(status)} ${title}</h3>
                <p><strong>çµæœ:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'success': return 'âœ…';
                case 'error': return 'âŒ';
                case 'warning': return 'âš ï¸';
                case 'info': return 'â„¹ï¸';
                default: return '?';
            }
        }

        function diagnoseElements() {
            resultsDiv.innerHTML = '';
            console.log('ğŸ” DOMè¦ç´ è¨ºæ–­é–‹å§‹...');

            try {
                // åŸºæœ¬è¦ç´ ã®å­˜åœ¨ç¢ºèª
                const elements = {
                    continueBtn: document.getElementById('continueBtn'),
                    modalOverlay: document.getElementById('modalOverlay'),
                    nextBtn: document.getElementById('nextBtn'),
                    tutorial: window.tutorial
                };

                const elementStatus = {};
                for (const [name, element] of Object.entries(elements)) {
                    elementStatus[name] = !!element;
                }

                if (!elementStatus.continueBtn) {
                    addResult('DOMè¦ç´ è¨ºæ–­', 'error', 'continueBtnè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                if (!elementStatus.tutorial) {
                    addResult('DOMè¦ç´ è¨ºæ–­', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã®è©³ç´°æƒ…å ±
                const continueBtn = elements.continueBtn;
                const btnDetails = {
                    id: continueBtn.id,
                    className: continueBtn.className,
                    textContent: continueBtn.textContent,
                    disabled: continueBtn.disabled,
                    style_display: continueBtn.style.display,
                    parent: continueBtn.parentElement?.className || 'unknown',
                    eventListeners: getEventListeners(continueBtn)
                };

                addResult('DOMè¦ç´ è¨ºæ–­', 'success', 
                    'åŸºæœ¬è¦ç´ ã¯æ­£å¸¸ã«å­˜åœ¨ã—ã¾ã™',
                    `ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³è©³ç´°:\n${JSON.stringify(btnDetails, null, 2)}`
                );

            } catch (error) {
                addResult('DOMè¦ç´ è¨ºæ–­', 'error', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function getEventListeners(element) {
            // ç°¡æ˜“çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æƒ…å ±å–å¾—
            return {
                onclick: typeof element.onclick,
                hasClickListener: !!element.onclick
            };
        }

        function diagnoseEventListeners() {
            try {
                if (!window.tutorial) {
                    addResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨ºæ–­', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                
                // ãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                const methods = {
                    nextStep: typeof tutorial.nextStep,
                    showCompletionModal: typeof tutorial.showCompletionModal,
                    hideCompletionModal: typeof tutorial.hideCompletionModal,
                    updateStepContent: typeof tutorial.updateStepContent
                };

                const continueBtn = document.getElementById('continueBtn');
                if (!continueBtn) {
                    addResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨ºæ–­', 'error', 'continueBtnè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ãƒ†ã‚¹ãƒˆ
                const listenerTest = {
                    hasOnClickAttribute: !!continueBtn.onclick,
                    onClickContent: continueBtn.onclick ? continueBtn.onclick.toString() : 'none'
                };

                addResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨ºæ–­', 'success',
                    'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã—ãŸ',
                    `ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª:\n${JSON.stringify(methods, null, 2)}\n\nã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ:\n${JSON.stringify(listenerTest, null, 2)}`
                );

            } catch (error) {
                addResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨ºæ–­', 'error', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function testModalFlow() {
            try {
                if (!window.tutorial) {
                    addResult('ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                
                console.log('ğŸ­ ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                // Step 3ã«è¨­å®š
                tutorial.currentStep = 3;
                tutorial.updateProgress();
                
                // å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
                tutorial.showCompletionModal();
                
                setTimeout(() => {
                    const modalOverlay = document.getElementById('modalOverlay');
                    const isModalVisible = modalOverlay && 
                        (modalOverlay.style.display === 'flex' || 
                         window.getComputedStyle(modalOverlay).display === 'flex');
                    
                    if (isModalVisible) {
                        addResult('ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ', 'success', 
                            'ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ',
                            `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${tutorial.currentStep}\nãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º: ${isModalVisible}`
                        );
                    } else {
                        addResult('ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ', 'error', 'ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                    }
                }, 500);

            } catch (error) {
                addResult('ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ', 'error', `ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function simulateStep3Completion() {
            try {
                if (!window.tutorial) {
                    addResult('Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                
                console.log('âš¡ Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...');
                
                // Step 3ã«å¼·åˆ¶è¨­å®š
                const originalStep = tutorial.currentStep;
                tutorial.currentStep = 3;
                tutorial.updateStepContent();
                tutorial.updateProgress();
                
                // æˆåŠŸçŠ¶æ…‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                tutorial.nextBtn.disabled = false;
                
                // å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                tutorial.showCompletionModal();
                
                // 2ç§’å¾Œã«ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                setTimeout(() => {
                    console.log('ğŸ”„ ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³...');
                    
                    // nextStep()ã‚’ç›´æ¥å‘¼ã³å‡ºã—
                    const oldStep = tutorial.currentStep;
                    tutorial.nextStep();
                    
                    setTimeout(() => {
                        const newStep = tutorial.currentStep;
                        const stepChanged = newStep !== oldStep;
                        const isStep4 = newStep === 4;
                        
                        if (stepChanged && isStep4) {
                            addResult('Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'success',
                                'Step 3â†’4ã¸ã®é€²è¡ŒãŒæˆåŠŸã—ã¾ã—ãŸï¼',
                                `å¤‰æ›´å‰: Step ${oldStep}\nå¤‰æ›´å¾Œ: Step ${newStep}\nStep 4åˆ°é”: ${isStep4}`
                            );
                        } else {
                            addResult('Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'error',
                                'Step 4ã¸ã®é€²è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ',
                                `å¤‰æ›´å‰: Step ${oldStep}\nå¤‰æ›´å¾Œ: Step ${newStep}\nStepå¤‰æ›´: ${stepChanged}`
                            );
                        }
                    }, 100);
                    
                }, 2000);
                
            } catch (error) {
                addResult('Step 3å®Œäº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'error', `ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }

        function startMonitoring() {
            if (monitoringInterval) {
                stopMonitoring();
            }

            const statusDiv = document.getElementById('realTimeStatus');
            monitoringInterval = setInterval(() => {
                try {
                    if (window.tutorial) {
                        const tutorial = window.tutorial;
                        const modalOverlay = document.getElementById('modalOverlay');
                        const continueBtn = document.getElementById('continueBtn');
                        
                        const status = {
                            currentStep: tutorial.currentStep,
                            totalSteps: tutorial.totalSteps,
                            modalVisible: modalOverlay ? modalOverlay.style.display === 'flex' : false,
                            continueBtnExists: !!continueBtn,
                            continueBtnDisabled: continueBtn ? continueBtn.disabled : 'N/A',
                            nextBtnDisabled: tutorial.nextBtn ? tutorial.nextBtn.disabled : 'N/A'
                        };
                        
                        statusDiv.innerHTML = `
                            <div style="font-family: monospace; font-size: 12px;">
                                <div>â° ç›£è¦–ä¸­ - ${new Date().toLocaleTimeString()}</div>
                                <div>ğŸ“ ç¾åœ¨ã‚¹ãƒ†ãƒƒãƒ—: ${status.currentStep} / ${status.totalSteps}</div>
                                <div>ğŸ­ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º: ${status.modalVisible ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º'}</div>
                                <div>ğŸ”˜ ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³: ${status.continueBtnExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'} (ç„¡åŠ¹: ${status.continueBtnDisabled})</div>
                                <div>â¡ï¸ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒœã‚¿ãƒ³: ç„¡åŠ¹ ${status.nextBtnDisabled}</div>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = '<div style="color: red;">âŒ tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</div>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<div style="color: red;">âŒ ç›£è¦–ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
            }, 1000);

            addResult('ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ', 'info', 'ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                document.getElementById('realTimeStatus').innerHTML = 'ç›£è¦–åœæ­¢ä¸­';
                addResult('ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ', 'info', 'ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸè¨ºæ–­
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.tutorial) {
                    addResult('åˆæœŸçŠ¶æ…‹', 'success', 
                        'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™',
                        `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorial.currentStep}`
                    );
                } else {
                    addResult('åˆæœŸçŠ¶æ…‹', 'error', 'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™');
                }
            }, 1500);
        });
    </script>
</body>
</html>