<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>🔍 Step 3→4 進行問題 詳細診断</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 1000px; margin: 0 auto; }
        .test-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .step-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .json-display { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔍 Step 3→4 進行問題 詳細診断</h1>
        
        <div class="test-panel info">
            <h2>📋 診断項目</h2>
            <button onclick="runFullDiagnosis()" class="btn-primary">🚀 完全診断実行</button>
            <button onclick="testStep3Completion()" class="btn-success">✅ Step 3 完了テスト</button>
            <button onclick="testStep4Access()" class="btn-warning">🔄 Step 4 アクセステスト</button>
            <button onclick="testProgressionLogic()" class="btn-danger">⚡ 進行ロジックテスト</button>
        </div>

        <div id="diagnosticResults"></div>
        
        <div class="test-panel">
            <h3>🎮 シミュレーション実行</h3>
            <p>実際のStep進行をシミュレートしてテストします</p>
            <button onclick="simulateStep3to4()" class="btn-success">🔄 Step 3→4 シミュレーション</button>
            <div id="simulationResults"></div>
        </div>
    </div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>
    
    <script>
        let diagResults = document.getElementById('diagnosticResults');
        let simResults = document.getElementById('simulationResults');

        function addResult(title, success, message, details = '', targetDiv = diagResults) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-panel ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h3>${success ? '✅' : '❌'} ${title}</h3>
                <p><strong>結果:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            targetDiv.appendChild(resultDiv);
        }

        async function runFullDiagnosis() {
            diagResults.innerHTML = '';
            console.log('🚀 完全診断開始...');
            
            // 1. steps.jsonの読み込みテスト
            await testStepsJsonLoad();
            
            // 2. チュートリアルクラスの状態テスト
            testTutorialState();
            
            // 3. Step 4データの存在確認
            testStep4Data();
            
            // 4. 進行ロジックのテスト
            testProgressionLogic();
            
            console.log('✅ 完全診断完了');
        }

        async function testStepsJsonLoad() {
            try {
                const response = await fetch('steps.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length !== 5) {
                    throw new Error(`ステップ数が異常: ${data.length} (期待値: 5)`);
                }
                
                // Step 3と4の詳細確認
                const step3 = data.find(s => s.step === 3);
                const step4 = data.find(s => s.step === 4);
                
                if (!step3) throw new Error('Step 3が見つかりません');
                if (!step4) throw new Error('Step 4が見つかりません');
                
                addResult('steps.json読み込み', true, 
                    `正常に5ステップ読み込み`, 
                    `Step 3: ${step3.title}\nStep 4: ${step4.title}\n\nStep 4 template: ${step4.template ? '存在' : '不存在'}`
                );
                
            } catch (error) {
                addResult('steps.json読み込み', false, error.message);
            }
        }

        function testTutorialState() {
            try {
                if (!window.tutorial) {
                    throw new Error('window.tutorialが初期化されていません');
                }
                
                const tutorial = window.tutorial;
                const state = {
                    currentStep: tutorial.currentStep,
                    totalSteps: tutorial.totalSteps,
                    stepsLoaded: tutorial.tutorialSteps?.length || 0,
                    executionHistory: tutorial.stepExecutionHistory?.length || 0
                };
                
                if (state.totalSteps !== 5) {
                    throw new Error(`totalStepsが異常: ${state.totalSteps} (期待値: 5)`);
                }
                
                if (state.stepsLoaded !== 5) {
                    throw new Error(`読み込まれたステップ数が異常: ${state.stepsLoaded} (期待値: 5)`);
                }
                
                addResult('チュートリアル状態', true, 
                    'チュートリアルは正常に初期化されています',
                    `現在のステップ: ${state.currentStep}\n合計ステップ: ${state.totalSteps}\n読み込まれたステップ: ${state.stepsLoaded}\n実行履歴: ${state.executionHistory}`
                );
                
            } catch (error) {
                addResult('チュートリアル状態', false, error.message);
            }
        }

        function testStep4Data() {
            try {
                if (!window.tutorial || !window.tutorial.tutorialSteps) {
                    throw new Error('チュートリアルデータが利用できません');
                }
                
                const step4 = window.tutorial.tutorialSteps.find(s => s.step === 4);
                if (!step4) {
                    throw new Error('Step 4データが見つかりません');
                }
                
                // Step 4の必須フィールド確認
                const requiredFields = ['step', 'title', 'physics_background', 'instructions', 'template'];
                const missingFields = requiredFields.filter(field => !step4[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`Step 4に必須フィールドが不足: ${missingFields.join(', ')}`);
                }
                
                // テンプレートのJSON妥当性確認
                try {
                    JSON.parse(step4.template);
                } catch (e) {
                    throw new Error(`Step 4のtemplateが無効なJSON: ${e.message}`);
                }
                
                addResult('Step 4データ確認', true, 
                    'Step 4データは完全に存在します',
                    `タイトル: ${step4.title}\nメソッド: ${JSON.parse(step4.template).method}\nテンプレート長: ${step4.template.length}文字`
                );
                
            } catch (error) {
                addResult('Step 4データ確認', false, error.message);
            }
        }

        function testProgressionLogic() {
            try {
                if (!window.tutorial) {
                    throw new Error('チュートリアルが利用できません');
                }
                
                const tutorial = window.tutorial;
                
                // nextStepメソッドの存在確認
                if (typeof tutorial.nextStep !== 'function') {
                    throw new Error('nextStepメソッドが存在しません');
                }
                
                // showCompletionModalメソッドの存在確認
                if (typeof tutorial.showCompletionModal !== 'function') {
                    throw new Error('showCompletionModalメソッドが存在しません');
                }
                
                // updateStepContentメソッドの存在確認
                if (typeof tutorial.updateStepContent !== 'function') {
                    throw new Error('updateStepContentメソッドが存在しません');
                }
                
                addResult('進行ロジック確認', true, 
                    '全ての進行関連メソッドが存在します',
                    'nextStep, showCompletionModal, updateStepContent メソッドが正常に定義されています'
                );
                
            } catch (error) {
                addResult('進行ロジック確認', false, error.message);
            }
        }

        function testStep3Completion() {
            try {
                if (!window.tutorial) {
                    throw new Error('チュートリアルが利用できません');
                }
                
                // Step 3に強制移動
                window.tutorial.currentStep = 3;
                window.tutorial.updateStepContent();
                window.tutorial.updateProgress();
                
                // Step 3のテンプレートが正しく設定されるかテスト
                const step3 = window.tutorial.tutorialSteps.find(s => s.step === 3);
                if (!step3) {
                    throw new Error('Step 3データが見つかりません');
                }
                
                // Step 3完了状態のシミュレーション
                window.tutorial.nextBtn.disabled = false; // 成功状態をシミュレート
                
                addResult('Step 3完了テスト', true, 
                    'Step 3への移動と完了準備が正常です',
                    `Step 3タイトル: ${step3.title}\n次のステップボタン: ${window.tutorial.nextBtn.disabled ? '無効' : '有効'}`
                );
                
            } catch (error) {
                addResult('Step 3完了テスト', false, error.message);
            }
        }

        function testStep4Access() {
            try {
                if (!window.tutorial) {
                    throw new Error('チュートリアルが利用できません');
                }
                
                // Step 4に直接移動をテスト
                const originalStep = window.tutorial.currentStep;
                
                window.tutorial.currentStep = 4;
                window.tutorial.updateStepContent();
                window.tutorial.resetCode();
                window.tutorial.updateProgress();
                
                // Step 4のコンテンツが正しく表示されるかチェック
                const stepTitle = document.getElementById('stepTitle')?.textContent;
                if (!stepTitle || !stepTitle.includes('複合遮蔽')) {
                    throw new Error(`Step 4のタイトルが正しく表示されません: ${stepTitle}`);
                }
                
                // Step 4のテンプレートが正しく設定されるかチェック
                const codeEditor = document.getElementById('codeEditor');
                if (!codeEditor || !codeEditor.textContent.includes('lead_inner_shield')) {
                    throw new Error('Step 4のテンプレートが正しく設定されません');
                }
                
                // 元のステップに戻す
                window.tutorial.currentStep = originalStep;
                window.tutorial.updateStepContent();
                window.tutorial.resetCode();
                window.tutorial.updateProgress();
                
                addResult('Step 4アクセステスト', true, 
                    'Step 4への直接移動は正常に動作します',
                    `Step 4タイトル表示: OK\nStep 4テンプレート設定: OK`
                );
                
            } catch (error) {
                addResult('Step 4アクセステスト', false, error.message);
            }
        }

        async function simulateStep3to4() {
            simResults.innerHTML = '';
            
            try {
                if (!window.tutorial) {
                    throw new Error('チュートリアルが利用できません');
                }
                
                const tutorial = window.tutorial;
                
                // Step 3に移動
                addResult('シミュレーション Step 1', true, 'Step 3に移動中...', '', simResults);
                tutorial.currentStep = 3;
                tutorial.updateStepContent();
                tutorial.resetCode();
                tutorial.updateProgress();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3実行をシミュレート（成功状態）
                addResult('シミュレーション Step 2', true, 'Step 3実行完了をシミュレート...', '', simResults);
                tutorial.nextBtn.disabled = false;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 完了モーダル表示
                addResult('シミュレーション Step 3', true, '完了モーダル表示...', '', simResults);
                tutorial.showCompletionModal();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4に進行
                addResult('シミュレーション Step 4', true, 'Step 4に進行中...', '', simResults);
                tutorial.nextStep();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 4の状態確認
                if (tutorial.currentStep === 4) {
                    const stepTitle = document.getElementById('stepTitle')?.textContent;
                    addResult('シミュレーション完了', true, 
                        'Step 3→4の進行が成功しました！',
                        `現在のステップ: ${tutorial.currentStep}\nタイトル: ${stepTitle}`,
                        simResults
                    );
                } else {
                    throw new Error(`Step 4に進行していません。現在のステップ: ${tutorial.currentStep}`);
                }
                
            } catch (error) {
                addResult('シミュレーション失敗', false, error.message, '', simResults);
            }
        }

        // ページ読み込み時に基本情報表示
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.tutorial) {
                    addResult('初期状態確認', true, 
                        'チュートリアルが正常に読み込まれています',
                        `現在のステップ: ${window.tutorial.currentStep}\n合計ステップ: ${window.tutorial.totalSteps}`
                    );
                } else {
                    addResult('初期状態確認', false, 'チュートリアルが読み込まれていません');
                }
            }, 1000);
        });
    </script>
</body>
</html>