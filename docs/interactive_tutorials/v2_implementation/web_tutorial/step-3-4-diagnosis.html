<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ” Step 3â†’4 é€²è¡Œå•é¡Œ è©³ç´°è¨ºæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 1000px; margin: 0 auto; }
        .test-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .step-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .json-display { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” Step 3â†’4 é€²è¡Œå•é¡Œ è©³ç´°è¨ºæ–­</h1>
        
        <div class="test-panel info">
            <h2>ğŸ“‹ è¨ºæ–­é …ç›®</h2>
            <button onclick="runFullDiagnosis()" class="btn-primary">ğŸš€ å®Œå…¨è¨ºæ–­å®Ÿè¡Œ</button>
            <button onclick="testStep3Completion()" class="btn-success">âœ… Step 3 å®Œäº†ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testStep4Access()" class="btn-warning">ğŸ”„ Step 4 ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testProgressionLogic()" class="btn-danger">âš¡ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div id="diagnosticResults"></div>
        
        <div class="test-panel">
            <h3>ğŸ® ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</h3>
            <p>å®Ÿéš›ã®Stepé€²è¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <button onclick="simulateStep3to4()" class="btn-success">ğŸ”„ Step 3â†’4 ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <div id="simulationResults"></div>
        </div>
    </div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>
    
    <script>
        let diagResults = document.getElementById('diagnosticResults');
        let simResults = document.getElementById('simulationResults');

        function addResult(title, success, message, details = '', targetDiv = diagResults) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-panel ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h3>${success ? 'âœ…' : 'âŒ'} ${title}</h3>
                <p><strong>çµæœ:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            targetDiv.appendChild(resultDiv);
        }

        async function runFullDiagnosis() {
            diagResults.innerHTML = '';
            console.log('ğŸš€ å®Œå…¨è¨ºæ–­é–‹å§‹...');
            
            // 1. steps.jsonã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
            await testStepsJsonLoad();
            
            // 2. ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¯ãƒ©ã‚¹ã®çŠ¶æ…‹ãƒ†ã‚¹ãƒˆ
            testTutorialState();
            
            // 3. Step 4ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
            testStep4Data();
            
            // 4. é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
            testProgressionLogic();
            
            console.log('âœ… å®Œå…¨è¨ºæ–­å®Œäº†');
        }

        async function testStepsJsonLoad() {
            try {
                const response = await fetch('steps.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length !== 5) {
                    throw new Error(`ã‚¹ãƒ†ãƒƒãƒ—æ•°ãŒç•°å¸¸: ${data.length} (æœŸå¾…å€¤: 5)`);
                }
                
                // Step 3ã¨4ã®è©³ç´°ç¢ºèª
                const step3 = data.find(s => s.step === 3);
                const step4 = data.find(s => s.step === 4);
                
                if (!step3) throw new Error('Step 3ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                if (!step4) throw new Error('Step 4ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                
                addResult('steps.jsonèª­ã¿è¾¼ã¿', true, 
                    `æ­£å¸¸ã«5ã‚¹ãƒ†ãƒƒãƒ—èª­ã¿è¾¼ã¿`, 
                    `Step 3: ${step3.title}\nStep 4: ${step4.title}\n\nStep 4 template: ${step4.template ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`
                );
                
            } catch (error) {
                addResult('steps.jsonèª­ã¿è¾¼ã¿', false, error.message);
            }
        }

        function testTutorialState() {
            try {
                if (!window.tutorial) {
                    throw new Error('window.tutorialãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const tutorial = window.tutorial;
                const state = {
                    currentStep: tutorial.currentStep,
                    totalSteps: tutorial.totalSteps,
                    stepsLoaded: tutorial.tutorialSteps?.length || 0,
                    executionHistory: tutorial.stepExecutionHistory?.length || 0
                };
                
                if (state.totalSteps !== 5) {
                    throw new Error(`totalStepsãŒç•°å¸¸: ${state.totalSteps} (æœŸå¾…å€¤: 5)`);
                }
                
                if (state.stepsLoaded !== 5) {
                    throw new Error(`èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—æ•°ãŒç•°å¸¸: ${state.stepsLoaded} (æœŸå¾…å€¤: 5)`);
                }
                
                addResult('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«çŠ¶æ…‹', true, 
                    'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯æ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™',
                    `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${state.currentStep}\nåˆè¨ˆã‚¹ãƒ†ãƒƒãƒ—: ${state.totalSteps}\nèª­ã¿è¾¼ã¾ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—: ${state.stepsLoaded}\nå®Ÿè¡Œå±¥æ­´: ${state.executionHistory}`
                );
                
            } catch (error) {
                addResult('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«çŠ¶æ…‹', false, error.message);
            }
        }

        function testStep4Data() {
            try {
                if (!window.tutorial || !window.tutorial.tutorialSteps) {
                    throw new Error('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                const step4 = window.tutorial.tutorialSteps.find(s => s.step === 4);
                if (!step4) {
                    throw new Error('Step 4ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // Step 4ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèª
                const requiredFields = ['step', 'title', 'physics_background', 'instructions', 'template'];
                const missingFields = requiredFields.filter(field => !step4[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`Step 4ã«å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: ${missingFields.join(', ')}`);
                }
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®JSONå¦¥å½“æ€§ç¢ºèª
                try {
                    JSON.parse(step4.template);
                } catch (e) {
                    throw new Error(`Step 4ã®templateãŒç„¡åŠ¹ãªJSON: ${e.message}`);
                }
                
                addResult('Step 4ãƒ‡ãƒ¼ã‚¿ç¢ºèª', true, 
                    'Step 4ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«å­˜åœ¨ã—ã¾ã™',
                    `ã‚¿ã‚¤ãƒˆãƒ«: ${step4.title}\nãƒ¡ã‚½ãƒƒãƒ‰: ${JSON.parse(step4.template).method}\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé•·: ${step4.template.length}æ–‡å­—`
                );
                
            } catch (error) {
                addResult('Step 4ãƒ‡ãƒ¼ã‚¿ç¢ºèª', false, error.message);
            }
        }

        function testProgressionLogic() {
            try {
                if (!window.tutorial) {
                    throw new Error('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                const tutorial = window.tutorial;
                
                // nextStepãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                if (typeof tutorial.nextStep !== 'function') {
                    throw new Error('nextStepãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
                // showCompletionModalãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                if (typeof tutorial.showCompletionModal !== 'function') {
                    throw new Error('showCompletionModalãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
                // updateStepContentãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                if (typeof tutorial.updateStepContent !== 'function') {
                    throw new Error('updateStepContentãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
                addResult('é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª', true, 
                    'å…¨ã¦ã®é€²è¡Œé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™',
                    'nextStep, showCompletionModal, updateStepContent ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£å¸¸ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™'
                );
                
            } catch (error) {
                addResult('é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª', false, error.message);
            }
        }

        function testStep3Completion() {
            try {
                if (!window.tutorial) {
                    throw new Error('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                // Step 3ã«å¼·åˆ¶ç§»å‹•
                window.tutorial.currentStep = 3;
                window.tutorial.updateStepContent();
                window.tutorial.updateProgress();
                
                // Step 3ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆ
                const step3 = window.tutorial.tutorialSteps.find(s => s.step === 3);
                if (!step3) {
                    throw new Error('Step 3ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // Step 3å®Œäº†çŠ¶æ…‹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                window.tutorial.nextBtn.disabled = false; // æˆåŠŸçŠ¶æ…‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                
                addResult('Step 3å®Œäº†ãƒ†ã‚¹ãƒˆ', true, 
                    'Step 3ã¸ã®ç§»å‹•ã¨å®Œäº†æº–å‚™ãŒæ­£å¸¸ã§ã™',
                    `Step 3ã‚¿ã‚¤ãƒˆãƒ«: ${step3.title}\næ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒœã‚¿ãƒ³: ${window.tutorial.nextBtn.disabled ? 'ç„¡åŠ¹' : 'æœ‰åŠ¹'}`
                );
                
            } catch (error) {
                addResult('Step 3å®Œäº†ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        function testStep4Access() {
            try {
                if (!window.tutorial) {
                    throw new Error('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                // Step 4ã«ç›´æ¥ç§»å‹•ã‚’ãƒ†ã‚¹ãƒˆ
                const originalStep = window.tutorial.currentStep;
                
                window.tutorial.currentStep = 4;
                window.tutorial.updateStepContent();
                window.tutorial.resetCode();
                window.tutorial.updateProgress();
                
                // Step 4ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const stepTitle = document.getElementById('stepTitle')?.textContent;
                if (!stepTitle || !stepTitle.includes('è¤‡åˆé®è”½')) {
                    throw new Error(`Step 4ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“: ${stepTitle}`);
                }
                
                // Step 4ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const codeEditor = document.getElementById('codeEditor');
                if (!codeEditor || !codeEditor.textContent.includes('lead_inner_shield')) {
                    throw new Error('Step 4ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¾ã›ã‚“');
                }
                
                // å…ƒã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã™
                window.tutorial.currentStep = originalStep;
                window.tutorial.updateStepContent();
                window.tutorial.resetCode();
                window.tutorial.updateProgress();
                
                addResult('Step 4ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ', true, 
                    'Step 4ã¸ã®ç›´æ¥ç§»å‹•ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™',
                    `Step 4ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º: OK\nStep 4ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š: OK`
                );
                
            } catch (error) {
                addResult('Step 4ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        async function simulateStep3to4() {
            simResults.innerHTML = '';
            
            try {
                if (!window.tutorial) {
                    throw new Error('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                const tutorial = window.tutorial;
                
                // Step 3ã«ç§»å‹•
                addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ Step 1', true, 'Step 3ã«ç§»å‹•ä¸­...', '', simResults);
                tutorial.currentStep = 3;
                tutorial.updateStepContent();
                tutorial.resetCode();
                tutorial.updateProgress();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3å®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆæˆåŠŸçŠ¶æ…‹ï¼‰
                addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ Step 2', true, 'Step 3å®Ÿè¡Œå®Œäº†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ...', '', simResults);
                tutorial.nextBtn.disabled = false;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ Step 3', true, 'å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º...', '', simResults);
                tutorial.showCompletionModal();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4ã«é€²è¡Œ
                addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ Step 4', true, 'Step 4ã«é€²è¡Œä¸­...', '', simResults);
                tutorial.nextStep();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 4ã®çŠ¶æ…‹ç¢ºèª
                if (tutorial.currentStep === 4) {
                    const stepTitle = document.getElementById('stepTitle')?.textContent;
                    addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', true, 
                        'Step 3â†’4ã®é€²è¡ŒãŒæˆåŠŸã—ã¾ã—ãŸï¼',
                        `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${tutorial.currentStep}\nã‚¿ã‚¤ãƒˆãƒ«: ${stepTitle}`,
                        simResults
                    );
                } else {
                    throw new Error(`Step 4ã«é€²è¡Œã—ã¦ã„ã¾ã›ã‚“ã€‚ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${tutorial.currentStep}`);
                }
                
            } catch (error) {
                addResult('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—', false, error.message, '', simResults);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åŸºæœ¬æƒ…å ±è¡¨ç¤º
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.tutorial) {
                    addResult('åˆæœŸçŠ¶æ…‹ç¢ºèª', true, 
                        'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™',
                        `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorial.currentStep}\nåˆè¨ˆã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorial.totalSteps}`
                    );
                } else {
                    addResult('åˆæœŸçŠ¶æ…‹ç¢ºèª', false, 'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }, 1000);
        });
    </script>
</body>
</html>