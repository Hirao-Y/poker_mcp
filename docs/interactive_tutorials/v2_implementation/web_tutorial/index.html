<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 Poker MCP チュートリアル v2.1</title>
    <link rel="stylesheet" href="assets/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <!-- ヘッダー -->
    <div class="tutorial-header">
        <div class="header-content">
            <h1>🎮 Poker MCP チュートリアル v2.1</h1>
            <div class="header-controls">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                        <span class="progress-text" id="progressText">Step 1 / 5</span>
                    </div>
                </div>
                <div class="header-buttons">
                    <button id="toggleVisualization" class="header-btn">🎨 可視化</button>
                    <button id="showPhysicsAnalysis" class="header-btn">🔬 物理解析</button>
                    <a href="tutorial-complete-check.html" class="header-btn">🔧 診断</a>
                </div>
            </div>
        </div>
    </div>

    <!-- メインコンテナ -->
    <div class="tutorial-container">
        <!-- 左パネル: 指導内容 -->
        <div class="instruction-panel">
            <div class="step-header">
                <span class="step-badge" id="stepBadge">Step 1</span>
                <h2 id="stepTitle">初期化中...</h2>
            </div>
            
            <div class="physics-context">
                <h3>🔬 物理的背景</h3>
                <p id="physicsExplanation">初期化中...</p>
            </div>
            
            <div class="instruction-content">
                <h3>📋 実習内容</h3>
                <p id="stepInstructions">初期化中...</p>
            </div>

            <div class="hints-container" id="hintsContainer">
                <!-- ヒントがここに表示されます -->
            </div>

            <div class="step-navigation">
                <button id="prevStepBtn" class="nav-button prev" disabled>⬅️ 前のステップ</button>
                <button id="nextStepBtn" class="nav-button next">次のステップ ➡️</button>
            </div>
        </div>

        <!-- 右パネル: コーディング -->
        <div class="coding-panel">
            <div class="panel-header">
                <h3>⚡ JSON エディタ</h3>
                <div class="panel-controls">
                    <button id="validateBtn" class="btn btn-secondary">🔍 検証</button>
                </div>
            </div>
            
            <div class="json-editor">
                <textarea id="jsonEditor" placeholder="JSONコードがここに表示されます...">初期化中...</textarea>
            </div>
            
            <div class="action-buttons">
                <button id="executeBtn" class="btn btn-primary">🚀 実行</button>
                <button id="clearBtn" class="btn btn-secondary">🗑️ クリア</button>
            </div>
            
            <div class="response-area" id="responseArea">
                レスポンス表示エリア
            </div>

            <!-- 達成表示 -->
            <div id="achievementArea"></div>

            <!-- 可視化エリア -->
            <div class="visualization-area">
                <div class="viz-header">
                    <h4>🎨 3D 可視化</h4>
                    <div class="viz-controls">
                        <button id="toggle3DVisualization" class="viz-btn">🎯 3D表示</button>
                        <button id="show3DControls" class="viz-btn">⚙️ 設定</button>
                        <button id="capture3DScreenshot" class="viz-btn">📷 画面保存</button>
                        <button id="show3DDiagnostic" class="viz-btn">🔍 診断</button>
                        <button id="runDeepDiagnostic" class="viz-btn">🔬 詳細診断</button>
                    </div>
                </div>
                
                <canvas id="geometryCanvas" width="400" height="300">
                    お使いのブラウザはCanvas要素をサポートしていません。
                </canvas>
                
                <div id="visualizationMessage" class="viz-message">
                    3D可視化システム読み込み中...
                </div>
                
                <div id="visualizationFallback" class="viz-fallback" style="display: none;">
                    🎨 2D表示モード（WebGL未対応環境）
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-json.min.js"></script>
    
    <!-- Quick Check Script (最優先で読み込み) -->
    <script src="quick-check.js"></script>
    
    <!-- Deep Diagnostic Tool (最初に読み込み) -->
    <script src="deep-diagnostic.js"></script>
    
    <!-- Three.js and Error Handling -->
    <script src="error-handling.js"></script>
    <script src="webgl-fallback.js"></script>
    
    <!-- Tutorial JavaScript (分割版) -->
    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="visualization-3d.js"></script>
    <script src="visualization-manager.js"></script>
    <script src="visualization-controls.js"></script>
    <script src="tutorial-core.js"></script>
    <script src="tutorial-ui.js"></script>
    <script src="tutorial-main.js"></script>

    <script>
        // 追加の初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🌟 DOM読み込み完了');
            
            // クリアボタンの機能
            const clearBtn = document.getElementById('clearBtn');
            const jsonEditor = document.getElementById('jsonEditor');
            
            if (clearBtn && jsonEditor) {
                clearBtn.addEventListener('click', () => {
                    jsonEditor.value = '';
                    console.log('🗑️ エディタクリア');
                });
            }

            // Tutorial初期化待機
            const waitForTutorial = () => {
                if (window.tutorial && window.tutorial.core && window.tutorial.core.tutorialSteps) {
                    console.log('✅ Tutorial準備完了');
                    
                    // 成功メッセージ表示
                    const responseArea = document.getElementById('responseArea');
                    if (responseArea) {
                        responseArea.textContent = '🎉 Tutorial準備完了！上記のJSONコードを編集・実行できます。';
                        responseArea.className = 'response-area success';
                    }
                } else {
                    console.log('⏳ Tutorial初期化待機中...');
                    setTimeout(waitForTutorial, 1000);
                }
            };

            // 初期化チェック開始
            setTimeout(waitForTutorial, 500);

            const toggle3DBtn = document.getElementById('toggle3DVisualization');
            const show3DControlsBtn = document.getElementById('show3DControls');
            const capture3DBtn = document.getElementById('capture3DScreenshot');
            const show3DDiagnosticBtn = document.getElementById('show3DDiagnostic');
            
            if (toggle3DBtn) {
                toggle3DBtn.addEventListener('click', () => {
                    if (window.tutorial && window.tutorial.visualization3DManager) {
                        window.tutorial.visualization3DManager.toggle();
                        toggle3DBtn.textContent = window.tutorial.visualization3DManager.isEnabled 
                            ? '🎯 3D非表示' : '🎯 3D表示';
                    } else {
                        console.warn('⚠️ 3D可視化マネージャーが利用できません');
                    }
                });
            }

            if (show3DControlsBtn) {
                show3DControlsBtn.addEventListener('click', () => {
                    if (window.tutorial && window.tutorial.visualizationControls) {
                        window.tutorial.visualizationControls.toggle();
                    } else {
                        console.warn('⚠️ 3Dコントロールパネルが利用できません');
                    }
                });
            }

            if (capture3DBtn) {
                capture3DBtn.addEventListener('click', () => {
                    if (window.tutorial && window.tutorial.visualization3DManager) {
                        window.tutorial.visualization3DManager.captureScreenshot();
                    } else {
                        console.warn('⚠️ 3D可視化マネージャーが利用できません');
                    }
                });
            }

            if (show3DDiagnosticBtn) {
                show3DDiagnosticBtn.addEventListener('click', () => {
                    if (window.tutorial && window.tutorial.visualization3DManager) {
                        window.tutorial.visualization3DManager.showDiagnosticReport();
                    } else {
                        // 直接診断情報を表示
                        if (typeof ThreeJSLoader !== 'undefined') {
                            const loader = new ThreeJSLoader();
                            const threeInfo = loader.getThreeJSInfo();
                            
                            let webglInfo = 'WebGL情報取得不可';
                            if (typeof WebGLSupportChecker !== 'undefined') {
                                const checker = new WebGLSupportChecker();
                                const report = checker.getCompatibilityReport();
                                webglInfo = `WebGL: ${report.webgl ? '✅' : '❌'}, WebGL2: ${report.webgl2 ? '✅' : '❌'}`;
                            }
                            
                            alert(`診断情報:\nThree.js: ${threeInfo.loaded ? '✅ v' + threeInfo.version : '❌ 未読み込み'}\n${webglInfo}\nブラウザ: ${navigator.userAgent.split(') ')[0]})`);
                        } else {
                            alert('診断機能が利用できません。\nError-handlingスクリプトの読み込みを確認してください。');
                        }
                    }
                });
            }

            const runDeepDiagnosticBtn = document.getElementById('runDeepDiagnostic');
            
            if (runDeepDiagnosticBtn) {
                runDeepDiagnosticBtn.addEventListener('click', () => {
                    console.log('🔬 詳細診断を手動実行...');
                    
                    if (typeof DeepDiagnosticTool !== 'undefined') {
                        // 新しい詳細診断を実行
                        const diagnosticTool = new DeepDiagnosticTool();
                        
                        // エクスポートボタンも表示
                        setTimeout(() => {
                            if (confirm('診断データをJSONファイルでエクスポートしますか？')) {
                                diagnosticTool.exportDiagnosticData();
                            }
                        }, 3000);
                    } else {
                        alert('詳細診断ツールが読み込まれていません。\ndeep-diagnostic.jsファイルを確認してください。');
                    }
                });
            }
        });

        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('❌ グローバルエラー:', event.error);
            
            const responseArea = document.getElementById('responseArea');
            if (responseArea) {
                responseArea.textContent = `⚠️ エラーが発生しました: ${event.error.message}\n診断システムで確認してください。`;
                responseArea.className = 'response-area error';
            }
        });
    </script>
</body>
</html>