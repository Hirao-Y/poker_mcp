<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ” Step 4å­˜åœ¨ç¢ºèª & é€²è¡Œå•é¡Œèª¿æŸ»</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
        .verify-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; border: 2px solid #2196F3; }
        .result-panel { margin: 15px 0; padding: 15px; border-radius: 6px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-test { background: #17a2b8; color: white; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; }
        .step-data { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>
    <h1>ğŸ” Step 4å­˜åœ¨ç¢ºèª & é€²è¡Œå•é¡Œèª¿æŸ»</h1>
    
    <div class="verify-panel">
        <h2>ğŸ“‹ Step 4ç¢ºèªé …ç›®</h2>
        <button onclick="verifyStep4Existence()" class="btn-primary">âœ… Step 4å­˜åœ¨ç¢ºèª</button>
        <button onclick="testStep4Navigation()" class="btn-test">ğŸ”„ Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ</button>
        <button onclick="forceStep4Display()" class="btn-success">âš¡ Step 4å¼·åˆ¶è¡¨ç¤º</button>
        <button onclick="fullSystemCheck()" class="btn-primary">ğŸ” ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒã‚§ãƒƒã‚¯</button>
    </div>

    <div id="results"></div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>

    <script>
        let resultsDiv = document.getElementById('results');

        function addResult(title, type, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-panel ${type}`;
            resultDiv.innerHTML = `
                <h3>${getIcon(type)} ${title}</h3>
                <p><strong>çµæœ:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
                <small>ç¢ºèªæ™‚åˆ»: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return 'âœ…';
                case 'error': return 'âŒ';
                case 'warning': return 'âš ï¸';
                case 'info': return 'â„¹ï¸';
                default: return 'ğŸ”';
            }
        }

        async function verifyStep4Existence() {
            resultsDiv.innerHTML = '';
            console.log('ğŸ” Step 4å­˜åœ¨ç¢ºèªé–‹å§‹...');

            try {
                // 1. steps.jsonã®ç›´æ¥èª­ã¿è¾¼ã¿ç¢ºèª
                const stepsResponse = await fetch('steps.json');
                if (!stepsResponse.ok) {
                    throw new Error(`steps.jsonèª­ã¿è¾¼ã¿å¤±æ•—: ${stepsResponse.status}`);
                }
                
                const stepsData = await stepsResponse.json();
                const step4FromFile = stepsData.find(s => s.step === 4);

                // 2. ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã®ç¢ºèª
                let step4FromTutorial = null;
                let tutorialState = 'ãªã—';
                
                if (window.tutorial && window.tutorial.tutorialSteps) {
                    step4FromTutorial = window.tutorial.tutorialSteps.find(s => s.step === 4);
                    tutorialState = 'åˆ©ç”¨å¯èƒ½';
                }

                // 3. çµæœã¾ã¨ã‚
                const verification = {
                    stepsJsonExists: !!stepsResponse.ok,
                    totalStepsInFile: stepsData.length,
                    step4InFile: {
                        exists: !!step4FromFile,
                        title: step4FromFile?.title,
                        hasTemplate: !!step4FromFile?.template,
                        templateMethod: step4FromFile?.template ? JSON.parse(step4FromFile.template).method : null
                    },
                    tutorialObject: {
                        exists: !!window.tutorial,
                        state: tutorialState,
                        currentStep: window.tutorial?.currentStep,
                        totalSteps: window.tutorial?.totalSteps,
                        stepsLoaded: window.tutorial?.tutorialSteps?.length
                    },
                    step4InTutorial: {
                        exists: !!step4FromTutorial,
                        title: step4FromTutorial?.title,
                        hasTemplate: !!step4FromTutorial?.template
                    }
                };

                if (step4FromFile && step4FromTutorial) {
                    addResult('Step 4å­˜åœ¨ç¢ºèª', 'success', 
                        'Step 4ã¯å®Œå…¨ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ï¼',
                        `æ¤œè¨¼çµæœ:\n${JSON.stringify(verification, null, 2)}`
                    );
                } else {
                    addResult('Step 4å­˜åœ¨ç¢ºèª', 'error', 
                        'Step 4ã«ã‚¢ã‚¯ã‚»ã‚¹å•é¡ŒãŒã‚ã‚Šã¾ã™',
                        `æ¤œè¨¼çµæœ:\n${JSON.stringify(verification, null, 2)}`
                    );
                }

                // 4. Step 4ã®è©³ç´°å†…å®¹è¡¨ç¤º
                if (step4FromFile) {
                    const step4Details = {
                        step: step4FromFile.step,
                        title: step4FromFile.title,
                        physics_background: step4FromFile.physics_background?.substring(0, 100) + '...',
                        instructions: step4FromFile.instructions?.substring(0, 100) + '...',
                        template: step4FromFile.template?.substring(0, 150) + '...',
                        hasFollowUpTemplate: !!step4FromFile.follow_up_template,
                        achievement: step4FromFile.achievement,
                        hintsCount: step4FromFile.hints?.length || 0
                    };

                    addResult('Step 4è©³ç´°å†…å®¹', 'info', 
                        'Step 4ã®å®Œå…¨ãªå†…å®¹ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ',
                        `Step 4å†…å®¹:\n${JSON.stringify(step4Details, null, 2)}`
                    );
                }

            } catch (error) {
                addResult('Step 4å­˜åœ¨ç¢ºèª', 'error', 
                    `ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${error.message}`,
                    `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.stack}`
                );
            }
        }

        function testStep4Navigation() {
            try {
                if (!window.tutorial) {
                    addResult('Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                console.log('ğŸ”„ Step 4é€²è¡Œãƒ†ã‚¹ãƒˆé–‹å§‹...');

                // ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
                const beforeTest = {
                    currentStep: tutorial.currentStep,
                    stepTitle: document.getElementById('stepTitle')?.textContent,
                    stepBadge: document.getElementById('stepBadge')?.textContent
                };

                // Step 3ã«è¨­å®šã—ã¦ã‹ã‚‰Step 4ã¸ã®é€²è¡Œã‚’ãƒ†ã‚¹ãƒˆ
                tutorial.currentStep = 3;
                tutorial.updateStepContent();
                tutorial.updateProgress();

                setTimeout(() => {
                    console.log('Step 3è¨­å®šå®Œäº†ã€nextStep()å®Ÿè¡Œ...');
                    
                    try {
                        tutorial.nextStep();
                        
                        setTimeout(() => {
                            const afterTest = {
                                currentStep: tutorial.currentStep,
                                stepTitle: document.getElementById('stepTitle')?.textContent,
                                stepBadge: document.getElementById('stepBadge')?.textContent,
                                codeContent: document.getElementById('codeEditor')?.textContent?.substring(0, 100)
                            };

                            const navigationSuccess = tutorial.currentStep === 4 && 
                                                    afterTest.stepTitle?.includes('è¤‡åˆé®è”½');

                            const testResult = {
                                beforeTest,
                                afterTest,
                                navigationSuccess,
                                step4ContentDetected: afterTest.codeContent?.includes('lead_inner_shield')
                            };

                            if (navigationSuccess) {
                                addResult('Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ', 'success',
                                    'Step 3â†’4ã®é€²è¡Œã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™ï¼',
                                    `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResult, null, 2)}`
                                );
                            } else {
                                addResult('Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ', 'error',
                                    'Step 3â†’4ã®é€²è¡Œã«å•é¡ŒãŒã‚ã‚Šã¾ã™',
                                    `ãƒ†ã‚¹ãƒˆçµæœ:\n${JSON.stringify(testResult, null, 2)}`
                                );
                            }
                        }, 300);

                    } catch (navError) {
                        addResult('Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ', 'error',
                            `nextStep()å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼: ${navError.message}`,
                            `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${navError.stack}`
                        );
                    }
                }, 200);

            } catch (error) {
                addResult('Step 4é€²è¡Œãƒ†ã‚¹ãƒˆ', 'error', 
                    `ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`
                );
            }
        }

        function forceStep4Display() {
            try {
                if (!window.tutorial) {
                    addResult('Step 4å¼·åˆ¶è¡¨ç¤º', 'error', 'tutorialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }

                const tutorial = window.tutorial;
                console.log('âš¡ Step 4å¼·åˆ¶è¡¨ç¤ºé–‹å§‹...');

                const beforeForce = {
                    currentStep: tutorial.currentStep,
                    stepTitle: document.getElementById('stepTitle')?.textContent
                };

                // å¼·åˆ¶çš„ã«Step 4ã‚’è¡¨ç¤º
                tutorial.currentStep = 4;
                tutorial.updateStepContent();
                tutorial.resetCode();
                tutorial.updateProgress();
                tutorial.clearResults();

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                if (tutorial.modalOverlay) {
                    tutorial.modalOverlay.style.display = 'none';
                }

                setTimeout(() => {
                    const afterForce = {
                        currentStep: tutorial.currentStep,
                        stepTitle: document.getElementById('stepTitle')?.textContent,
                        stepBadge: document.getElementById('stepBadge')?.textContent,
                        codeContent: document.getElementById('codeEditor')?.textContent?.substring(0, 150),
                        physicsBackground: document.getElementById('physicsExplanation')?.textContent?.substring(0, 100)
                    };

                    const displaySuccess = afterForce.currentStep === 4 && 
                                         afterForce.stepTitle?.includes('è¤‡åˆé®è”½') &&
                                         afterForce.codeContent?.includes('lead_inner_shield');

                    const forceResult = {
                        beforeForce,
                        afterForce,
                        displaySuccess,
                        hasStep4Content: {
                            titleCorrect: afterForce.stepTitle?.includes('è¤‡åˆé®è”½'),
                            badgeCorrect: afterForce.stepBadge?.includes('Step 4'),
                            codeCorrect: afterForce.codeContent?.includes('lead_inner_shield'),
                            physicsCorrect: afterForce.physicsBackground?.includes('é‰›')
                        }
                    };

                    if (displaySuccess) {
                        addResult('Step 4å¼·åˆ¶è¡¨ç¤º', 'success',
                            'Step 4ã®å¼·åˆ¶è¡¨ç¤ºã«æˆåŠŸã—ã¾ã—ãŸï¼',
                            `å¼·åˆ¶è¡¨ç¤ºçµæœ:\n${JSON.stringify(forceResult, null, 2)}`
                        );
                    } else {
                        addResult('Step 4å¼·åˆ¶è¡¨ç¤º', 'error',
                            'Step 4ã®å¼·åˆ¶è¡¨ç¤ºã«å•é¡ŒãŒã‚ã‚Šã¾ã™',
                            `å¼·åˆ¶è¡¨ç¤ºçµæœ:\n${JSON.stringify(forceResult, null, 2)}`
                        );
                    }
                }, 500);

            } catch (error) {
                addResult('Step 4å¼·åˆ¶è¡¨ç¤º', 'error', 
                    `å¼·åˆ¶è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`
                );
            }
        }

        function fullSystemCheck() {
            console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
            
            // æ®µéšçš„ã«å…¨ã¦ã®ç¢ºèªã‚’å®Ÿè¡Œ
            verifyStep4Existence();
            
            setTimeout(() => {
                testStep4Navigation();
            }, 1000);
            
            setTimeout(() => {
                forceStep4Display();
            }, 2000);
        }

        // åˆæœŸçŠ¶æ…‹ã®ç¢ºèª
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('åˆæœŸçŠ¶æ…‹', 'info', 
                    `ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ…‹: ${window.tutorial ? 'æˆåŠŸ' : 'å¤±æ•—'}`,
                    window.tutorial ? `ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorial.currentStep}\nç·ã‚¹ãƒ†ãƒƒãƒ—æ•°: ${window.tutorial.totalSteps}` : ''
                );
            }, 1500);
        });
    </script>
</body>
</html>