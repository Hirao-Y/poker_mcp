Btn.addEventListener('click', function() {
                    if (window.integratedViz) {
                        window.integratedViz.testDraw();
                    }
                });
            }
            
            const systemInfoBtn = document.getElementById('showSystemInfo');
            if (systemInfoBtn) {
                systemInfoBtn.addEventListener('click', showDetailedSystemInfo);
            }

            // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', function() {
                if (window.integratedViz) {
                    window.integratedViz.handleResize();
                }
            });
        }

        // JSONå®Ÿè¡Œ
        function executeIntegratedJson() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const request = JSON.parse(jsonInput.value);
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!request.jsonrpc || request.jsonrpc !== "2.0") {
                    throw new Error("JSON-RPC 2.0å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                }
                if (!request.method) {
                    throw new Error("methodãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }

                // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿œç­”
                const response = {
                    jsonrpc: "2.0",
                    result: {
                        success: true,
                        message: `${request.method} ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ`,
                        timestamp: new Date().toISOString(),
                        visualizationMode: window.integratedViz ? window.integratedViz.mode : 'unknown'
                    },
                    id: request.id
                };
                
                jsonOutput.textContent = JSON.stringify(response, null, 2);
                jsonOutput.className = 'output-content success';
                
                // å¯è¦–åŒ–æ›´æ–°
                updateVisualizationFromJson(request);
                
                // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ•°å¢—åŠ 
                if (window.tutorialCore) {
                    window.tutorialCore.progress.interactions++;
                }
                
            } catch (error) {
                const errorResponse = {
                    jsonrpc: "2.0",
                    error: {
                        code: -32700,
                        message: "Parse error",
                        data: error.message
                    },
                    id: null
                };
                
                jsonOutput.textContent = JSON.stringify(errorResponse, null, 2);
                jsonOutput.className = 'output-content error';
            }
        }

        // JSONæ¤œè¨¼
        function validateJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                
                const validations = [];
                
                if (parsed.jsonrpc !== "2.0") {
                    validations.push("âš ï¸ JSON-RPC 2.0ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                }
                
                if (!parsed.method) {
                    validations.push("âŒ methodãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }
                
                if (parsed.id === undefined) {
                    validations.push("âš ï¸ idãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }
                
                const validMethods = [
                    'pokerinput_proposeSource',
                    'pokerinput_proposeBody', 
                    'pokerinput_proposeDetector',
                    'pokerinput_applyChanges'
                ];
                
                if (parsed.method && validMethods.indexOf(parsed.method) === -1) {
                    validations.push(`âš ï¸ æœªçŸ¥ã®method: ${parsed.method}`);
                }
                
                if (validations.length === 0) {
                    jsonOutput.textContent = 'âœ… JSONå½¢å¼ã¨schemaã¯æ­£ã—ã„ã§ã™';
                    jsonOutput.className = 'output-content success';
                } else {
                    jsonOutput.textContent = `æ¤œè¨¼çµæœ:\n${validations.join('\n')}`;
                    jsonOutput.className = 'output-content warning';
                }
                
            } catch (error) {
                jsonOutput.textContent = `âŒ JSONæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                jsonOutput.className = 'output-content error';
            }
        }

        // JSONã‹ã‚‰å¯è¦–åŒ–æ›´æ–°
        function updateVisualizationFromJson(request) {
            if (!window.integratedViz) return;
            
            const method = request.method;
            const params = request.params;
            
            try {
                if (method === 'pokerinput_proposeSource' && params) {
                    const position = params.position ? params.position.split(' ').map(Number) : [0, 0, 0];
                    const nuclide = params.inventory && params.inventory[0] ? params.inventory[0].nuclide : 'Unknown';
                    const activity = params.inventory && params.inventory[0] ? params.inventory[0].radioactivity : 0;
                    
                    window.integratedViz.addRadiationSource(params.name, position, nuclide, activity);
                    
                } else if (method === 'pokerinput_proposeBody' && params) {
                    const center = params.center ? params.center.split(' ').map(Number) : [0, 0, 0];
                    const parameters = { center: center, radius: params.radius };
                    
                    window.integratedViz.addShield(params.name, params.type, parameters, 'CONCRETE');
                    
                } else if (method === 'pokerinput_proposeDetector' && params) {
                    const origin = params.origin ? params.origin.split(' ').map(Number) : [0, 0, 0];
                    
                    window.integratedViz.addDetector(params.name, origin, params.grid || []);
                }
                
            } catch (error) {
                console.error('å¯è¦–åŒ–æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                if (window.integratedViz) {
                    window.integratedViz.showMessage(`å¯è¦–åŒ–æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
        }

        // è©³ç´°ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
        function showDetailedSystemInfo() {
            const info = window.integratedViz ? window.integratedViz.getDiagnosticInfo() : {};
            
            const detailedInfo = `=== çµ±åˆ3D/2Då¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ===

ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹:
â€¢ å¯è¦–åŒ–ãƒ¢ãƒ¼ãƒ‰: ${info.mode ? info.mode.toUpperCase() : 'Unknown'}
â€¢ Canvas2D: ${info.hasCanvas2D ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ åˆ©ç”¨ä¸å¯'}
â€¢ 3Dæ©Ÿèƒ½: ${info.isThreeJSAvailable ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ åˆ©ç”¨ä¸å¯'}
â€¢ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${info.isAnimating ? 'âœ… å‹•ä½œä¸­' : 'â¸ï¸ åœæ­¢ä¸­'}

ğŸ¨ å¯è¦–åŒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:
â€¢ ç·šæº: ${info.sources || 0}å€‹
â€¢ é®è”½ä½“: ${info.shields || 0}å€‹  
â€¢ æ¤œå‡ºå™¨: ${info.detectors || 0}å€‹

ğŸ–¼ï¸ Canvasæƒ…å ±:
â€¢ ã‚µã‚¤ã‚º: ${info.canvasSize ? info.canvasSize.width : 0} x ${info.canvasSize ? info.canvasSize.height : 0}
â€¢ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“: ${info.animationTime || 0}ms

ğŸŒ ç’°å¢ƒæƒ…å ±:
â€¢ ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.split(' ')[0]}
â€¢ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${navigator.platform}
â€¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ${navigator.onLine ? 'Yes' : 'No'}
â€¢ ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${window.location.protocol}

ğŸ“ˆ å­¦ç¿’é€²æ—:
â€¢ ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorialCore ? window.tutorialCore.currentStep : 0} / ${window.tutorialCore ? window.tutorialCore.totalSteps : 0}
â€¢ å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—: ${window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.completedSteps.length : 0}å€‹
â€¢ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.interactions : 0}å›

ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
${info.mode === '2d' ? 
'â€¢ "ğŸ”„ 3Dè©¦è¡Œ" ãƒœã‚¿ãƒ³ã§3Dãƒ¢ãƒ¼ãƒ‰ã‚’è©¦è¡Œã§ãã¾ã™' : 
'â€¢ 3Då¯è¦–åŒ–ãŒå‹•ä½œã—ã¦ã„ã¾ã™'}
${!info.hasCanvas2D ? 'â€¢ Canvas2Dæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“' : ''}
${!info.isThreeJSAvailable ? 'â€¢ 3Dæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“' : ''}
â€¢ "ğŸ§ª ãƒ†ã‚¹ãƒˆæç”»" ãƒœã‚¿ãƒ³ã§ã‚µãƒ³ãƒ—ãƒ«æç”»ã‚’ç¢ºèªã§ãã¾ã™
â€¢ "ğŸ—‘ï¸ ã‚¯ãƒªã‚¢" ãƒœã‚¿ãƒ³ã§ç”»é¢ã‚’ã‚¯ãƒªã‚¢ã§ãã¾ã™

ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:
â€¢ æç”»ã•ã‚Œãªã„å ´åˆ: "ğŸ§ª ãƒ†ã‚¹ãƒˆæç”»" ã‚’è©¦ã—ã¦ãã ã•ã„
â€¢ 3DãŒå‹•ä½œã—ãªã„å ´åˆ: ãƒ–ãƒ©ã‚¦ã‚¶ã§WebGLã‚’ç¢ºèªã—ã¦ãã ã•ã„
â€¢ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­¢ã¾ã£ãŸå ´åˆ: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„`;
            
            alert(detailedInfo);
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeIntegratedSystem);
        } else {
            initializeIntegratedSystem();
        }
        
        console.log('ğŸ¨ å®Œå…¨çµ±åˆç‰ˆã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>