Btn.addEventListener('click', function() {
                    if (window.integratedViz) {
                        window.integratedViz.testDraw();
                    }
                });
            }
            
            const systemInfoBtn = document.getElementById('showSystemInfo');
            if (systemInfoBtn) {
                systemInfoBtn.addEventListener('click', showDetailedSystemInfo);
            }

            // リサイズ対応
            window.addEventListener('resize', function() {
                if (window.integratedViz) {
                    window.integratedViz.handleResize();
                }
            });
        }

        // JSON実行
        function executeIntegratedJson() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const request = JSON.parse(jsonInput.value);
                
                // バリデーション
                if (!request.jsonrpc || request.jsonrpc !== "2.0") {
                    throw new Error("JSON-RPC 2.0形式ではありません");
                }
                if (!request.method) {
                    throw new Error("methodが指定されていません");
                }

                // シミュレーション応答
                const response = {
                    jsonrpc: "2.0",
                    result: {
                        success: true,
                        message: `${request.method} が正常に実行されました`,
                        timestamp: new Date().toISOString(),
                        visualizationMode: window.integratedViz ? window.integratedViz.mode : 'unknown'
                    },
                    id: request.id
                };
                
                jsonOutput.textContent = JSON.stringify(response, null, 2);
                jsonOutput.className = 'output-content success';
                
                // 可視化更新
                updateVisualizationFromJson(request);
                
                // インタラクション数増加
                if (window.tutorialCore) {
                    window.tutorialCore.progress.interactions++;
                }
                
            } catch (error) {
                const errorResponse = {
                    jsonrpc: "2.0",
                    error: {
                        code: -32700,
                        message: "Parse error",
                        data: error.message
                    },
                    id: null
                };
                
                jsonOutput.textContent = JSON.stringify(errorResponse, null, 2);
                jsonOutput.className = 'output-content error';
            }
        }

        // JSON検証
        function validateJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                
                const validations = [];
                
                if (parsed.jsonrpc !== "2.0") {
                    validations.push("⚠️ JSON-RPC 2.0ではありません");
                }
                
                if (!parsed.method) {
                    validations.push("❌ methodが指定されていません");
                }
                
                if (parsed.id === undefined) {
                    validations.push("⚠️ idが指定されていません");
                }
                
                const validMethods = [
                    'pokerinput_proposeSource',
                    'pokerinput_proposeBody', 
                    'pokerinput_proposeDetector',
                    'pokerinput_applyChanges'
                ];
                
                if (parsed.method && validMethods.indexOf(parsed.method) === -1) {
                    validations.push(`⚠️ 未知のmethod: ${parsed.method}`);
                }
                
                if (validations.length === 0) {
                    jsonOutput.textContent = '✅ JSON形式とschemaは正しいです';
                    jsonOutput.className = 'output-content success';
                } else {
                    jsonOutput.textContent = `検証結果:\n${validations.join('\n')}`;
                    jsonOutput.className = 'output-content warning';
                }
                
            } catch (error) {
                jsonOutput.textContent = `❌ JSON検証エラー: ${error.message}`;
                jsonOutput.className = 'output-content error';
            }
        }

        // JSONから可視化更新
        function updateVisualizationFromJson(request) {
            if (!window.integratedViz) return;
            
            const method = request.method;
            const params = request.params;
            
            try {
                if (method === 'pokerinput_proposeSource' && params) {
                    const position = params.position ? params.position.split(' ').map(Number) : [0, 0, 0];
                    const nuclide = params.inventory && params.inventory[0] ? params.inventory[0].nuclide : 'Unknown';
                    const activity = params.inventory && params.inventory[0] ? params.inventory[0].radioactivity : 0;
                    
                    window.integratedViz.addRadiationSource(params.name, position, nuclide, activity);
                    
                } else if (method === 'pokerinput_proposeBody' && params) {
                    const center = params.center ? params.center.split(' ').map(Number) : [0, 0, 0];
                    const parameters = { center: center, radius: params.radius };
                    
                    window.integratedViz.addShield(params.name, params.type, parameters, 'CONCRETE');
                    
                } else if (method === 'pokerinput_proposeDetector' && params) {
                    const origin = params.origin ? params.origin.split(' ').map(Number) : [0, 0, 0];
                    
                    window.integratedViz.addDetector(params.name, origin, params.grid || []);
                }
                
            } catch (error) {
                console.error('可視化更新エラー:', error);
                if (window.integratedViz) {
                    window.integratedViz.showMessage(`可視化更新エラー: ${error.message}`, 'error');
                }
            }
        }

        // 詳細システム情報表示
        function showDetailedSystemInfo() {
            const info = window.integratedViz ? window.integratedViz.getDiagnosticInfo() : {};
            
            const detailedInfo = `=== 統合3D/2D可視化システム情報 ===

📊 現在の状態:
• 可視化モード: ${info.mode ? info.mode.toUpperCase() : 'Unknown'}
• Canvas2D: ${info.hasCanvas2D ? '✅ 利用可能' : '❌ 利用不可'}
• 3D機能: ${info.isThreeJSAvailable ? '✅ 利用可能' : '❌ 利用不可'}
• アニメーション: ${info.isAnimating ? '✅ 動作中' : '⏸️ 停止中'}

🎨 可視化オブジェクト:
• 線源: ${info.sources || 0}個
• 遮蔽体: ${info.shields || 0}個  
• 検出器: ${info.detectors || 0}個

🖼️ Canvas情報:
• サイズ: ${info.canvasSize ? info.canvasSize.width : 0} x ${info.canvasSize ? info.canvasSize.height : 0}
• アニメーション時間: ${info.animationTime || 0}ms

🌐 環境情報:
• ブラウザ: ${navigator.userAgent.split(' ')[0]}
• プラットフォーム: ${navigator.platform}
• オンライン: ${navigator.onLine ? 'Yes' : 'No'}
• プロトコル: ${window.location.protocol}

📈 学習進捗:
• 現在のステップ: ${window.tutorialCore ? window.tutorialCore.currentStep : 0} / ${window.tutorialCore ? window.tutorialCore.totalSteps : 0}
• 完了ステップ: ${window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.completedSteps.length : 0}個
• インタラクション数: ${window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.interactions : 0}回

💡 推奨アクション:
${info.mode === '2d' ? 
'• "🔄 3D試行" ボタンで3Dモードを試行できます' : 
'• 3D可視化が動作しています'}
${!info.hasCanvas2D ? '• Canvas2D機能が利用できません' : ''}
${!info.isThreeJSAvailable ? '• 3D機能が利用できません' : ''}
• "🧪 テスト描画" ボタンでサンプル描画を確認できます
• "🗑️ クリア" ボタンで画面をクリアできます

🔧 トラブルシューティング:
• 描画されない場合: "🧪 テスト描画" を試してください
• 3Dが動作しない場合: ブラウザでWebGLを確認してください
• アニメーションが止まった場合: ページを再読み込みしてください`;
            
            alert(detailedInfo);
        }

        // 初期化実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeIntegratedSystem);
        } else {
            initializeIntegratedSystem();
        }
        
        console.log('🎨 完全統合版システム読み込み完了');
    </script>
</body>
</html>