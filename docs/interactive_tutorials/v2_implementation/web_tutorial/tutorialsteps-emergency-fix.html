<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>🚨 tutorialSteps読み込み失敗 緊急修復システム</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #fff5f5; }
        .critical-panel { margin: 15px 0; padding: 20px; background: white; border-radius: 8px; border: 3px solid #e53e3e; }
        .result-panel { margin: 10px 0; padding: 12px; border-radius: 6px; }
        .error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .success { background: #c6f6d5; border: 1px solid #68d391; color: #22543d; }
        .warning { background: #faf089; border: 1px solid #f6e05e; color: #744210; }
        .info { background: #bee3f8; border: 1px solid #90cdf4; color: #2a4365; }
        .critical { background: #fed7d7; border: 2px solid #e53e3e; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-critical { background: #e53e3e; color: white; font-size: 16px; }
        .btn-fix { background: #38a169; color: white; }
        .btn-test { background: #3182ce; color: white; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🚨 tutorialSteps読み込み失敗 緊急修復システム</h1>
    
    <div class="critical-panel">
        <h2>⚠️ クリティカルエラー: tutorialStepsが利用できません</h2>
        <p><strong>問題:</strong> steps.jsonの読み込み失敗またはTutorialクラス初期化問題</p>
        <p><strong>影響:</strong> すべてのステップ進行が不可能</p>
        
        <button onclick="emergencyDataCheck()" class="btn-critical">🔍 データ読み込み緊急確認</button>
        <button onclick="directStepsLoad()" class="btn-fix">📂 steps.json直接読み込み</button>
        <button onclick="tutorialRebuild()" class="btn-fix">🔄 Tutorial完全再構築</button>
        <button onclick="manualDataInjection()" class="btn-test">⚡ 手動データ注入</button>
    </div>

    <div id="diagnosticResults"></div>

    <script src="physics-validator.js"></script>
    <script src="cross-section-visualizer.js"></script>
    <script src="tutorial.js"></script>

    <script>
        let resultsDiv = document.getElementById('diagnosticResults');

        function addResult(title, type, message, details = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-panel ${type}`;
            resultDiv.innerHTML = `
                <h3>${getIcon(type)} ${title}</h3>
                <p><strong>結果:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
                <small>確認時刻: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return '✅';
                case 'error': return '❌';
                case 'warning': return '⚠️';
                case 'critical': return '🚨';
                default: return 'ℹ️';
            }
        }

        async function emergencyDataCheck() {
            resultsDiv.innerHTML = '';
            console.log('🚨 データ読み込み緊急確認開始...');

            // 1. window.tutorialの存在確認
            checkTutorialObject();
            
            // 2. steps.jsonファイルの直接確認
            await checkStepsJsonFile();
            
            // 3. ネットワーク状況確認
            await checkNetworkStatus();
            
            // 4. ブラウザキャッシュ状況確認
            checkCacheStatus();
            
            // 5. JavaScript読み込み状況確認
            checkScriptLoadStatus();
        }

        function checkTutorialObject() {
            try {
                console.log('🔍 window.tutorial確認開始...');
                
                const tutorialInfo = {
                    exists: !!window.tutorial,
                    type: typeof window.tutorial,
                    constructor: window.tutorial?.constructor?.name,
                    hasTutorialSteps: !!window.tutorial?.tutorialSteps,
                    tutorialStepsType: typeof window.tutorial?.tutorialSteps,
                    tutorialStepsLength: window.tutorial?.tutorialSteps?.length,
                    currentStep: window.tutorial?.currentStep,
                    totalSteps: window.tutorial?.totalSteps,
                    hasLoadTutorialData: typeof window.tutorial?.loadTutorialData === 'function'
                };

                if (window.tutorial) {
                    if (window.tutorial.tutorialSteps && Array.isArray(window.tutorial.tutorialSteps)) {
                        addResult('Tutorial オブジェクト確認', 'success',
                            'Tutorialオブジェクトは存在し、tutorialStepsも利用可能です',
                            `詳細:\n${JSON.stringify(tutorialInfo, null, 2)}`
                        );
                    } else {
                        addResult('Tutorial オブジェクト確認', 'warning',
                            'Tutorialオブジェクトは存在しますが、tutorialStepsが未初期化です',
                            `詳細:\n${JSON.stringify(tutorialInfo, null, 2)}`
                        );
                    }
                } else {
                    addResult('Tutorial オブジェクト確認', 'critical',
                        'window.tutorialオブジェクトが存在しません',
                        `詳細:\n${JSON.stringify(tutorialInfo, null, 2)}`
                    );
                }

            } catch (error) {
                addResult('Tutorial オブジェクト確認', 'error', 
                    `確認エラー: ${error.message}`, 
                    error.stack
                );
            }
        }

        async function checkStepsJsonFile() {
            try {
                console.log('📂 steps.json直接確認開始...');
                
                const startTime = Date.now();
                const response = await fetch('steps.json');
                const loadTime = Date.now() - startTime;
                
                const fileInfo = {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: {
                        contentType: response.headers.get('Content-Type'),
                        contentLength: response.headers.get('Content-Length'),
                        lastModified: response.headers.get('Last-Modified')
                    },
                    loadTimeMs: loadTime,
                    url: response.url
                };

                if (response.ok) {
                    const rawText = await response.text();
                    
                    let jsonParseInfo = {};
                    try {
                        const jsonData = JSON.parse(rawText);
                        jsonParseInfo = {
                            parseSuccess: true,
                            isArray: Array.isArray(jsonData),
                            length: Array.isArray(jsonData) ? jsonData.length : 'N/A',
                            firstItem: Array.isArray(jsonData) && jsonData.length > 0 ? {
                                step: jsonData[0]?.step,
                                title: jsonData[0]?.title?.substring(0, 30)
                            } : null,
                            allStepNumbers: Array.isArray(jsonData) ? jsonData.map(s => s?.step) : []
                        };
                    } catch (parseError) {
                        jsonParseInfo = {
                            parseSuccess: false,
                            parseError: parseError.message,
                            rawTextLength: rawText.length,
                            rawTextPreview: rawText.substring(0, 100)
                        };
                    }

                    addResult('steps.json ファイル確認', 
                        jsonParseInfo.parseSuccess ? 'success' : 'error',
                        jsonParseInfo.parseSuccess ? 
                            `steps.jsonファイルは正常に読み込めます（${jsonParseInfo.length}ステップ）` :
                            'steps.jsonファイルの読み込みはできますがJSON解析に失敗',
                        `ファイル情報:\n${JSON.stringify(fileInfo, null, 2)}\n\nJSON解析:\n${JSON.stringify(jsonParseInfo, null, 2)}`
                    );

                } else {
                    addResult('steps.json ファイル確認', 'error',
                        `steps.jsonファイルの読み込みに失敗: ${response.status} ${response.statusText}`,
                        `ファイル情報:\n${JSON.stringify(fileInfo, null, 2)}`
                    );
                }

            } catch (error) {
                addResult('steps.json ファイル確認', 'critical',
                    `steps.json読み込みでネットワークエラー: ${error.message}`,
                    error.stack
                );
            }
        }

        async function checkNetworkStatus() {
            try {
                console.log('🌐 ネットワーク状況確認開始...');
                
                const networkInfo = {
                    onLine: navigator.onLine,
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt
                    } : 'データなし'
                };

                // 簡単な接続テスト
                const testUrls = [
                    'steps.json',
                    'tutorial.js',
                    'index.html'
                ];

                const testResults = [];
                for (const url of testUrls) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch(url, { method: 'HEAD' });
                        const loadTime = Date.now() - startTime;
                        
                        testResults.push({
                            url: url,
                            success: response.ok,
                            status: response.status,
                            loadTimeMs: loadTime
                        });
                    } catch (error) {
                        testResults.push({
                            url: url,
                            success: false,
                            error: error.message
                        });
                    }
                }

                const allTestsPassed = testResults.every(t => t.success);

                addResult('ネットワーク状況確認', 
                    allTestsPassed ? 'success' : 'warning',
                    allTestsPassed ? 
                        'ネットワーク接続は正常です' : 
                        'ネットワーク接続に問題がある可能性があります',
                    `ネットワーク情報:\n${JSON.stringify(networkInfo, null, 2)}\n\n接続テスト:\n${JSON.stringify(testResults, null, 2)}`
                );

            } catch (error) {
                addResult('ネットワーク状況確認', 'error',
                    `ネットワーク確認エラー: ${error.message}`,
                    error.stack
                );
            }
        }

        function checkCacheStatus() {
            try {
                console.log('💾 キャッシュ状況確認開始...');
                
                const cacheInfo = {
                    performance: performance ? {
                        navigation: performance.navigation ? {
                            type: performance.navigation.type,
                            redirectCount: performance.navigation.redirectCount
                        } : 'データなし',
                        timing: performance.timing ? {
                            domainLookupStart: performance.timing.domainLookupStart,
                            connectStart: performance.timing.connectStart,
                            requestStart: performance.timing.requestStart,
                            responseStart: performance.timing.responseStart,
                            domContentLoadedEventStart: performance.timing.domContentLoadedEventStart
                        } : 'データなし'
                    } : 'Performance APIなし',
                    localStorage: {
                        available: typeof Storage !== 'undefined',
                        itemsCount: localStorage ? localStorage.length : 'N/A'
                    },
                    sessionStorage: {
                        available: typeof sessionStorage !== 'undefined',
                        itemsCount: sessionStorage ? sessionStorage.length : 'N/A'
                    }
                };

                addResult('キャッシュ状況確認', 'info',
                    'キャッシュ・ストレージ状況を確認しました',
                    `キャッシュ情報:\n${JSON.stringify(cacheInfo, null, 2)}`
                );

            } catch (error) {
                addResult('キャッシュ状況確認', 'warning',
                    `キャッシュ確認エラー: ${error.message}`,
                    error.stack
                );
            }
        }

        function checkScriptLoadStatus() {
            try {
                console.log('📜 JavaScript読み込み状況確認開始...');
                
                const scripts = document.querySelectorAll('script');
                const scriptInfo = Array.from(scripts).map(script => ({
                    src: script.src || 'inline',
                    type: script.type || 'text/javascript',
                    loaded: script.src ? 'unknown' : 'inline'
                }));

                const requiredClasses = [
                    { name: 'Tutorial', exists: typeof Tutorial !== 'undefined' },
                    { name: 'PhysicsValidator', exists: typeof PhysicsValidator !== 'undefined' },
                    { name: 'CrossSectionVisualizer', exists: typeof CrossSectionVisualizer !== 'undefined' }
                ];

                const loadStatus = {
                    totalScripts: scripts.length,
                    scriptDetails: scriptInfo,
                    requiredClasses: requiredClasses,
                    tutorialJsLoaded: scriptInfo.some(s => s.src.includes('tutorial.js')),
                    allRequiredClassesAvailable: requiredClasses.every(c => c.exists)
                };

                addResult('JavaScript読み込み状況', 
                    loadStatus.allRequiredClassesAvailable ? 'success' : 'warning',
                    loadStatus.allRequiredClassesAvailable ? 
                        'JavaScript読み込みは正常です' : 
                        '必要なJavaScriptクラスの一部が読み込まれていません',
                    `読み込み状況:\n${JSON.stringify(loadStatus, null, 2)}`
                );

            } catch (error) {
                addResult('JavaScript読み込み状況', 'error',
                    `JavaScript確認エラー: ${error.message}`,
                    error.stack
                );
            }
        }

        async function directStepsLoad() {
            console.log('📂 steps.json直接読み込み開始...');
            
            try {
                const response = await fetch('steps.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const stepsData = await response.json();
                
                // グローバル変数として保存
                window.emergencyStepsData = stepsData;
                
                const loadInfo = {
                    success: true,
                    dataLength: stepsData.length,
                    stepNumbers: stepsData.map(s => s?.step),
                    allStepsValid: stepsData.every(s => s.step && s.title && s.template),
                    step1: stepsData.find(s => s.step === 1)?.title,
                    step4: stepsData.find(s => s.step === 4)?.title
                };

                addResult('直接読み込み', 'success',
                    `steps.jsonの直接読み込みに成功しました（${stepsData.length}ステップ）`,
                    `読み込み結果:\n${JSON.stringify(loadInfo, null, 2)}\n\nデータはwindow.emergencyStepsDataに保存されました`
                );

                // Tutorialオブジェクトに注入
                if (window.tutorial) {
                    window.tutorial.tutorialSteps = stepsData;
                    addResult('データ注入', 'success',
                        'tutorialオブジェクトにデータを注入しました',
                        `tutorial.tutorialSteps.length: ${window.tutorial.tutorialSteps.length}`
                    );
                }

            } catch (error) {
                addResult('直接読み込み', 'error',
                    `直接読み込みに失敗: ${error.message}`,
                    error.stack
                );
            }
        }

        function tutorialRebuild() {
            console.log('🔄 Tutorial完全再構築開始...');
            
            try {
                // 既存のtutorialオブジェクトをクリア
                if (window.tutorial) {
                    delete window.tutorial;
                }
                
                // Tutorialクラスが利用可能かチェック
                if (typeof Tutorial === 'undefined') {
                    addResult('Tutorial再構築', 'error',
                        'Tutorialクラスが利用できません。tutorial.jsの読み込みを確認してください'
                    );
                    return;
                }
                
                // 新しいTutorialインスタンスを作成
                window.tutorial = new Tutorial();
                
                setTimeout(async () => {
                    try {
                        // データを強制読み込み
                        await window.tutorial.loadTutorialData();
                        
                        const rebuildResult = {
                            tutorialExists: !!window.tutorial,
                            tutorialStepsExists: !!window.tutorial.tutorialSteps,
                            tutorialStepsLength: window.tutorial.tutorialSteps?.length,
                            currentStep: window.tutorial.currentStep,
                            totalSteps: window.tutorial.totalSteps,
                            initializationComplete: true
                        };

                        if (window.tutorial.tutorialSteps && window.tutorial.tutorialSteps.length > 0) {
                            addResult('Tutorial再構築', 'success',
                                'Tutorialオブジェクトの完全再構築に成功しました',
                                `再構築結果:\n${JSON.stringify(rebuildResult, null, 2)}`
                            );
                            
                            // 初期化も実行
                            window.tutorial.initializeFirstStep();
                            
                            addResult('初期化実行', 'success', 'Step 1の初期化が完了しました');
                            
                        } else {
                            addResult('Tutorial再構築', 'warning',
                                'Tutorialオブジェクトは作成されましたが、データ読み込みに問題があります',
                                `再構築結果:\n${JSON.stringify(rebuildResult, null, 2)}`
                            );
                        }

                    } catch (error) {
                        addResult('Tutorial再構築', 'error',
                            `データ読み込みエラー: ${error.message}`,
                            error.stack
                        );
                    }
                }, 1000);

            } catch (error) {
                addResult('Tutorial再構築', 'error',
                    `再構築エラー: ${error.message}`,
                    error.stack
                );
            }
        }

        function manualDataInjection() {
            console.log('⚡ 手動データ注入開始...');
            
            const manualStepsData = [
                {
                    "step": 1,
                    "title": "基本的なCo-60線源の作成",
                    "physics_background": "Co-60は医療用γ線源として広く使用されており、1.17MeVと1.33MeVの特性γ線を放出します。",
                    "instructions": "医療用Co-60線源を原点（0,0,0）に配置するJSONリクエストを作成してください。",
                    "template": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"pokerinput_proposeSource\",\n  \"params\": {\n    \"name\": \"co60_medical\",\n    \"type\": \"POINT\",\n    \"position\": \"0 0 0\",\n    \"inventory\": [\n      {\n        \"nuclide\": \"Co60\",\n        \"radioactivity\": 37000000000\n      }\n    ]\n  }\n}",
                    "achievement": "線源作成マスター",
                    "completion_message": "素晴らしいです！Co-60線源の作成が完了しました。",
                    "next_step_preview": "次は、この線源を遮蔽するためのコンクリート球殻を作成します。"
                },
                {
                    "step": 2,
                    "title": "コンクリート遮蔽体の作成",
                    "physics_background": "コンクリートは放射線遮蔽材として最も一般的な材料です。",
                    "instructions": "線源を囲むコンクリート球殻を作成してください。",
                    "template": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"pokerinput_proposeBody\",\n  \"params\": {\n    \"name\": \"concrete_shield\",\n    \"type\": \"SPH\",\n    \"center\": \"0 0 0\",\n    \"radius\": 50\n  }\n}",
                    "achievement": "遮蔽設計エンジニア",
                    "completion_message": "優秀です！コンクリート遮蔽体の作成が完了しました。",
                    "next_step_preview": "次は、遮蔽効果を測定するための検出器を配置します。"
                },
                {
                    "step": 3,
                    "title": "線量率検出器の配置",
                    "physics_background": "線量率は距離の二乗に反比例して減少します。",
                    "instructions": "遮蔽体の外側に検出器を配置し、線量率の空間分布を測定します。",
                    "template": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"pokerinput_proposeDetector\",\n  \"params\": {\n    \"name\": \"dose_survey\",\n    \"origin\": \"60 0 0\",\n    \"grid\": [\n      {\n        \"edge\": \"10 0 0\",\n        \"number\": 10\n      }\n    ]\n  }\n}",
                    "achievement": "線量測定スペシャリスト",
                    "completion_message": "素晴らしいです！検出器配置が完了しました。",
                    "next_step_preview": "次は、より効果的な鉛遮蔽体を追加して複合遮蔽を学習します。"
                },
                {
                    "step": 4,
                    "title": "複合遮蔽の最適化設計",
                    "physics_background": "鉛（密度11.3 g/cm³）はγ線遮蔽に極めて効果的です。",
                    "instructions": "コンクリート球の内側に薄い鉛層を追加して複合遮蔽を作成します。",
                    "template": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"pokerinput_proposeBody\",\n  \"params\": {\n    \"name\": \"lead_inner_shield\",\n    \"type\": \"SPH\",\n    \"center\": \"0 0 0\",\n    \"radius\": 18\n  }\n}",
                    "achievement": "遮蔽最適化マスター",
                    "completion_message": "卓越した成果です！複合遮蔽の設計が完了しました。",
                    "next_step_preview": "最後に、全ての変更をYAMLファイルに適用します。"
                },
                {
                    "step": 5,
                    "title": "実用統合とデータ管理",
                    "physics_background": "設計した遮蔽システムを実際の計算で使用するには、YAMLファイルに保存する必要があります。",
                    "instructions": "これまで作成した全ての要素をYAMLファイルに保存します。",
                    "template": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"pokerinput_applyChanges\",\n  \"params\": {\n    \"backup_comment\": \"Interactive Tutorial Completion - Co60 shielding design\"\n  }\n}",
                    "achievement": "放射線遮蔽研究マスター",
                    "completion_message": "🎉 おめでとうございます！インタラクティブチュートリアルを完全制覇されました。"
                }
            ];

            try {
                // グローバル変数として保存
                window.manualStepsData = manualStepsData;
                
                // Tutorialオブジェクトが存在する場合は注入
                if (window.tutorial) {
                    window.tutorial.tutorialSteps = manualStepsData;
                    window.tutorial.totalSteps = 5;
                    
                    // Step 1に初期化
                    window.tutorial.currentStep = 1;
                    window.tutorial.updateStepContent();
                    window.tutorial.resetCode();
                    window.tutorial.updateProgress();
                    
                    addResult('手動データ注入', 'success',
                        'ハードコードされたステップデータの注入に成功しました',
                        `注入結果:\n- tutorialSteps.length: ${window.tutorial.tutorialSteps.length}\n- currentStep: ${window.tutorial.currentStep}\n- totalSteps: ${window.tutorial.totalSteps}`
                    );
                    
                } else {
                    addResult('手動データ注入', 'warning',
                        'データは注入されましたが、tutorialオブジェクトが存在しません',
                        'データはwindow.manualStepsDataに保存されました'
                    );
                }

            } catch (error) {
                addResult('手動データ注入', 'error',
                    `手動注入エラー: ${error.message}`,
                    error.stack
                );
            }
        }

        // 初期状態確認
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('システム初期化', 'info', 
                    'tutorialSteps修復システムが初期化されました',
                    `window.tutorial存在: ${!!window.tutorial}\ntutorialSteps存在: ${!!window.tutorial?.tutorialSteps}`
                );
            }, 1000);
        });
    </script>
</body>
</html>