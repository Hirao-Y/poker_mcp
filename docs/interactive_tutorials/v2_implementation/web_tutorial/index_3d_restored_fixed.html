<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ Poker MCP 3Då¯è¦–åŒ–ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« - å¾©æ—§ç‰ˆ</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¨ æ”¾å°„ç·šé®è”½è¨ˆç®— 3Då¯è¦–åŒ–ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« - å¾©æ—§ç‰ˆ</h1>
            <p>Co-60ç·šæºã‚’ä½¿ç”¨ã—ãŸåŒ»ç™‚æ–½è¨­é®è”½è¨­è¨ˆã®å­¦ç¿’ï¼ˆ3D/2D ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ ï¼‰</p>
        </header>

        <main>
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="progress-text" id="progressText">Step 1 / 5</span>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
            <div class="system-status">
                <span id="systemMode" class="status-badge">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</span>
                <span id="threejsStatus" class="status-badge">Three.js: ç¢ºèªä¸­</span>
                <span id="webglStatus" class="status-badge">WebGL: ç¢ºèªä¸­</span>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="content-area" id="contentArea">
                <div class="step-content">
                    <h2>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</h2>
                    <p>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰3D/2Då¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚</p>
                </div>
            </div>

            <!-- å¯è¦–åŒ–ã‚¨ãƒªã‚¢ -->
            <div class="visualization-area">
                <div class="viz-header">
                    <h4>ğŸ¨ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ 3D/2D å¯è¦–åŒ–</h4>
                    <div class="viz-controls">
                        <button id="toggle3DMode" class="viz-btn">ğŸ”„ 3Dåˆ‡æ›¿</button>
                        <button id="toggle2DMode" class="viz-btn">ğŸ“Š 2Dåˆ‡æ›¿</button>
                        <button id="autoUpgrade" class="viz-btn">âš¡ è‡ªå‹•å‡çº§</button>
                        <button id="showSystemInfo" class="viz-btn">ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</button>
                        <button id="captureView" class="viz-btn">ğŸ“· ç”»é¢ä¿å­˜</button>
                    </div>
                </div>
                
                <canvas id="geometryCanvas" width="400" height="300">
                    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Canvasè¦ç´ ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </canvas>
                
                <div id="visualizationMessage" class="viz-message">
                    ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
                </div>
                
                <div id="modeInfo" class="mode-info">
                    <div id="currentModeDisplay">ãƒ¢ãƒ¼ãƒ‰: ç¢ºèªä¸­</div>
                    <div id="capabilitiesDisplay">æ©Ÿèƒ½: åˆæœŸåŒ–ä¸­</div>
                </div>
            </div>

            <!-- JSONå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-section">
                <h3>ğŸ“ JSON-RPC 2.0 å…¥åŠ›</h3>
                <textarea id="jsonInput" placeholder="JSON-RPC 2.0 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="8"></textarea>
                <div class="button-group">
                    <button id="executeJson" class="primary-btn">ğŸš€ å®Ÿè¡Œ</button>
                    <button id="clearJson" class="secondary-btn">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    <button id="validateJson" class="secondary-btn">âœ… æ¤œè¨¼</button>
                    <button id="prettifyJson" class="secondary-btn">ğŸ¨ æ•´å½¢</button>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="output-section">
                <h3>ğŸ“Š å®Ÿè¡Œçµæœ</h3>
                <pre id="jsonOutput" class="output-content">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
            </div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="navigation">
                <button id="prevStep" class="nav-btn secondary-btn" disabled>â¬…ï¸ å‰ã®ã‚¹ãƒ†ãƒƒãƒ—</button>
                <button id="nextStep" class="nav-btn primary-btn">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â¡ï¸</button>
                <button id="resetTutorial" class="nav-btn secondary-btn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="exportProgress" class="nav-btn secondary-btn">ğŸ’¾ é€²æ—ä¿å­˜</button>
            </div>
        </main>

        <footer>
            <p>ğŸ“ Poker MCP Tutorial System v3.0 - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰3D/2Då¯è¦–åŒ–å¯¾å¿œç‰ˆ</p>
        </footer>
    </div>

    <!-- 3Då¾©æ—§ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="local-threejs-manager.js"></script>
    <script src="hybrid-visualization.js"></script>
    
    <script>
        // 3Då¾©æ—§ç‰ˆãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ 3Då¾©æ—§ç‰ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.tutorialCore = null;
        window.hybridViz = null;
        
        // ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿
        const tutorialSteps = [
            {
                title: "Step 1: Co-60ç·šæºã®è¨­å®š",
                content: "åŒ»ç™‚ç”¨Co-60ç·šæºã‚’åŸç‚¹ã«é…ç½®ã—ã€3Dç©ºé–“ã§ã®æ”¾å°„ç·šæºã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚",
                learning: "æ”¾å°„ç·šæºã®åŸºæœ¬æ¦‚å¿µã¨3Dè¡¨ç¤ºã§ã®ç›´æ„Ÿçš„ç†è§£ã‚’å­¦ç¿’ã—ã¾ã™ã€‚",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeSource",
  "params": {
    "name": "co60_medical",
    "type": "POINT",
    "position": "0 0 0",
    "inventory": [
      {
        "nuclide": "Co60",
        "radioactivity": 37000000000
      }
    ]
  },
  "id": 1
}`
            },
            {
                title: "Step 2: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé®è”½ä½“",
                content: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆçƒå½¢é®è”½ä½“ã‚’è¿½åŠ ã—ã€æ”¾å°„ç·šé®è”½ã®åŸºæœ¬æ§‹é€ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚",
                learning: "é®è”½ä½“ã®3Då½¢çŠ¶ã¨ææ–™ç‰¹æ€§ã‚’è¦–è¦šçš„ã«ç†è§£ã—ã¾ã™ã€‚",
                jsonTemplate: `{
  "jsonrpc": "2.0", 
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "concrete_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 50
  },
  "id": 2
}`
            },
            {
                title: "Step 3: æ¤œå‡ºå™¨é…ç½®", 
                content: "ç·šé‡ç‡æ¸¬å®šç”¨æ¤œå‡ºå™¨ã‚¢ãƒ¬ã‚¤ã‚’é…ç½®ã—ã€é®è”½åŠ¹æœã®æ¸¬å®šç³»ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚",
                learning: "æ¤œå‡ºå™¨é…ç½®ã¨ç·šé‡ç‡åˆ†å¸ƒã®3Då¯è¦–åŒ–ã‚’å­¦ç¿’ã—ã¾ã™ã€‚",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeDetector", 
  "params": {
    "name": "dose_survey",
    "origin": "60 0 0",
    "grid": [{"edge": "10 0 0", "number": 10}]
  },
  "id": 3
}`
            },
            {
                title: "Step 4: é‰›é®è”½è¿½åŠ ",
                content: "å†…å´ã«é‰›é®è”½çƒã‚’è¿½åŠ ã—ã€è¤‡åˆé®è”½æ§‹é€ ã‚’å®Œæˆã•ã›ã¾ã™ã€‚",
                learning: "è¤‡åˆææ–™ã«ã‚ˆã‚‹é«˜åŠ¹ç‡é®è”½è¨­è¨ˆã®3Dç†è§£ã‚’æ·±ã‚ã¾ã™ã€‚",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "lead_inner_shield", 
    "type": "SPH",
    "center": "0 0 0",
    "radius": 18
  },
  "id": 4
}`
            },
            {
                title: "Step 5: å®Œæˆãƒ»ä¿å­˜",
                content: "é®è”½è¨­è¨ˆã‚’å®Œæˆã•ã›ã€è¨ˆç®—çµæœã‚’ä¿å­˜ã—ã¾ã™ã€‚",
                learning: "å®Ÿç”¨çš„ãªé®è”½è¨­è¨ˆã®å®Œæˆã¨å®Ÿå‹™ã¸ã®å¿œç”¨æ–¹æ³•ã‚’å­¦ç¿’ã—ã¾ã™ã€‚",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_applyChanges", 
  "params": {
    "backup_comment": "Medical Co-60 shielding design completed with hybrid 3D visualization"
  },
  "id": 5
}`
            }
        ];

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚³ã‚¢
        class Enhanced3DTutorialCore {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = tutorialSteps.length;
                this.steps = tutorialSteps;
                this.progress = {
                    completedSteps: [],
                    startTime: Date.now(),
                    interactions: 0
                };
                
                console.log('âœ… Enhanced3DTutorialCoreåˆæœŸåŒ–å®Œäº†');
            }
            
            getCurrentStep() {
                return this.steps[this.currentStep - 1];
            }
            
            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    this.progress.completedSteps.push(this.currentStep);
                    this.currentStep++;
                    this.updateUI();
                    this.updateVisualization();
                    return true;
                }
                return false;
            }
            
            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.progress.completedSteps = this.progress.completedSteps.filter(s => s < this.currentStep);
                    this.updateUI();
                    this.updateVisualization();
                    return true;
                }
                return false;
            }
            
            updateUI() {
                const step = this.getCurrentStep();
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                if (progressFill) {
                    progressFill.style.width = Math.round((this.currentStep / this.totalSteps) * 100) + '%';
                }
                if (progressText) {
                    progressText.textContent = 'Step ' + this.currentStep + ' / ' + this.totalSteps;
                }
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
                const contentArea = document.getElementById('contentArea');
                if (contentArea && step) {
                    const stepHTML = '<div class="step-content">' +
                        '<h2>' + step.title + '</h2>' +
                        '<div class="step-description">' +
                        '<p><strong>æ¦‚è¦:</strong> ' + step.content + '</p>' +
                        '<p><strong>å­¦ç¿’ç›®æ¨™:</strong> ' + step.learning + '</p>' +
                        '</div>' +
                        '</div>';
                    contentArea.innerHTML = stepHTML;
                }
                
                // JSONå…¥åŠ›æ›´æ–°
                const jsonInput = document.getElementById('jsonInput');
                if (jsonInput && step.jsonTemplate) {
                    jsonInput.value = step.jsonTemplate;
                }
                
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³æ›´æ–°
                const prevBtn = document.getElementById('prevStep');
                const nextBtn = document.getElementById('nextStep');
                if (prevBtn) {
                    prevBtn.disabled = this.currentStep === 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = this.currentStep === this.totalSteps;
                    nextBtn.textContent = this.currentStep === this.totalSteps ? 'ğŸ‰ å®Œäº†' : 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â¡ï¸';
                }
                
                console.log('ğŸ“ Step ' + this.currentStep + ' ã«æ›´æ–°');
            }
            
            updateVisualization() {
                if (!window.hybridViz) return;
                
                // æ—¢å­˜è¦ç´ ã‚’ã‚¯ãƒªã‚¢
                window.hybridViz.clearAll();
                
                // ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ãŸå¯è¦–åŒ–æ›´æ–°
                if (this.currentStep >= 1) {
                    window.hybridViz.addRadiationSource('co60_medical', [0, 0, 0], 'Co60', 37000000000);
                }
                
                if (this.currentStep >= 2) {
                    window.hybridViz.addShield('concrete_shield', 'SPH', { center: [0, 0, 0], radius: 50 }, 'CONCRETE');
                }
                
                if (this.currentStep >= 3) {
                    window.hybridViz.addDetector('dose_survey', [60, 0, 0], [{ edge: [10, 0, 0], number: 10 }]);
                }
                
                if (this.currentStep >= 4) {
                    window.hybridViz.addShield('lead_inner_shield', 'SPH', { center: [0, 0, 0], radius: 18 }, 'LEAD');
                }
            }
            
            reset() {
                this.currentStep = 1;
                this.progress.completedSteps = [];
                this.progress.interactions = 0;
                if (window.hybridViz) {
                    window.hybridViz.clearAll();
                }
                this.updateUI();
                this.updateVisualization();
                console.log('ğŸ”„ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ');
            }
            
            exportProgress() {
                const progressData = {
                    currentStep: this.currentStep,
                    completedSteps: this.progress.completedSteps,
                    startTime: this.progress.startTime,
                    duration: Date.now() - this.progress.startTime,
                    interactions: this.progress.interactions,
                    systemInfo: window.hybridViz ? window.hybridViz.getDiagnosticInfo() : null,
                    timestamp: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(progressData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'tutorial_progress_' + Date.now() + '.json';
                link.click();
                
                URL.revokeObjectURL(url);
                console.log('ğŸ’¾ å­¦ç¿’é€²æ—ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeEnhancedSystem() {
            console.log('ğŸš€ æ‹¡å¼µã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
            
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                updateSystemStatus('åˆæœŸåŒ–ä¸­...', 'ç¢ºèªä¸­', 'ç¢ºèªä¸­');
                
                // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚³ã‚¢åˆæœŸåŒ–
                window.tutorialCore = new Enhanced3DTutorialCore();
                
                // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                console.log('ğŸ¨ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
                window.hybridViz = new HybridVisualizationSystem('geometryCanvas');
                
                // UIã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setupEnhancedEventListeners();
                
                // åˆæœŸè¡¨ç¤º
                window.tutorialCore.updateUI();
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°ã‚’å®šæœŸå®Ÿè¡Œ
                setInterval(updateSystemStatuses, 2000);
                
                console.log('âœ… æ‹¡å¼µã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ æ‹¡å¼µã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateSystemStatus('åˆæœŸåŒ–å¤±æ•—', 'ã‚¨ãƒ©ãƒ¼', 'ã‚¨ãƒ©ãƒ¼');
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                const messageEl = document.getElementById('visualizationMessage');
                if (messageEl) {
                    messageEl.textContent = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                    messageEl.style.color = '#dc3545';
                }
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSystemStatus(mode, threejs, webgl) {
            const systemMode = document.getElementById('systemMode');
            const threejsStatus = document.getElementById('threejsStatus');
            const webglStatus = document.getElementById('webglStatus');
            
            if (systemMode) systemMode.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ' + mode;
            if (threejsStatus) threejsStatus.textContent = 'Three.js: ' + threejs;
            if (webglStatus) webglStatus.textContent = 'WebGL: ' + webgl;
        }

        // å‹•çš„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSystemStatuses() {
            if (window.hybridViz) {
                const info = window.hybridViz.getDiagnosticInfo();
                const mode = info.mode ? info.mode.toUpperCase() : 'Unknown';
                const threejs = info.threeJS ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ åˆ©ç”¨ä¸å¯';
                const webgl = info.webGL ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ åˆ©ç”¨ä¸å¯';
                
                updateSystemStatus(mode, threejs, webgl);
                
                // ãƒ¢ãƒ¼ãƒ‰æƒ…å ±æ›´æ–°
                const currentModeDisplay = document.getElementById('currentModeDisplay');
                const capabilitiesDisplay = document.getElementById('capabilitiesDisplay');
                
                if (currentModeDisplay) {
                    currentModeDisplay.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ' + mode + ' (è©¦è¡Œ' + (info.initAttempts || 0) + 'å›)';
                }
                if (capabilitiesDisplay) {
                    const capabilities = [
                        'ç·šæº: ' + (info.sources || 0) + 'å€‹',
                        'é®è”½ä½“: ' + (info.shields || 0) + 'å€‹', 
                        'æ¤œå‡ºå™¨: ' + (info.detectors || 0) + 'å€‹',
                        'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ' + (info.animation ? 'ON' : 'OFF')
                    ].join(' | ');
                    capabilitiesDisplay.textContent = 'æ©Ÿèƒ½: ' + capabilities;
                }
            }
        }

        // æ‹¡å¼µã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEnhancedEventListeners() {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
            const nextBtn = document.getElementById('nextStep');
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (window.tutorialCore && window.tutorialCore.nextStep()) {
                        window.tutorialCore.progress.interactions++;
                    }
                });
            }
            
            const prevBtn = document.getElementById('prevStep');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (window.tutorialCore && window.tutorialCore.prevStep()) {
                        window.tutorialCore.progress.interactions++;
                    }
                });
            }
            
            const resetBtn = document.getElementById('resetTutorial');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (confirm('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        if (window.tutorialCore) {
                            window.tutorialCore.reset();
                        }
                    }
                });
            }
            
            const exportBtn = document.getElementById('exportProgress');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    if (window.tutorialCore) {
                        window.tutorialCore.exportProgress();
                    }
                });
            }

            // JSONæ“ä½œãƒœã‚¿ãƒ³
            const executeBtn = document.getElementById('executeJson');
            if (executeBtn) {
                executeBtn.addEventListener('click', executeEnhancedJson);
            }
            
            const clearBtn = document.getElementById('clearJson');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearJsonContent);
            }
            
            const validateBtn = document.getElementById('validateJson');
            if (validateBtn) {
                validateBtn.addEventListener('click', validateJsonInput);
            }
            
            const prettifyBtn = document.getElementById('prettifyJson');
            if (prettifyBtn) {
                prettifyBtn.addEventListener('click', prettifyJsonInput);
            }

            // å¯è¦–åŒ–åˆ¶å¾¡ãƒœã‚¿ãƒ³
            const toggle3DBtn = document.getElementById('toggle3DMode');
            if (toggle3DBtn) {
                toggle3DBtn.addEventListener('click', function() {
                    if (window.hybridViz) {
                        window.hybridViz.switchMode('3d');
                    }
                });
            }
            
            const toggle2DBtn = document.getElementById('toggle2DMode');
            if (toggle2DBtn) {
                toggle2DBtn.addEventListener('click', function() {
                    if (window.hybridViz) {
                        window.hybridViz.switchMode('2d');
                    }
                });
            }
            
            const autoUpgradeBtn = document.getElementById('autoUpgrade');
            if (autoUpgradeBtn) {
                autoUpgradeBtn.addEventListener('click', async function() {
                    if (window.hybridViz) {
                        window.hybridViz.config.autoUpgrade = !window.hybridViz.config.autoUpgrade;
                        autoUpgradeBtn.textContent = window.hybridViz.config.autoUpgrade ? 'âš¡ è‡ªå‹•å‡çº§ ON' : 'âš¡ è‡ªå‹•å‡çº§ OFF';
                        
                        if (window.hybridViz.config.autoUpgrade && window.hybridViz.mode === '2d') {
                            await window.hybridViz.tryInitialize3D();
                        }
                    }
                });
            }
            
            const systemInfoBtn = document.getElementById('showSystemInfo');
            if (systemInfoBtn) {
                systemInfoBtn.addEventListener('click', showDetailedSystemInfo);
            }
            
            const captureBtn = document.getElementById('captureView');
            if (captureBtn) {
                captureBtn.addEventListener('click', captureCurrentView);
            }

            // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', function() {
                if (window.hybridViz) {
                    window.hybridViz.handleResize();
                }
            });
        }

        // æ‹¡å¼µJSONå®Ÿè¡Œ
        function executeEnhancedJson() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const request = JSON.parse(jsonInput.value);
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!request.jsonrpc || request.jsonrpc !== "2.0") {
                    throw new Error("JSON-RPC 2.0å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                }
                if (!request.method) {
                    throw new Error("methodãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }

                // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿œç­”
                const response = {
                    jsonrpc: "2.0",
                    result: {
                        success: true,
                        message: request.method + ' ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ',
                        timestamp: new Date().toISOString(),
                        visualizationMode: window.hybridViz ? window.hybridViz.mode : 'unknown'
                    },
                    id: request.id
                };
                
                jsonOutput.textContent = JSON.stringify(response, null, 2);
                jsonOutput.style.color = '#28a745';
                
                // å¯è¦–åŒ–æ›´æ–°
                updateVisualizationFromJson(request);
                
                // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ•°å¢—åŠ 
                if (window.tutorialCore) {
                    window.tutorialCore.progress.interactions++;
                }
                
            } catch (error) {
                const errorResponse = {
                    jsonrpc: "2.0",
                    error: {
                        code: -32700,
                        message: "Parse error",
                        data: error.message
                    },
                    id: null
                };
                
                jsonOutput.textContent = JSON.stringify(errorResponse, null, 2);
                jsonOutput.style.color = '#dc3545';
            }
        }

        // JSONæ•´å½¢
        function prettifyJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            if (!jsonInput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(parsed, null, 2);
            } catch (error) {
                alert('JSONæ•´å½¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // JSONå†…å®¹ã‚¯ãƒªã‚¢
        function clearJsonContent() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (jsonInput) jsonInput.value = '';
            if (jsonOutput) jsonOutput.textContent = 'çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
        }

        // JSONæ¤œè¨¼
        function validateJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                
                const validations = [];
                
                if (parsed.jsonrpc !== "2.0") {
                    validations.push("âš ï¸ JSON-RPC 2.0ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                }
                
                if (!parsed.method) {
                    validations.push("âŒ methodãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }
                
                if (parsed.id === undefined) {
                    validations.push("âš ï¸ idãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }
                
                const validMethods = [
                    'pokerinput_proposeSource',
                    'pokerinput_proposeBody', 
                    'pokerinput_proposeDetector',
                    'pokerinput_applyChanges'
                ];
                
                if (parsed.method && validMethods.indexOf(parsed.method) === -1) {
                    validations.push('âš ï¸ æœªçŸ¥ã®method: ' + parsed.method);
                }
                
                if (validations.length === 0) {
                    jsonOutput.textContent = 'âœ… JSONå½¢å¼ã¨schemaã¯æ­£ã—ã„ã§ã™';
                    jsonOutput.style.color = '#28a745';
                } else {
                    jsonOutput.textContent = 'æ¤œè¨¼çµæœ:\n' + validations.join('\n');
                    jsonOutput.style.color = '#856404';
                }
                
            } catch (error) {
                jsonOutput.textContent = 'âŒ JSONæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + error.message;
                jsonOutput.style.color = '#dc3545';
            }
        }

        // JSONã‹ã‚‰å¯è¦–åŒ–æ›´æ–°
        function updateVisualizationFromJson(request) {
            if (!window.hybridViz) return;
            
            const method = request.method;
            const params = request.params;
            
            try {
                if (method === 'pokerinput_proposeSource' && params) {
                    const position = params.position ? params.position.split(' ').map(Number) : [0, 0, 0];
                    const nuclide = params.inventory && params.inventory[0] ? params.inventory[0].nuclide : 'Unknown';
                    const activity = params.inventory && params.inventory[0] ? params.inventory[0].radioactivity : 0;
                    
                    window.hybridViz.addRadiationSource(params.name, position, nuclide, activity);
                    
                } else if (method === 'pokerinput_proposeBody' && params) {
                    const center = params.center ? params.center.split(' ').map(Number) : [0, 0, 0];
                    const parameters = { center: center, radius: params.radius };
                    
                    window.hybridViz.addShield(params.name, params.type, parameters, 'CONCRETE');
                    
                } else if (method === 'pokerinput_proposeDetector' && params) {
                    const origin = params.origin ? params.origin.split(' ').map(Number) : [0, 0, 0];
                    
                    window.hybridViz.addDetector(params.name, origin, params.grid || []);
                }
                
            } catch (error) {
                console.error('å¯è¦–åŒ–æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è©³ç´°ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
        function showDetailedSystemInfo() {
            const info = window.hybridViz ? window.hybridViz.getDiagnosticInfo() : {};
            const threeTest = window.hybridViz && window.hybridViz.threeManager ? window.hybridViz.threeManager.testThreeJSFunctionality() : {};
            
            const detailedInfo = '=== ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰3D/2Då¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ===\n\n' +
                'ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹:\n' +
                'â€¢ å¯è¦–åŒ–ãƒ¢ãƒ¼ãƒ‰: ' + (info.mode ? info.mode.toUpperCase() : 'Unknown') + '\n' +
                'â€¢ Three.js: ' + (info.threeJS ? ('âœ… åˆ©ç”¨å¯èƒ½ (' + (typeof THREE !== 'undefined' && THREE.REVISION ? THREE.REVISION : 'Unknown') + ')') : 'âŒ åˆ©ç”¨ä¸å¯') + '\n' +
                'â€¢ WebGL: ' + (info.webGL ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ åˆ©ç”¨ä¸å¯') + '\n' +
                'â€¢ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ' + (info.animation ? 'âœ… å‹•ä½œä¸­' : 'â¸ï¸ åœæ­¢ä¸­') + '\n\n' +
                'ğŸ¨ å¯è¦–åŒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:\n' +
                'â€¢ ç·šæº: ' + (info.sources || 0) + 'å€‹\n' +
                'â€¢ é®è”½ä½“: ' + (info.shields || 0) + 'å€‹\n' +  
                'â€¢ æ¤œå‡ºå™¨: ' + (info.detectors || 0) + 'å€‹\n\n' +
                'ğŸ”§ åˆæœŸåŒ–æƒ…å ±:\n' +
                'â€¢ 3DåˆæœŸåŒ–è©¦è¡Œ: ' + (info.initAttempts || 0) + 'å›\n' +
                'â€¢ Canvas ã‚µã‚¤ã‚º: ' + (info.canvas ? info.canvas.width : 0) + ' x ' + (info.canvas ? info.canvas.height : 0) + '\n\n' +
                'ğŸŒ ç’°å¢ƒæƒ…å ±:\n' +
                'â€¢ ãƒ–ãƒ©ã‚¦ã‚¶: ' + navigator.userAgent.split(' ')[0] + '\n' +
                'â€¢ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ' + navigator.platform + '\n' +
                'â€¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ' + (navigator.onLine ? 'Yes' : 'No') + '\n' +
                'â€¢ ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ' + window.location.protocol + '\n\n' +
                'ğŸ§ª Three.jsæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ:\n' +
                (threeTest.success ? 'âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ' : 'âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—') + '\n' +
                (threeTest.error ? ('ã‚¨ãƒ©ãƒ¼: ' + threeTest.error) : '') + '\n\n' +
                'ğŸ“ˆ å­¦ç¿’é€²æ—:\n' +
                'â€¢ ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ' + (window.tutorialCore ? window.tutorialCore.currentStep : 0) + ' / ' + (window.tutorialCore ? window.tutorialCore.totalSteps : 0) + '\n' +
                'â€¢ å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—: ' + (window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.completedSteps.length : 0) + 'å€‹\n' +
                'â€¢ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ•°: ' + (window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.interactions : 0) + 'å›\n\n' +
                'ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:\n' +
                (info.mode === '2d' ? 
                'â€¢ "ğŸ”„ 3Dåˆ‡æ›¿" ãƒœã‚¿ãƒ³ã§3Dãƒ¢ãƒ¼ãƒ‰ã‚’è©¦è¡Œã§ãã¾ã™\n' : 
                'â€¢ 3Då¯è¦–åŒ–ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™\n') +
                (!info.threeJS ? 'â€¢ Three.jsã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™\n' : '') +
                (!info.webGL ? 'â€¢ WebGLæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“\n' : '');
            
            alert(detailedInfo);
        }

        // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        function captureCurrentView() {
            if (window.hybridViz && window.hybridViz.canvas) {
                try {
                    const canvas = window.hybridViz.canvas;
                    const dataURL = canvas.toDataURL('image/png');
                    
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = 'visualization_' + (window.hybridViz.mode || 'unknown') + '_step_' + (window.tutorialCore ? window.tutorialCore.currentStep : 0) + '_' + Date.now() + '.png';
                    link.click();
                    
                    if (window.hybridViz.showMessage) {
                        window.hybridViz.showMessage((window.hybridViz.mode || 'unknown').toUpperCase() + 'ãƒ“ãƒ¥ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    }
                    
                } catch (error) {
                    console.error('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ç”»é¢ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            } else {
                alert('å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEnhancedSystem);
        } else {
            initializeEnhancedSystem();
        }
        
        console.log('ğŸ¨ 3Då¾©æ—§ç‰ˆã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
    </script>

    <!-- CSS ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        .system-status {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
        }

        .mode-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 123, 255, 0.05);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .mode-info div {
            margin: 2px 0;
            color: #495057;
        }

        .step-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .step-description p {
            margin: 8px 0;
        }

        .viz-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .system-status {
                justify-content: center;
            }
            
            .status-badge {
                font-size: 0.8rem;
                padding: 3px 6px;
            }
        }
    </style>
</body>
</html>
