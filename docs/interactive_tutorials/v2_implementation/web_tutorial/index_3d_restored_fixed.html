<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 Poker MCP 3D可視化チュートリアル - 復旧版</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🎨 放射線遮蔽計算 3D可視化チュートリアル - 復旧版</h1>
            <p>Co-60線源を使用した医療施設遮蔽設計の学習（3D/2D ハイブリッドシステム）</p>
        </header>

        <main>
            <!-- プログレスインジケーター -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="progress-text" id="progressText">Step 1 / 5</span>
            </div>

            <!-- システム状態表示 -->
            <div class="system-status">
                <span id="systemMode" class="status-badge">システム初期化中...</span>
                <span id="threejsStatus" class="status-badge">Three.js: 確認中</span>
                <span id="webglStatus" class="status-badge">WebGL: 確認中</span>
            </div>

            <!-- メインコンテンツ -->
            <div class="content-area" id="contentArea">
                <div class="step-content">
                    <h2>システム初期化中...</h2>
                    <p>ハイブリッド3D/2D可視化システムを読み込んでいます。</p>
                </div>
            </div>

            <!-- 可視化エリア -->
            <div class="visualization-area">
                <div class="viz-header">
                    <h4>🎨 ハイブリッド 3D/2D 可視化</h4>
                    <div class="viz-controls">
                        <button id="toggle3DMode" class="viz-btn">🔄 3D切替</button>
                        <button id="toggle2DMode" class="viz-btn">📊 2D切替</button>
                        <button id="autoUpgrade" class="viz-btn">⚡ 自動升级</button>
                        <button id="showSystemInfo" class="viz-btn">📋 システム情報</button>
                        <button id="captureView" class="viz-btn">📷 画面保存</button>
                    </div>
                </div>
                
                <canvas id="geometryCanvas" width="400" height="300">
                    お使いのブラウザはCanvas要素をサポートしていません。
                </canvas>
                
                <div id="visualizationMessage" class="viz-message">
                    ハイブリッド可視化システム初期化中...
                </div>
                
                <div id="modeInfo" class="mode-info">
                    <div id="currentModeDisplay">モード: 確認中</div>
                    <div id="capabilitiesDisplay">機能: 初期化中</div>
                </div>
            </div>

            <!-- JSON入力エリア -->
            <div class="input-section">
                <h3>📝 JSON-RPC 2.0 入力</h3>
                <textarea id="jsonInput" placeholder="JSON-RPC 2.0 リクエストを入力してください..." rows="8"></textarea>
                <div class="button-group">
                    <button id="executeJson" class="primary-btn">🚀 実行</button>
                    <button id="clearJson" class="secondary-btn">🗑️ クリア</button>
                    <button id="validateJson" class="secondary-btn">✅ 検証</button>
                    <button id="prettifyJson" class="secondary-btn">🎨 整形</button>
                </div>
            </div>

            <!-- 結果表示エリア -->
            <div class="output-section">
                <h3>📊 実行結果</h3>
                <pre id="jsonOutput" class="output-content">結果がここに表示されます...</pre>
            </div>

            <!-- ナビゲーション -->
            <div class="navigation">
                <button id="prevStep" class="nav-btn secondary-btn" disabled>⬅️ 前のステップ</button>
                <button id="nextStep" class="nav-btn primary-btn">次のステップ ➡️</button>
                <button id="resetTutorial" class="nav-btn secondary-btn">🔄 リセット</button>
                <button id="exportProgress" class="nav-btn secondary-btn">💾 進捗保存</button>
            </div>
        </main>

        <footer>
            <p>🎓 Poker MCP Tutorial System v3.0 - ハイブリッド3D/2D可視化対応版</p>
        </footer>
    </div>

    <!-- 3D復旧システム統合スクリプト -->
    <script src="local-threejs-manager.js"></script>
    <script src="hybrid-visualization.js"></script>
    
    <script>
        // 3D復旧版メインシステム
        console.log('🚀 3D復旧版チュートリアルシステム初期化開始...');
        
        // グローバル変数
        window.tutorialCore = null;
        window.hybridViz = null;
        
        // ステップデータ
        const tutorialSteps = [
            {
                title: "Step 1: Co-60線源の設定",
                content: "医療用Co-60線源を原点に配置し、3D空間での放射線源を可視化します。",
                learning: "放射線源の基本概念と3D表示での直感的理解を学習します。",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeSource",
  "params": {
    "name": "co60_medical",
    "type": "POINT",
    "position": "0 0 0",
    "inventory": [
      {
        "nuclide": "Co60",
        "radioactivity": 37000000000
      }
    ]
  },
  "id": 1
}`
            },
            {
                title: "Step 2: コンクリート遮蔽体",
                content: "コンクリート球形遮蔽体を追加し、放射線遮蔽の基本構造を構築します。",
                learning: "遮蔽体の3D形状と材料特性を視覚的に理解します。",
                jsonTemplate: `{
  "jsonrpc": "2.0", 
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "concrete_shield",
    "type": "SPH",
    "center": "0 0 0",
    "radius": 50
  },
  "id": 2
}`
            },
            {
                title: "Step 3: 検出器配置", 
                content: "線量率測定用検出器アレイを配置し、遮蔽効果の測定系を構築します。",
                learning: "検出器配置と線量率分布の3D可視化を学習します。",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeDetector", 
  "params": {
    "name": "dose_survey",
    "origin": "60 0 0",
    "grid": [{"edge": "10 0 0", "number": 10}]
  },
  "id": 3
}`
            },
            {
                title: "Step 4: 鉛遮蔽追加",
                content: "内側に鉛遮蔽球を追加し、複合遮蔽構造を完成させます。",
                learning: "複合材料による高効率遮蔽設計の3D理解を深めます。",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_proposeBody",
  "params": {
    "name": "lead_inner_shield", 
    "type": "SPH",
    "center": "0 0 0",
    "radius": 18
  },
  "id": 4
}`
            },
            {
                title: "Step 5: 完成・保存",
                content: "遮蔽設計を完成させ、計算結果を保存します。",
                learning: "実用的な遮蔽設計の完成と実務への応用方法を学習します。",
                jsonTemplate: `{
  "jsonrpc": "2.0",
  "method": "pokerinput_applyChanges", 
  "params": {
    "backup_comment": "Medical Co-60 shielding design completed with hybrid 3D visualization"
  },
  "id": 5
}`
            }
        ];

        // チュートリアルコア
        class Enhanced3DTutorialCore {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = tutorialSteps.length;
                this.steps = tutorialSteps;
                this.progress = {
                    completedSteps: [],
                    startTime: Date.now(),
                    interactions: 0
                };
                
                console.log('✅ Enhanced3DTutorialCore初期化完了');
            }
            
            getCurrentStep() {
                return this.steps[this.currentStep - 1];
            }
            
            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    this.progress.completedSteps.push(this.currentStep);
                    this.currentStep++;
                    this.updateUI();
                    this.updateVisualization();
                    return true;
                }
                return false;
            }
            
            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.progress.completedSteps = this.progress.completedSteps.filter(s => s < this.currentStep);
                    this.updateUI();
                    this.updateVisualization();
                    return true;
                }
                return false;
            }
            
            updateUI() {
                const step = this.getCurrentStep();
                
                // プログレス更新
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                if (progressFill) {
                    progressFill.style.width = Math.round((this.currentStep / this.totalSteps) * 100) + '%';
                }
                if (progressText) {
                    progressText.textContent = 'Step ' + this.currentStep + ' / ' + this.totalSteps;
                }
                
                // コンテンツ更新
                const contentArea = document.getElementById('contentArea');
                if (contentArea && step) {
                    const stepHTML = '<div class="step-content">' +
                        '<h2>' + step.title + '</h2>' +
                        '<div class="step-description">' +
                        '<p><strong>概要:</strong> ' + step.content + '</p>' +
                        '<p><strong>学習目標:</strong> ' + step.learning + '</p>' +
                        '</div>' +
                        '</div>';
                    contentArea.innerHTML = stepHTML;
                }
                
                // JSON入力更新
                const jsonInput = document.getElementById('jsonInput');
                if (jsonInput && step.jsonTemplate) {
                    jsonInput.value = step.jsonTemplate;
                }
                
                // ナビゲーションボタン更新
                const prevBtn = document.getElementById('prevStep');
                const nextBtn = document.getElementById('nextStep');
                if (prevBtn) {
                    prevBtn.disabled = this.currentStep === 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = this.currentStep === this.totalSteps;
                    nextBtn.textContent = this.currentStep === this.totalSteps ? '🎉 完了' : '次のステップ ➡️';
                }
                
                console.log('📍 Step ' + this.currentStep + ' に更新');
            }
            
            updateVisualization() {
                if (!window.hybridViz) return;
                
                // 既存要素をクリア
                window.hybridViz.clearAll();
                
                // ステップに応じた可視化更新
                if (this.currentStep >= 1) {
                    window.hybridViz.addRadiationSource('co60_medical', [0, 0, 0], 'Co60', 37000000000);
                }
                
                if (this.currentStep >= 2) {
                    window.hybridViz.addShield('concrete_shield', 'SPH', { center: [0, 0, 0], radius: 50 }, 'CONCRETE');
                }
                
                if (this.currentStep >= 3) {
                    window.hybridViz.addDetector('dose_survey', [60, 0, 0], [{ edge: [10, 0, 0], number: 10 }]);
                }
                
                if (this.currentStep >= 4) {
                    window.hybridViz.addShield('lead_inner_shield', 'SPH', { center: [0, 0, 0], radius: 18 }, 'LEAD');
                }
            }
            
            reset() {
                this.currentStep = 1;
                this.progress.completedSteps = [];
                this.progress.interactions = 0;
                if (window.hybridViz) {
                    window.hybridViz.clearAll();
                }
                this.updateUI();
                this.updateVisualization();
                console.log('🔄 チュートリアルをリセット');
            }
            
            exportProgress() {
                const progressData = {
                    currentStep: this.currentStep,
                    completedSteps: this.progress.completedSteps,
                    startTime: this.progress.startTime,
                    duration: Date.now() - this.progress.startTime,
                    interactions: this.progress.interactions,
                    systemInfo: window.hybridViz ? window.hybridViz.getDiagnosticInfo() : null,
                    timestamp: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(progressData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'tutorial_progress_' + Date.now() + '.json';
                link.click();
                
                URL.revokeObjectURL(url);
                console.log('💾 学習進捗をエクスポート');
            }
        }

        // システム初期化
        async function initializeEnhancedSystem() {
            console.log('🚀 拡張システム初期化開始...');
            
            try {
                // ステータス更新
                updateSystemStatus('初期化中...', '確認中', '確認中');
                
                // チュートリアルコア初期化
                window.tutorialCore = new Enhanced3DTutorialCore();
                
                // ハイブリッド可視化システム初期化
                console.log('🎨 ハイブリッド可視化システム初期化中...');
                window.hybridViz = new HybridVisualizationSystem('geometryCanvas');
                
                // UIイベント設定
                setupEnhancedEventListeners();
                
                // 初期表示
                window.tutorialCore.updateUI();
                
                // ステータス更新関数を定期実行
                setInterval(updateSystemStatuses, 2000);
                
                console.log('✅ 拡張システム初期化完了');
                
            } catch (error) {
                console.error('❌ 拡張システム初期化エラー:', error);
                updateSystemStatus('初期化失敗', 'エラー', 'エラー');
                
                // エラー時のフォールバック表示
                const messageEl = document.getElementById('visualizationMessage');
                if (messageEl) {
                    messageEl.textContent = 'システム初期化に失敗しました: ' + error.message;
                    messageEl.style.color = '#dc3545';
                }
            }
        }

        // システムステータス更新
        function updateSystemStatus(mode, threejs, webgl) {
            const systemMode = document.getElementById('systemMode');
            const threejsStatus = document.getElementById('threejsStatus');
            const webglStatus = document.getElementById('webglStatus');
            
            if (systemMode) systemMode.textContent = 'モード: ' + mode;
            if (threejsStatus) threejsStatus.textContent = 'Three.js: ' + threejs;
            if (webglStatus) webglStatus.textContent = 'WebGL: ' + webgl;
        }

        // 動的ステータス更新
        function updateSystemStatuses() {
            if (window.hybridViz) {
                const info = window.hybridViz.getDiagnosticInfo();
                const mode = info.mode ? info.mode.toUpperCase() : 'Unknown';
                const threejs = info.threeJS ? '✅ 利用可能' : '❌ 利用不可';
                const webgl = info.webGL ? '✅ 利用可能' : '❌ 利用不可';
                
                updateSystemStatus(mode, threejs, webgl);
                
                // モード情報更新
                const currentModeDisplay = document.getElementById('currentModeDisplay');
                const capabilitiesDisplay = document.getElementById('capabilitiesDisplay');
                
                if (currentModeDisplay) {
                    currentModeDisplay.textContent = 'モード: ' + mode + ' (試行' + (info.initAttempts || 0) + '回)';
                }
                if (capabilitiesDisplay) {
                    const capabilities = [
                        '線源: ' + (info.sources || 0) + '個',
                        '遮蔽体: ' + (info.shields || 0) + '個', 
                        '検出器: ' + (info.detectors || 0) + '個',
                        'アニメーション: ' + (info.animation ? 'ON' : 'OFF')
                    ].join(' | ');
                    capabilitiesDisplay.textContent = '機能: ' + capabilities;
                }
            }
        }

        // 拡張イベントリスナー設定
        function setupEnhancedEventListeners() {
            // ナビゲーションボタン
            const nextBtn = document.getElementById('nextStep');
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (window.tutorialCore && window.tutorialCore.nextStep()) {
                        window.tutorialCore.progress.interactions++;
                    }
                });
            }
            
            const prevBtn = document.getElementById('prevStep');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (window.tutorialCore && window.tutorialCore.prevStep()) {
                        window.tutorialCore.progress.interactions++;
                    }
                });
            }
            
            const resetBtn = document.getElementById('resetTutorial');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (confirm('チュートリアルをリセットしますか？')) {
                        if (window.tutorialCore) {
                            window.tutorialCore.reset();
                        }
                    }
                });
            }
            
            const exportBtn = document.getElementById('exportProgress');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    if (window.tutorialCore) {
                        window.tutorialCore.exportProgress();
                    }
                });
            }

            // JSON操作ボタン
            const executeBtn = document.getElementById('executeJson');
            if (executeBtn) {
                executeBtn.addEventListener('click', executeEnhancedJson);
            }
            
            const clearBtn = document.getElementById('clearJson');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearJsonContent);
            }
            
            const validateBtn = document.getElementById('validateJson');
            if (validateBtn) {
                validateBtn.addEventListener('click', validateJsonInput);
            }
            
            const prettifyBtn = document.getElementById('prettifyJson');
            if (prettifyBtn) {
                prettifyBtn.addEventListener('click', prettifyJsonInput);
            }

            // 可視化制御ボタン
            const toggle3DBtn = document.getElementById('toggle3DMode');
            if (toggle3DBtn) {
                toggle3DBtn.addEventListener('click', function() {
                    if (window.hybridViz) {
                        window.hybridViz.switchMode('3d');
                    }
                });
            }
            
            const toggle2DBtn = document.getElementById('toggle2DMode');
            if (toggle2DBtn) {
                toggle2DBtn.addEventListener('click', function() {
                    if (window.hybridViz) {
                        window.hybridViz.switchMode('2d');
                    }
                });
            }
            
            const autoUpgradeBtn = document.getElementById('autoUpgrade');
            if (autoUpgradeBtn) {
                autoUpgradeBtn.addEventListener('click', async function() {
                    if (window.hybridViz) {
                        window.hybridViz.config.autoUpgrade = !window.hybridViz.config.autoUpgrade;
                        autoUpgradeBtn.textContent = window.hybridViz.config.autoUpgrade ? '⚡ 自動升级 ON' : '⚡ 自動升级 OFF';
                        
                        if (window.hybridViz.config.autoUpgrade && window.hybridViz.mode === '2d') {
                            await window.hybridViz.tryInitialize3D();
                        }
                    }
                });
            }
            
            const systemInfoBtn = document.getElementById('showSystemInfo');
            if (systemInfoBtn) {
                systemInfoBtn.addEventListener('click', showDetailedSystemInfo);
            }
            
            const captureBtn = document.getElementById('captureView');
            if (captureBtn) {
                captureBtn.addEventListener('click', captureCurrentView);
            }

            // リサイズ対応
            window.addEventListener('resize', function() {
                if (window.hybridViz) {
                    window.hybridViz.handleResize();
                }
            });
        }

        // 拡張JSON実行
        function executeEnhancedJson() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const request = JSON.parse(jsonInput.value);
                
                // バリデーション
                if (!request.jsonrpc || request.jsonrpc !== "2.0") {
                    throw new Error("JSON-RPC 2.0形式ではありません");
                }
                if (!request.method) {
                    throw new Error("methodが指定されていません");
                }

                // シミュレーション応答
                const response = {
                    jsonrpc: "2.0",
                    result: {
                        success: true,
                        message: request.method + ' が正常に実行されました',
                        timestamp: new Date().toISOString(),
                        visualizationMode: window.hybridViz ? window.hybridViz.mode : 'unknown'
                    },
                    id: request.id
                };
                
                jsonOutput.textContent = JSON.stringify(response, null, 2);
                jsonOutput.style.color = '#28a745';
                
                // 可視化更新
                updateVisualizationFromJson(request);
                
                // インタラクション数増加
                if (window.tutorialCore) {
                    window.tutorialCore.progress.interactions++;
                }
                
            } catch (error) {
                const errorResponse = {
                    jsonrpc: "2.0",
                    error: {
                        code: -32700,
                        message: "Parse error",
                        data: error.message
                    },
                    id: null
                };
                
                jsonOutput.textContent = JSON.stringify(errorResponse, null, 2);
                jsonOutput.style.color = '#dc3545';
            }
        }

        // JSON整形
        function prettifyJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            if (!jsonInput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(parsed, null, 2);
            } catch (error) {
                alert('JSON整形エラー: ' + error.message);
            }
        }

        // JSON内容クリア
        function clearJsonContent() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (jsonInput) jsonInput.value = '';
            if (jsonOutput) jsonOutput.textContent = '結果がここに表示されます...';
        }

        // JSON検証
        function validateJsonInput() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonOutput = document.getElementById('jsonOutput');
            
            if (!jsonInput || !jsonOutput) return;
            
            try {
                const parsed = JSON.parse(jsonInput.value);
                
                const validations = [];
                
                if (parsed.jsonrpc !== "2.0") {
                    validations.push("⚠️ JSON-RPC 2.0ではありません");
                }
                
                if (!parsed.method) {
                    validations.push("❌ methodが指定されていません");
                }
                
                if (parsed.id === undefined) {
                    validations.push("⚠️ idが指定されていません");
                }
                
                const validMethods = [
                    'pokerinput_proposeSource',
                    'pokerinput_proposeBody', 
                    'pokerinput_proposeDetector',
                    'pokerinput_applyChanges'
                ];
                
                if (parsed.method && validMethods.indexOf(parsed.method) === -1) {
                    validations.push('⚠️ 未知のmethod: ' + parsed.method);
                }
                
                if (validations.length === 0) {
                    jsonOutput.textContent = '✅ JSON形式とschemaは正しいです';
                    jsonOutput.style.color = '#28a745';
                } else {
                    jsonOutput.textContent = '検証結果:\n' + validations.join('\n');
                    jsonOutput.style.color = '#856404';
                }
                
            } catch (error) {
                jsonOutput.textContent = '❌ JSON検証エラー: ' + error.message;
                jsonOutput.style.color = '#dc3545';
            }
        }

        // JSONから可視化更新
        function updateVisualizationFromJson(request) {
            if (!window.hybridViz) return;
            
            const method = request.method;
            const params = request.params;
            
            try {
                if (method === 'pokerinput_proposeSource' && params) {
                    const position = params.position ? params.position.split(' ').map(Number) : [0, 0, 0];
                    const nuclide = params.inventory && params.inventory[0] ? params.inventory[0].nuclide : 'Unknown';
                    const activity = params.inventory && params.inventory[0] ? params.inventory[0].radioactivity : 0;
                    
                    window.hybridViz.addRadiationSource(params.name, position, nuclide, activity);
                    
                } else if (method === 'pokerinput_proposeBody' && params) {
                    const center = params.center ? params.center.split(' ').map(Number) : [0, 0, 0];
                    const parameters = { center: center, radius: params.radius };
                    
                    window.hybridViz.addShield(params.name, params.type, parameters, 'CONCRETE');
                    
                } else if (method === 'pokerinput_proposeDetector' && params) {
                    const origin = params.origin ? params.origin.split(' ').map(Number) : [0, 0, 0];
                    
                    window.hybridViz.addDetector(params.name, origin, params.grid || []);
                }
                
            } catch (error) {
                console.error('可視化更新エラー:', error);
            }
        }

        // 詳細システム情報表示
        function showDetailedSystemInfo() {
            const info = window.hybridViz ? window.hybridViz.getDiagnosticInfo() : {};
            const threeTest = window.hybridViz && window.hybridViz.threeManager ? window.hybridViz.threeManager.testThreeJSFunctionality() : {};
            
            const detailedInfo = '=== ハイブリッド3D/2D可視化システム情報 ===\n\n' +
                '📊 現在の状態:\n' +
                '• 可視化モード: ' + (info.mode ? info.mode.toUpperCase() : 'Unknown') + '\n' +
                '• Three.js: ' + (info.threeJS ? ('✅ 利用可能 (' + (typeof THREE !== 'undefined' && THREE.REVISION ? THREE.REVISION : 'Unknown') + ')') : '❌ 利用不可') + '\n' +
                '• WebGL: ' + (info.webGL ? '✅ 利用可能' : '❌ 利用不可') + '\n' +
                '• アニメーション: ' + (info.animation ? '✅ 動作中' : '⏸️ 停止中') + '\n\n' +
                '🎨 可視化オブジェクト:\n' +
                '• 線源: ' + (info.sources || 0) + '個\n' +
                '• 遮蔽体: ' + (info.shields || 0) + '個\n' +  
                '• 検出器: ' + (info.detectors || 0) + '個\n\n' +
                '🔧 初期化情報:\n' +
                '• 3D初期化試行: ' + (info.initAttempts || 0) + '回\n' +
                '• Canvas サイズ: ' + (info.canvas ? info.canvas.width : 0) + ' x ' + (info.canvas ? info.canvas.height : 0) + '\n\n' +
                '🌐 環境情報:\n' +
                '• ブラウザ: ' + navigator.userAgent.split(' ')[0] + '\n' +
                '• プラットフォーム: ' + navigator.platform + '\n' +
                '• オンライン: ' + (navigator.onLine ? 'Yes' : 'No') + '\n' +
                '• プロトコル: ' + window.location.protocol + '\n\n' +
                '🧪 Three.js機能テスト:\n' +
                (threeTest.success ? '✅ テスト成功' : '❌ テスト失敗') + '\n' +
                (threeTest.error ? ('エラー: ' + threeTest.error) : '') + '\n\n' +
                '📈 学習進捗:\n' +
                '• 現在のステップ: ' + (window.tutorialCore ? window.tutorialCore.currentStep : 0) + ' / ' + (window.tutorialCore ? window.tutorialCore.totalSteps : 0) + '\n' +
                '• 完了ステップ: ' + (window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.completedSteps.length : 0) + '個\n' +
                '• インタラクション数: ' + (window.tutorialCore && window.tutorialCore.progress ? window.tutorialCore.progress.interactions : 0) + '回\n\n' +
                '💡 推奨アクション:\n' +
                (info.mode === '2d' ? 
                '• "🔄 3D切替" ボタンで3Dモードを試行できます\n' : 
                '• 3D可視化が正常に動作しています\n') +
                (!info.threeJS ? '• Three.jsの読み込みに問題があります\n' : '') +
                (!info.webGL ? '• WebGL機能が利用できません\n' : '');
            
            alert(detailedInfo);
        }

        // 現在のビューをキャプチャ
        function captureCurrentView() {
            if (window.hybridViz && window.hybridViz.canvas) {
                try {
                    const canvas = window.hybridViz.canvas;
                    const dataURL = canvas.toDataURL('image/png');
                    
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = 'visualization_' + (window.hybridViz.mode || 'unknown') + '_step_' + (window.tutorialCore ? window.tutorialCore.currentStep : 0) + '_' + Date.now() + '.png';
                    link.click();
                    
                    if (window.hybridViz.showMessage) {
                        window.hybridViz.showMessage((window.hybridViz.mode || 'unknown').toUpperCase() + 'ビューを保存しました');
                    }
                    
                } catch (error) {
                    console.error('スクリーンショット取得エラー:', error);
                    alert('画面保存に失敗しました: ' + error.message);
                }
            } else {
                alert('可視化システムが初期化されていません');
            }
        }

        // 初期化実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEnhancedSystem);
        } else {
            initializeEnhancedSystem();
        }
        
        console.log('🎨 3D復旧版システム読み込み完了');
    </script>

    <!-- CSS スタイル -->
    <style>
        .system-status {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
        }

        .mode-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 123, 255, 0.05);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .mode-info div {
            margin: 2px 0;
            color: #495057;
        }

        .step-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .step-description p {
            margin: 8px 0;
        }

        .viz-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .system-status {
                justify-content: center;
            }
            
            .status-badge {
                font-size: 0.8rem;
                padding: 3px 6px;
            }
        }
    </style>
</body>
</html>
