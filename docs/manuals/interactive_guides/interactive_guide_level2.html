<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ Poker MCP Interactive Guide - Level 2: å®Ÿç”¨è¨­è¨ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --primary-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --accent-physics: #7c3aed;
            --accent-success: #10b981;
            --accent-medical: #ec4899;
            --accent-nuclear: #f59e0b;
            --accent-research: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1f2937;
            overflow-x: hidden;
        }

        .main-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-physics) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .progress-container {
            flex: 1;
            max-width: 400px;
            margin: 0 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--accent-success);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .level-indicator {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .scenario-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .scenario-modal {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .scenario-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .scenario-card:hover {
            border-color: var(--primary-blue);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .scenario-card.medical { border-color: var(--accent-medical); }
        .scenario-card.nuclear { border-color: var(--accent-nuclear); }
        .scenario-card.research { border-color: var(--accent-research); }

        .scenario-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .scenario-description {
            font-size: 0.95rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 350px;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 140px);
        }

        .instruction-panel, .design-panel, .visualization-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .visualization-panel {
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        #threejs-container {
            width: 100%;
            height: 100%;
        }

        .view-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .view-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .view-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        .design-tools {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .step-indicator {
            background: linear-gradient(135deg, var(--accent-physics), #9333ea);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .design-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .design-section h3 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .parameter-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .slider-group {
            margin: 1rem 0;
        }

        .slider-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
        }

        .slider-value {
            background: var(--primary-blue);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .calc-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-physics));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 1rem 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
            margin: 0.5rem 0;
        }

        .result-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
        }

        .result-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .result-status.ok { background: var(--primary-green); color: white; }
        .result-status.warning { background: var(--warning-orange); color: white; }

        .optimization-game {
            background: linear-gradient(135deg, #fef7cd, #fbbf24);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            display: none;
        }

        .constraints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .constraint-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .constraint-value {
            font-weight: bold;
            color: var(--primary-blue);
            display: block;
            margin-top: 0.25rem;
        }

        .score-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-green);
            margin: 0.5rem 0;
        }

        .navigation-footer {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .nav-btn.primary { background: var(--primary-blue); color: white; }
        .nav-btn.secondary { background: #e5e7eb; color: #1f2937; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="scenario-selector" id="scenario-selector">
        <div class="scenario-modal">
            <h2 style="text-align: center; color: var(--primary-blue); margin-bottom: 1rem;">
                ğŸ—ï¸ å®Ÿç”¨è¨­è¨ˆã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„
            </h2>
            <p style="text-align: center; color: #6b7280; margin-bottom: 1.5rem;">
                å®Ÿéš›ã®æ–½è¨­è¨­è¨ˆã‚’ä½“é¨“ã—ãªãŒã‚‰ã€æ”¾å°„ç·šé®è”½ã®å®Ÿç”¨ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†
            </p>
            
            <div class="scenario-grid">
                <div class="scenario-card medical" data-scenario="medical">
                    <div class="scenario-icon">ğŸ¥</div>
                    <div class="scenario-title">åŒ»ç™‚æ–½è¨­é®è”½è¨­è¨ˆ</div>
                    <div class="scenario-description">
                        18MVç·šå½¢åŠ é€Ÿå™¨æ²»ç™‚å®¤ã®é®è”½è¨­è¨ˆã€‚åŒ»ç™‚æ³•æ–½è¡Œè¦å‰‡ã«åŸºã¥ãå®‰å…¨ã§åŠ¹ç‡çš„ãªè¨­è¨ˆã‚’å­¦ç¿’ã—ã¾ã™ã€‚
                    </div>
                </div>

                <div class="scenario-card nuclear" data-scenario="nuclear">
                    <div class="scenario-icon">âš›ï¸</div>
                    <div class="scenario-title">åŸå­åŠ›æ–½è¨­é®è”½è¨­è¨ˆ</div>
                    <div class="scenario-description">
                        é«˜ãƒ¬ãƒ™ãƒ«æ”¾å°„æ€§å»ƒæ£„ç‰©è²¯è”µæ–½è¨­ã®é®è”½è¨­è¨ˆã€‚è¤‡åˆé®è”½ã¨é•·æœŸå®‰å…¨æ€§ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆæ‰‹æ³•ã‚’ç¿’å¾—ã—ã¾ã™ã€‚
                    </div>
                </div>

                <div class="scenario-card research" data-scenario="research">
                    <div class="scenario-icon">ğŸ”¬</div>
                    <div class="scenario-title">ç ”ç©¶æ–½è¨­é®è”½è¨­è¨ˆ</div>
                    <div class="scenario-description">
                        ã‚µã‚¤ã‚¯ãƒ­ãƒˆãƒ­ãƒ³åŠ é€Ÿå™¨æ–½è¨­ã®ä¸­æ€§å­é®è”½è¨­è¨ˆã€‚å¤šæ§˜ãªæ”¾å°„ç·šã«å¯¾å¿œã™ã‚‹è¤‡åˆé®è”½ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¿’å¾—ã—ã¾ã™ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="main-header">
        <div class="logo">ğŸ¥ Poker MCP Interactive Guide - Level 2</div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="main-progress" style="width: 0%"></div>
            </div>
            <div class="level-indicator">å®Ÿç”¨è¨­è¨ˆ - å®Œå…¨ç‰ˆ</div>
        </div>
        <div class="current-step" id="current-step-display">ã‚·ãƒŠãƒªã‚ªé¸æŠ</div>
    </header>

    <main class="main-content">
        <div class="instruction-panel">
            <div class="step-indicator" id="step-indicator">Step 0: å®Ÿç”¨ã‚·ãƒŠãƒªã‚ªé¸æŠ</div>
            <div id="instruction-content">
                <h2>ğŸ¯ Level 2: å®Ÿç”¨è¨­è¨ˆã¸ã‚ˆã†ã“ã</h2>
                <p>ã“ã®ãƒ¬ãƒ™ãƒ«ã§ã¯ã€å®Ÿéš›ã®æ–½è¨­ã§ä½¿ç”¨ã•ã‚Œã‚‹é®è”½è¨­è¨ˆæŠ€è¡“ã‚’ç¿’å¾—ã—ã¾ã™ã€‚</p>
                
                <div style="background: #ede9fe; border: 1px solid var(--accent-physics); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <h3>ğŸ“ å­¦ç¿’ç›®æ¨™</h3>
                    <ul>
                        <li>å®Ÿéš›ã®æ–½è¨­è¨­è¨ˆãƒ—ãƒ­ã‚»ã‚¹ä½“é¨“</li>
                        <li>åˆ¶ç´„æ¡ä»¶ä¸‹ã§ã®æœ€é©åŒ–æ‰‹æ³•</li>
                        <li>åˆ†é‡åˆ¥å°‚é–€çŸ¥è­˜ã®ç†è§£</li>
                        <li>ç·åˆçš„ãªè¨­è¨ˆåˆ¤æ–­åŠ›</li>
                    </ul>
                </div>

                <p>ä¸Šã‹ã‚‰1ã¤ã®ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ã€å®Ÿç”¨çš„ãªé®è”½è¨­è¨ˆã‚’ä½“é¨“ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

        <div class="visualization-panel">
            <div id="threejs-container"></div>
            <div class="view-controls">
                <button class="view-btn active" id="view-structure">ğŸ—ï¸ æ§‹é€ </button>
                <button class="view-btn" id="view-dose">â˜¢ï¸ ç·šé‡</button>
                <button class="view-btn" id="view-cost">ğŸ’° ã‚³ã‚¹ãƒˆ</button>
            </div>
            <div class="design-tools">
                <button class="tool-btn" id="optimize-auto">ğŸ¤– æœ€é©åŒ–</button>
                <button class="tool-btn" id="validate-design">âœ… æ¤œè¨¼</button>
                <button class="tool-btn" id="export-report">ğŸ“„ å ±å‘Šæ›¸</button>
            </div>
        </div>

        <div class="design-panel">
            <div class="design-section">
                <h3>ğŸ—ï¸ åŸºæœ¬å¹¾ä½•è¨­è¨ˆ</h3>
                <div class="parameter-grid">
                    <div>
                        <label>å®¤å†…é•·ã• (m)</label>
                        <input type="number" class="parameter-input" id="room-length" value="8" min="5" max="15" step="0.5">
                    </div>
                    <div>
                        <label>å®¤å†…å¹… (m)</label>
                        <input type="number" class="parameter-input" id="room-width" value="6" min="4" max="12" step="0.5">
                    </div>
                    <div>
                        <label>å®¤å†…é«˜ã• (m)</label>
                        <input type="number" class="parameter-input" id="room-height" value="3" min="2.5" max="5" step="0.1">
                    </div>
                    <div>
                        <label>è¿·è·¯é•·ã• (m)</label>
                        <input type="number" class="parameter-input" id="maze-length" value="4" min="2" max="8" step="0.5">
                    </div>
                </div>
            </div>

            <div class="design-section">
                <h3>ğŸ§± é®è”½ææ–™è¨­è¨ˆ</h3>
                
                <div class="slider-group">
                    <label>ä¸»å£åšã• (cm)</label>
                    <input type="range" class="slider" id="main-wall-thickness" min="50" max="300" value="150" step="5">
                    <span class="slider-value" id="main-wall-value">150 cm</span>
                </div>

                <div class="slider-group">
                    <label>ãƒ‰ã‚¢é®è”½åšã• (cm)</label>
                    <input type="range" class="slider" id="door-thickness" min="5" max="50" value="15" step="1">
                    <span class="slider-value" id="door-value">15 cm</span>
                </div>

                <div style="margin: 1rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">ä¸»å£ææ–™</label>
                    <select class="parameter-input" id="wall-material">
                        <option value="concrete_normal">æ™®é€šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option>
                        <option value="concrete_heavy" selected>é‡ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option>
                        <option value="concrete_barite">ãƒãƒ©ã‚¤ãƒˆã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option>
                        <option value="concrete_borated">ãƒ›ã‚¦ç´ å…¥ã‚Šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option>
                        <option value="steel_concrete">é‹¼é‰„+ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆè¤‡åˆ</option>
                    </select>
                </div>

                <div style="margin: 1rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">ãƒ‰ã‚¢ææ–™</label>
                    <select class="parameter-input" id="door-material">
                        <option value="lead" selected>ç´”é‰›</option>
                        <option value="steel_lead">é‹¼é‰„+é‰›è¤‡åˆ</option>
                        <option value="tungsten">ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³</option>
                    </select>
                </div>
            </div>

            <div style="background: #f0fdf4; border: 1px solid var(--primary-green); border-radius: 10px; padding: 1.5rem; margin: 1rem 0;">
                <button class="calc-btn" id="calculate-design">âš¡ é«˜ç²¾åº¦é®è”½æ€§èƒ½è¨ˆç®—</button>
                <div class="results-grid" id="results-grid" style="display: none;">
                    <div class="result-card">
                        <div class="result-label">æœ€å¤§ç·šé‡ç‡</div>
                        <div class="result-value" id="max-dose-rate">-- Î¼Sv/h</div>
                        <div class="result-status" id="dose-status">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">ç·å·¥äº‹è²»</div>
                        <div class="result-value" id="total-cost">-- ä¸‡å††</div>
                        <div class="result-status" id="cost-status">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">ææ–™é‡é‡</div>
                        <div class="result-value" id="total-weight">-- ãƒˆãƒ³</div>
                        <div class="result-status" id="weight-status">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">å®‰å…¨ä½™è£•</div>
                        <div class="result-value" id="safety-margin">-- %</div>
                        <div class="result-status" id="margin-status">--</div>
                    </div>
                </div>
            </div>

            <div class="optimization-game" id="optimization-game">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <h4 style="color: var(--warning-orange); margin-bottom: 0.5rem;">ğŸ¯ è¨­è¨ˆæœ€é©åŒ–ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>
                    <p>åˆ¶ç´„æ¡ä»¶å†…ã§æœ€é«˜åŠ¹ç‡ã®è¨­è¨ˆã‚’é”æˆã—ã‚ˆã†ï¼</p>
                </div>
                
                <div class="constraints-grid">
                    <div class="constraint-item">
                        <div>ç·šé‡ç‡ä¸Šé™</div>
                        <div class="constraint-value" id="dose-constraint">2.5 Î¼Sv/h</div>
                    </div>
                    <div class="constraint-item">
                        <div>äºˆç®—ä¸Šé™</div>
                        <div class="constraint-value" id="cost-constraint">5000 ä¸‡å††</div>
                    </div>
                    <div class="constraint-item">
                        <div>é‡é‡åˆ¶é™</div>
                        <div class="constraint-value" id="weight-constraint">800 ãƒˆãƒ³</div>
                    </div>
                    <div class="constraint-item">
                        <div>å·¥æœŸåˆ¶é™</div>
                        <div class="constraint-value" id="schedule-constraint">6 ãƒ¶æœˆ</div>
                    </div>
                </div>

                <div class="score-display">
                    <div class="result-label">ç·åˆæœ€é©åŒ–ã‚¹ã‚³ã‚¢</div>
                    <div class="score-value" id="optimization-score">0</div>
                    <div style="font-size: 0.8rem; color: #6b7280;">100ç‚¹æº€ç‚¹</div>
                </div>
            </div>
        </div>
    </main>

    <footer class="navigation-footer">
        <button class="nav-btn secondary" id="prev-step" disabled>â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—</button>
        <div style="display: flex; gap: 1rem;">
            <button class="nav-btn secondary" id="hint-btn">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
            <button class="nav-btn secondary" id="reset-design">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="nav-btn secondary" id="save-design">ğŸ’¾ ä¿å­˜</button>
        </div>
        <button class="nav-btn primary" id="next-step">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’</button>
    </footer>

    <script>
        const scenarioDatabase = {
            medical: {
                name: "åŒ»ç™‚æ–½è¨­é®è”½è¨­è¨ˆ",
                icon: "ğŸ¥",
                description: "18MVç·šå½¢åŠ é€Ÿå™¨æ²»ç™‚å®¤",
                source: { type: "linac_18MV", energy: 18, nominalRate: 600 },
                requirements: { doseLimit: 2.5, regulation: "åŒ»ç™‚æ³•æ–½è¡Œè¦å‰‡" },
                constraints: { maxCost: 5000, maxWeight: 800, maxSchedule: 6 },
                materials: ["concrete_heavy", "concrete_barite", "steel_concrete"],
                defaultDesign: { roomDimensions: [8, 6, 3], wallThickness: 150, doorThickness: 15, mazeLength: 4 }
            },
            nuclear: {
                name: "åŸå­åŠ›æ–½è¨­é®è”½è¨­è¨ˆ",
                icon: "âš›ï¸",
                description: "é«˜ãƒ¬ãƒ™ãƒ«æ”¾å°„æ€§å»ƒæ£„ç‰©è²¯è”µæ–½è¨­",
                source: { type: "mixed_waste", activity: 1e15 },
                requirements: { doseLimit: 250, regulation: "æ ¸ç‡ƒæ–™ç‰©è³ªç­‰ã®è¦åˆ¶ã«é–¢ã™ã‚‹æ³•å¾‹" },
                constraints: { maxCost: 15000, maxWeight: 2000, maxSchedule: 12 },
                materials: ["steel_concrete", "concrete_heavy"],
                defaultDesign: { roomDimensions: [6, 6, 4], wallThickness: 200, doorThickness: 25, mazeLength: 6 }
            },
            research: {
                name: "ç ”ç©¶æ–½è¨­é®è”½è¨­è¨ˆ",
                icon: "ğŸ”¬",
                description: "ã‚µã‚¤ã‚¯ãƒ­ãƒˆãƒ­ãƒ³åŠ é€Ÿå™¨æ–½è¨­",
                source: { type: "cyclotron", energy: 30, current: 100 },
                requirements: { doseLimit: 5.0, regulation: "æ”¾å°„ç·šéšœå®³é˜²æ­¢æ³•" },
                constraints: { maxCost: 8000, maxWeight: 1200, maxSchedule: 9 },
                materials: ["concrete_borated", "steel_concrete", "concrete_heavy"],
                defaultDesign: { roomDimensions: [10, 8, 4], wallThickness: 180, doorThickness: 20, mazeLength: 5 }
            }
        };

        const materialDatabase = {
            concrete_normal: { name: "æ™®é€šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ", density: 2.3, muMass: 0.0636, cost: 25000, color: 0xd2b48c },
            concrete_heavy: { name: "é‡ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ", density: 3.5, muMass: 0.0636, cost: 45000, color: 0x8b7355 },
            concrete_barite: { name: "ãƒãƒ©ã‚¤ãƒˆã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ", density: 4.2, muMass: 0.0620, cost: 85000, color: 0x9d8964 },
            concrete_borated: { name: "ãƒ›ã‚¦ç´ å…¥ã‚Šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ", density: 2.8, muMass: 0.0636, cost: 65000, color: 0xa0a0ff },
            steel_concrete: { name: "é‹¼é‰„+ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆè¤‡åˆ", density: 4.2, muMass: 0.0580, cost: 85000, color: 0x708090 },
            lead: { name: "ç´”é‰›", density: 11.34, muMass: 0.107, cost: 450000, color: 0x696969 },
            steel_lead: { name: "é‹¼é‰„+é‰›è¤‡åˆ", density: 9.5, muMass: 0.089, cost: 320000, color: 0x2f4f4f },
            tungsten: { name: "ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³", density: 19.25, muMass: 0.0947, cost: 2800000, color: 0x404040 }
        };

        let scene, camera, renderer;
        let currentScenario = null;
        let designParameters = {};
        let calculationResults = {};
        let visualizer = null;
        let progressManager = null;

        class ProgressManager {
            constructor() {
                this.currentStep = 0;
                this.totalSteps = 6;
                this.scenario = null;
            }

            setScenario(scenarioKey) {
                this.scenario = scenarioKey;
                this.currentStep = 1;
                this.updateProgress();
                this.updateStepContent();
            }

            updateProgress() {
                const progress = Math.max(0, (this.currentStep - 1) / (this.totalSteps - 1) * 100);
                document.getElementById('main-progress').style.width = progress + '%';
                
                const stepNames = ["ã‚·ãƒŠãƒªã‚ªé¸æŠ", "æ–½è¨­ä»•æ§˜ç†è§£", "åŸºæœ¬å¹¾ä½•è¨­è¨ˆ", "é®è”½ææ–™è¨­è¨ˆ", "æ€§èƒ½æœ€é©åŒ–", "æœ€çµ‚æ¤œè¨¼", "è¨­è¨ˆå®Œäº†"];
                document.getElementById('current-step-display').textContent = stepNames[this.currentStep] || `Step ${this.currentStep}`;
            }

            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    this.updateStepContent();
                    this.updateProgress();
                } else {
                    alert('ğŸ‰ Level 2 å®Œäº†ï¼\n\nå®Ÿç”¨çš„ãªé®è”½è¨­è¨ˆã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼');
                }
            }

            updateStepContent() {
                const scenario = scenarioDatabase[this.scenario];
                if (!scenario) return;

                const stepContents = {
                    1: {
                        title: `Step 1: ${scenario.name} - æ–½è¨­ä»•æ§˜ç†è§£`,
                        content: `
                            <div style="background: #ede9fe; border: 1px solid var(--accent-physics); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h3>${scenario.icon} ${scenario.name}</h3>
                                <p><strong>${scenario.description}</strong></p>
                                <h4>ğŸ¯ è¨­è¨ˆè¦æ±‚äº‹é …</h4>
                                <ul>
                                    <li>ç·šé‡ç‡é™åº¦: <strong>${scenario.requirements.doseLimit} Î¼Sv/h</strong></li>
                                    <li>æ³•çš„æ ¹æ‹ : ${scenario.requirements.regulation}</li>
                                </ul>
                            </div>
                            <p>ğŸ’¡ å³å´ã®3Dè¡¨ç¤ºã§æ–½è¨­æ§‹é€ ã‚’ç¢ºèªã—ã€è¨­è¨ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚</p>
                        `
                    },
                    2: {
                        title: "Step 2: åŸºæœ¬å¹¾ä½•è¨­è¨ˆ",
                        content: `
                            <h3>ğŸ—ï¸ æ–½è¨­å¹¾ä½•ã®è©³ç´°è¨­è¨ˆ</h3>
                            <p>æ²»ç™‚å®¤ãƒ»è²¯è”µå®¤ãƒ»å®Ÿé¨“å®¤ã®æœ€é©ãªç©ºé–“é…ç½®ã‚’è¨­è¨ˆã—ã¾ã™ã€‚</p>
                            <div style="background: #fef3c7; border: 1px solid var(--warning-orange); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>ğŸ¯ è¨­è¨ˆè€ƒæ…®äº‹é …</h4>
                                <ul>
                                    <li><strong>å®¤å†…å¯¸æ³•</strong>: è¨­å‚™é…ç½®ãƒ»ä½œæ¥­ç©ºé–“ãƒ»ä¿å®ˆã‚¢ã‚¯ã‚»ã‚¹</li>
                                    <li><strong>è¿·è·¯è¨­è¨ˆ</strong>: æ•£ä¹±ç·šä½æ¸›ãƒ»å…¥é€€å®¤åŠ¹ç‡</li>
                                    <li><strong>æ§‹é€ å¼·åº¦</strong>: è‡ªé‡ãƒ»åœ°éœ‡è·é‡ãƒ»é•·æœŸå®‰å®šæ€§</li>
                                </ul>
                            </div>
                            <p>âš¡ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¦æœ€é©ãªæ–½è¨­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚</p>
                        `
                    },
                    3: {
                        title: "Step 3: é®è”½ææ–™ãƒ»åšã•è¨­è¨ˆ",
                        content: `
                            <h3>ğŸ§± é«˜åº¦ãªé®è”½ææ–™è¨­è¨ˆ</h3>
                            <p>ææ–™é¸æŠã¨åšã•æ±ºå®šã«ã‚ˆã‚Šã€å®‰å…¨æ€§ã¨çµŒæ¸ˆæ€§ã‚’ä¸¡ç«‹ã—ã¾ã™ã€‚</p>
                            <div style="background: #fef2f2; border: 1px solid var(--danger-red); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>âš–ï¸ é®è”½æ€§èƒ½ã®å®šé‡è©•ä¾¡</h4>
                                <p><strong>Cs-137ã‚’1/100ã«æ¸›è¡°ã•ã›ã‚‹åšã•:</strong></p>
                                <ul>
                                    <li>é‰›: ç´„4cmï¼ˆæœ€é«˜åŠ¹ç‡ï¼‰</li>
                                    <li>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ: ç´„80cmï¼ˆå¤§å®¹é‡ãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</li>
                                    <li>é‡ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ: ç´„50cmï¼ˆä¸­é–“è§£ï¼‰</li>
                                </ul>
                            </div>
                            <p>ğŸ§ª ã€Œé«˜ç²¾åº¦é®è”½æ€§èƒ½è¨ˆç®—ã€ã§å®Ÿéš›ã®æ¸›è¡°ã‚’ç¢ºèªã—ãªãŒã‚‰æœ€é©åŒ–ã—ã¦ãã ã•ã„ã€‚</p>
                        `
                    },
                    4: {
                        title: "Step 4: æ€§èƒ½æœ€é©åŒ–",
                        content: `
                            <h3>ğŸ® è¨­è¨ˆæœ€é©åŒ–ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h3>
                            <p>å…¨åˆ¶ç´„æ¡ä»¶ã‚’æº€ãŸã—ãªãŒã‚‰ã€æœ€é«˜åŠ¹ç‡ã®è¨­è¨ˆã‚’ç›®æŒ‡ã—ã¾ã™ã€‚</p>
                            <div style="background: #ede9fe; border: 1px solid var(--accent-physics); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>ğŸ† æœ€é©åŒ–ç›®æ¨™</h4>
                                <ol>
                                    <li><strong>å®‰å…¨æ€§ç¢ºä¿</strong> (50ç‚¹): ç·šé‡ç‡åŸºæº–ã®ç¢ºå®Ÿãªéµå®ˆ</li>
                                    <li><strong>çµŒæ¸ˆæ€§å‘ä¸Š</strong> (30ç‚¹): ç·å·¥äº‹è²»ã®æœ€å°åŒ–</li>
                                    <li><strong>è¨­è¨ˆåŠ¹ç‡</strong> (20ç‚¹): é‡é‡ãƒ»ç©ºé–“ãƒ»å·¥æœŸã®åŠ¹ç‡åŒ–</li>
                                </ol>
                            </div>
                            <p>ğŸ¯ å³ä¸‹ã®æœ€é©åŒ–ã‚¹ã‚³ã‚¢100ç‚¹é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼</p>
                        `
                    },
                    5: {
                        title: "Step 5: æœ€çµ‚æ¤œè¨¼",
                        content: `
                            <h3>âœ… è¨­è¨ˆæ¤œè¨¼ãƒ»å“è³ªä¿è¨¼</h3>
                            <p>æœ€çµ‚è¨­è¨ˆã®å¦¥å½“æ€§ã‚’å¤šè§’çš„ã«æ¤œè¨¼ã—ã€å®Ÿç”¨æ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚</p>
                            <div style="background: #fef2f2; border: 1px solid var(--danger-red); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>ğŸ” è¨­è¨ˆæ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h4>
                                <ul>
                                    <li>â˜‘ï¸ æ³•è¦åˆ¶è¦æ±‚ã®å®Œå…¨éµå®ˆ</li>
                                    <li>â˜‘ï¸ æ§‹é€ å®‰å…¨æ€§ã®ç¢ºä¿</li>
                                    <li>â˜‘ï¸ æ–½å·¥å¯èƒ½æ€§ã®ç¢ºèª</li>
                                    <li>â˜‘ï¸ é‹ç”¨ãƒ»ä¿å®ˆè¨ˆç”»ã®ç­–å®š</li>
                                </ul>
                            </div>
                            <p>ğŸ† è¨­è¨ˆãŒå®Œæˆã—ãŸã‚‰ã€Œè¨­è¨ˆä¿å­˜ã€ã§æˆæœã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ï¼</p>
                        `
                    },
                    6: {
                        title: "Step 6: è¨­è¨ˆå®Œäº†",
                        content: `
                            <h3>ğŸŠ è¨­è¨ˆå®Œäº†ãƒ»æ¬¡æ®µéšæº–å‚™</h3>
                            <p>å„ªç§€ãªè¨­è¨ˆãŒå®Œæˆã—ã¾ã—ãŸï¼å®Ÿè£…ã«å‘ã‘ãŸæº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚</p>
                            <div style="background: #ede9fe; border: 1px solid var(--accent-physics); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h4>
                                <ul>
                                    <li><strong>å®Ÿå‹™é©ç”¨</strong>: ç ”ç©¶ãƒ»æ¥­å‹™ã§ã®æ´»ç”¨é–‹å§‹</li>
                                    <li><strong>ç¶™ç¶šå­¦ç¿’</strong>: æœ€æ–°æŠ€è¡“ãƒ»è¦åˆ¶ã®ç¿’å¾—</li>
                                    <li><strong>çŸ¥è­˜å…±æœ‰</strong>: ãƒãƒ¼ãƒ ãƒ»çµ„ç¹”ã¸ã®å±•é–‹</li>
                                </ul>
                            </div>
                            <p>ğŸ‰ ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼</p>
                        `
                    }
                };
                
                const currentContent = stepContents[this.currentStep];
                if (currentContent) {
                    document.getElementById('step-indicator').textContent = currentContent.title;
                    document.getElementById('instruction-content').innerHTML = currentContent.content;
                    
                    const optimizationGame = document.getElementById('optimization-game');
                    if (this.currentStep >= 4) {
                        optimizationGame.style.display = 'block';
                    }

                    document.getElementById('prev-step').disabled = this.currentStep <= 1;
                    document.getElementById('next-step').textContent = 
                        this.currentStep >= this.totalSteps ? 'ğŸ‰ Levelå®Œäº†' : 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’';
                }
            }

            calculateFinalScore() {
                if (!calculationResults || !calculationResults.isValid) return 0;
                
                const scenario = scenarioDatabase[this.scenario];
                let score = 0;
                
                if (calculationResults.maxDoseRate <= scenario.requirements.doseLimit) {
                    const margin = (scenario.requirements.doseLimit - calculationResults.maxDoseRate) / scenario.requirements.doseLimit;
                    score += Math.min(50, 30 + margin * 20);
                }
                
                if (calculationResults.totalCost <= scenario.constraints.maxCost) {
                    const efficiency = 1 - (calculationResults.totalCost / scenario.constraints.maxCost);
                    score += Math.min(30, efficiency * 30);
                }
                
                if (calculationResults.totalWeight <= scenario.constraints.maxWeight) {
                    const lightness = 1 - (calculationResults.totalWeight / scenario.constraints.maxWeight);
                    score += Math.min(20, lightness * 20);
                }
                
                return Math.round(score);
            }
        }

        class FacilityVisualizer {
            constructor(container) {
                this.container = container;
                this.facilityObjects = {};
                this.initializeScene();
                this.animate();
            }

            initializeScene() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f4f8);

                camera = new THREE.PerspectiveCamera(60, this.container.clientWidth / this.container.clientHeight, 0.1, 1000);
                camera.position.set(15, 10, 15);
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                renderer.shadowMap.enabled = true;
                this.container.appendChild(renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
                directionalLight.position.set(10, 20, 10);
                directionalLight.castShadow = true;
                scene.add(directionalLight);

                this.createFloorAndGrid();
                this.setupControls();
            }

            createFloorAndGrid() {
                const floorGeometry = new THREE.PlaneGeometry(50, 50);
                const floorMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                scene.add(floor);

                const gridHelper = new THREE.GridHelper(50, 50, 0xcccccc, 0xeeeeee);
                scene.add(gridHelper);
            }

            setupControls() {
                let isMouseDown = false;
                let mouseX = 0, mouseY = 0;
                let targetRotationY = 0.8;
                let currentDistance = 25;

                this.container.addEventListener('mousedown', (event) => {
                    isMouseDown = true;
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });

                this.container.addEventListener('mousemove', (event) => {
                    if (!isMouseDown) return;
                    
                    const deltaX = event.clientX - mouseX;
                    targetRotationY += deltaX * 0.01;
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });

                this.container.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });

                this.container.addEventListener('wheel', (event) => {
                    event.preventDefault();
                    currentDistance += event.deltaY * 0.01;
                    currentDistance = Math.max(10, Math.min(60, currentDistance));
                });

                const updateCamera = () => {
                    camera.position.x = currentDistance * Math.sin(targetRotationY);
                    camera.position.y = currentDistance * 0.5;
                    camera.position.z = currentDistance * Math.cos(targetRotationY);
                    camera.lookAt(0, 2, 0);
                    requestAnimationFrame(updateCamera);
                };
                updateCamera();
            }

            createFacilityStructure(scenario, parameters) {
                this.clearFacility();
                
                const roomLength = parameters.roomLength || 8;
                const roomWidth = parameters.roomWidth || 6;
                const roomHeight = parameters.roomHeight || 3;
                const wallThickness = (parameters.wallThickness || 150) / 100;
                const wallMaterial = materialDatabase[parameters.wallMaterial] || materialDatabase.concrete_heavy;

                this.createWalls(roomLength, roomWidth, roomHeight, wallThickness, wallMaterial);
                this.createRadiationSource(scenario);
                this.createDetectors(roomLength, roomWidth, wallThickness);
            }

            createWalls(length, width, height, thickness, materialData) {
                const wallMaterial = new THREE.MeshPhongMaterial({
                    color: materialData.color,
                    transparent: true,
                    opacity: 0.8
                });

                const walls = [
                    { geometry: new THREE.BoxGeometry(length + 2*thickness, height, thickness), position: [0, height/2, -width/2 - thickness/2] },
                    { geometry: new THREE.BoxGeometry(length + 2*thickness, height, thickness), position: [0, height/2, width/2 + thickness/2] },
                    { geometry: new THREE.BoxGeometry(thickness, height, width), position: [-length/2 - thickness/2, height/2, 0] },
                    { geometry: new THREE.BoxGeometry(thickness, height, width), position: [length/2 + thickness/2, height/2, 0] },
                    { geometry: new THREE.BoxGeometry(length + 2*thickness, thickness, width + 2*thickness), position: [0, height + thickness/2, 0] }
                ];

                walls.forEach((wallData, index) => {
                    const wall = new THREE.Mesh(wallData.geometry, wallMaterial);
                    wall.position.set(...wallData.position);
                    wall.castShadow = true;
                    wall.receiveShadow = true;
                    this.facilityObjects[`wall_${index}`] = wall;
                    scene.add(wall);
                });
            }

            createRadiationSource(scenario) {
                let geometry, material;
                
                switch (scenario) {
                    case 'medical':
                        geometry = new THREE.BoxGeometry(3, 2, 1.5);
                        material = new THREE.MeshPhongMaterial({ color: 0x4a90e2, emissive: 0x001133 });
                        break;
                    case 'nuclear':
                        geometry = new THREE.CylinderGeometry(1.0, 1.0, 3);
                        material = new THREE.MeshPhongMaterial({ color: 0xff6b35, emissive: 0x331100 });
                        break;
                    case 'research':
                        geometry = new THREE.CylinderGeometry(2.5, 2.5, 1);
                        material = new THREE.MeshPhongMaterial({ color: 0x50c878, emissive: 0x003311 });
                        break;
                    default:
                        geometry = new THREE.SphereGeometry(0.5);
                        material = new THREE.MeshPhongMaterial({ color: 0xff4444, emissive: 0x220000 });
                }
                
                const source = new THREE.Mesh(geometry, material);
                source.position.set(0, 1.5, 0);
                source.castShadow = true;
                this.facilityObjects.radiation_source = source;
                scene.add(source);
            }

            createDetectors(roomLength, roomWidth, wallThickness) {
                const detectorGeometry = new THREE.SphereGeometry(0.12);
                const detectorMaterial = new THREE.MeshPhongMaterial({
                    color: 0x44ff44,
                    emissive: 0x002200,
                    transparent: true,
                    opacity: 0.8
                });

                const detectionPoints = [
                    [roomLength/2 + wallThickness + 0.3, 1, 0],
                    [-roomLength/2 - wallThickness - 0.3, 1, 0],
                    [0, 1, roomWidth/2 + wallThickness + 0.3],
                    [0, 1, -roomWidth/2 - wallThickness - 0.3]
                ];

                detectionPoints.forEach((pos, index) => {
                    const detector = new THREE.Mesh(detectorGeometry, detectorMaterial.clone());
                    detector.position.set(...pos);
                    this.facilityObjects[`detector_${index}`] = detector;
                    scene.add(detector);
                });
            }

            clearFacility() {
                Object.values(this.facilityObjects).forEach(obj => {
                    scene.remove(obj);
                });
                this.facilityObjects = {};
            }

            animate() {
                const render = () => {
                    requestAnimationFrame(render);
                    
                    if (this.facilityObjects.radiation_source) {
                        this.facilityObjects.radiation_source.rotation.y += 0.01;
                    }
                    
                    renderer.render(scene, camera);
                };
                render();
            }
        }

        class ShieldingCalculator {
            calculateShielding(scenario, parameters) {
                const scenarioData = scenarioDatabase[scenario];
                const wallMaterial = materialDatabase[parameters.wallMaterial];
                const wallThickness = parameters.wallThickness / 100;
                
                const distance = 1.5;
                const sourceActivity = scenarioData.source.nominalRate || scenarioData.source.activity || 1000;
                const geometricAttenuation = 1 / (distance * distance);
                const mu = wallMaterial.muMass * wallMaterial.density * 100;
                const shieldingAttenuation = Math.exp(-mu * wallThickness);
                const buildup = 1 + (mu * wallThickness) * 0.5;
                const baseDoseRate = sourceActivity * 0.001;
                const maxDoseRate = baseDoseRate * geometricAttenuation * shieldingAttenuation * buildup;
                
                const roomLength = parameters.roomLength || 8;
                const roomWidth = parameters.roomWidth || 6;
                const roomHeight = parameters.roomHeight || 3;
                const volume = this.calculateWallVolume(roomLength, roomWidth, roomHeight, wallThickness);
                const totalCost = volume * wallMaterial.cost / 10000;
                const totalWeight = volume * wallMaterial.density;
                const safetyMargin = Math.max(0, ((scenarioData.requirements.doseLimit - maxDoseRate) / scenarioData.requirements.doseLimit) * 100);
                
                return {
                    maxDoseRate: Math.max(maxDoseRate, 0.01),
                    avgDoseRate: maxDoseRate * 0.7,
                    totalCost: totalCost,
                    totalWeight: totalWeight,
                    safetyMargin: safetyMargin,
                    isValid: maxDoseRate <= scenarioData.requirements.doseLimit
                };
            }

            calculateWallVolume(length, width, height, wallThickness) {
                const outerLength = length + 2 * wallThickness;
                const outerWidth = width + 2 * wallThickness;
                const outerHeight = height + wallThickness;
                const outerVolume = outerLength * outerWidth * outerHeight;
                const innerVolume = length * width * height;
                return outerVolume - innerVolume;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            progressManager = new ProgressManager();
            const calculator = new ShieldingCalculator();
            
            const scenarioCards = document.querySelectorAll('.scenario-card');
            scenarioCards.forEach(card => {
                card.addEventListener('click', () => {
                    selectScenario(card.dataset.scenario);
                });
            });

            const parameterInputs = document.querySelectorAll('.parameter-input');
            parameterInputs.forEach(input => {
                input.addEventListener('change', updateDesignParameters);
            });

            const sliders = document.querySelectorAll('.slider');
            sliders.forEach(slider => {
                slider.addEventListener('input', (e) => {
                    updateSliderDisplay(slider);
                    updateDesignParameters();
                });
            });

            document.getElementById('next-step').addEventListener('click', () => {
                progressManager.nextStep();
            });

            document.getElementById('prev-step').addEventListener('click', () => {
                if (progressManager.currentStep > 1) {
                    progressManager.currentStep--;
                    progressManager.updateStepContent();
                    progressManager.updateProgress();
                }
            });

            document.getElementById('calculate-design').addEventListener('click', async () => {
                if (!currentScenario) return;

                const calculateBtn = document.getElementById('calculate-design');
                const resultsGrid = document.getElementById('results-grid');

                calculateBtn.disabled = true;
                calculateBtn.textContent = 'ğŸ”„ é«˜ç²¾åº¦è¨ˆç®—ä¸­...';

                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    calculationResults = calculator.calculateShielding(currentScenario, designParameters);
                    
                    document.getElementById('max-dose-rate').textContent = calculationResults.maxDoseRate.toFixed(2) + ' Î¼Sv/h';
                    document.getElementById('total-cost').textContent = calculationResults.totalCost.toFixed(0) + ' ä¸‡å††';
                    document.getElementById('total-weight').textContent = calculationResults.totalWeight.toFixed(0) + ' ãƒˆãƒ³';
                    document.getElementById('safety-margin').textContent = calculationResults.safetyMargin.toFixed(1) + ' %';

                    updateResultStatus('dose-status', calculationResults.isValid);
                    updateResultStatus('cost-status', calculationResults.totalCost <= scenarioDatabase[currentScenario].constraints.maxCost);
                    updateResultStatus('weight-status', calculationResults.totalWeight <= scenarioDatabase[currentScenario].constraints.maxWeight);
                    updateResultStatus('margin-status', calculationResults.safetyMargin >= 20);

                    if (progressManager.currentStep >= 4) {
                        updateOptimizationScore();
                    }

                } catch (error) {
                    alert('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                } finally {
                    calculateBtn.disabled = false;
                    calculateBtn.textContent = 'âš¡ é«˜ç²¾åº¦é®è”½æ€§èƒ½è¨ˆç®—';
                    resultsGrid.style.display = 'grid';
                }
            });

            document.getElementById('hint-btn').addEventListener('click', () => {
                if (!currentScenario) return;
                const scenarioData = scenarioDatabase[currentScenario];
                alert(`ğŸ’¡ ${scenarioData.name}ã®ãƒ’ãƒ³ãƒˆ:\n\nâ€¢ ç·šé‡é™åº¦: ${scenarioData.requirements.doseLimit} Î¼Sv/h\nâ€¢ æ³•çš„æ ¹æ‹ : ${scenarioData.requirements.regulation}\nâ€¢ è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ: å®‰å…¨æ€§ã‚’æœ€å„ªå…ˆã«è€ƒæ…®ã—ã¾ã—ã‚‡ã†ï¼`);
            });

            document.getElementById('reset-design').addEventListener('click', resetToDefaultDesign);
            document.getElementById('save-design').addEventListener('click', () => {
                alert('ğŸ’¾ è¨­è¨ˆãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
            });

            function selectScenario(scenarioKey) {
                currentScenario = scenarioKey;
                const scenarioData = scenarioDatabase[scenarioKey];
                
                document.getElementById('scenario-selector').style.display = 'none';
                progressManager.setScenario(scenarioKey);
                
                const defaultDesign = scenarioData.defaultDesign;
                designParameters = {
                    roomLength: defaultDesign.roomDimensions[0],
                    roomWidth: defaultDesign.roomDimensions[1], 
                    roomHeight: defaultDesign.roomDimensions[2],
                    wallThickness: defaultDesign.wallThickness,
                    doorThickness: defaultDesign.doorThickness,
                    mazeLength: defaultDesign.mazeLength,
                    wallMaterial: scenarioData.materials[0] || 'concrete_heavy',
                    doorMaterial: 'lead'
                };
                
                updateUIFromParameters();
                initializeVisualization();
                updateConstraintDisplay(scenarioData);
            }

            function initializeVisualization() {
                const container = document.getElementById('threejs-container');
                visualizer = new FacilityVisualizer(container);
                visualizer.createFacilityStructure(currentScenario, designParameters);
            }

            function updateDesignParameters() {
                if (!currentScenario) return;

                designParameters.roomLength = parseFloat(document.getElementById('room-length').value) || 8;
                designParameters.roomWidth = parseFloat(document.getElementById('room-width').value) || 6;
                designParameters.roomHeight = parseFloat(document.getElementById('room-height').value) || 3;
                designParameters.wallThickness = parseFloat(document.getElementById('main-wall-thickness').value) || 150;
                designParameters.doorThickness = parseFloat(document.getElementById('door-thickness').value) || 15;
                designParameters.mazeLength = parseFloat(document.getElementById('maze-length').value) || 4;
                designParameters.wallMaterial = document.getElementById('wall-material').value || 'concrete_heavy';
                designParameters.doorMaterial = document.getElementById('door-material').value || 'lead';

                if (visualizer && currentScenario) {
                    visualizer.createFacilityStructure(currentScenario, designParameters);
                }
            }

            function updateSliderDisplay(slider) {
                const valueDisplay = document.getElementById(slider.id.replace('main-wall-thickness', 'main-wall-value').replace('door-thickness', 'door-value'));
                if (valueDisplay) {
                    valueDisplay.textContent = slider.value + ' cm';
                }
            }

            function updateResultStatus(elementId, isGood) {
                const element = document.getElementById(elementId);
                if (isGood) {
                    element.textContent = 'âœ“ é©åˆ';
                    element.className = 'result-status ok';
                } else {
                    element.textContent = 'âš  è¦æ”¹å–„';
                    element.className = 'result-status warning';
                }
            }

            function updateOptimizationScore() {
                if (!calculationResults || !calculationResults.isValid) {
                    document.getElementById('optimization-score').textContent = '0';
                    return;
                }
                const score = progressManager.calculateFinalScore();
                document.getElementById('optimization-score').textContent = score;
            }

            function updateConstraintDisplay(scenarioData) {
                document.getElementById('dose-constraint').textContent = scenarioData.requirements.doseLimit + ' Î¼Sv/h';
                document.getElementById('cost-constraint').textContent = scenarioData.constraints.maxCost + ' ä¸‡å††';
                document.getElementById('weight-constraint').textContent = scenarioData.constraints.maxWeight + ' ãƒˆãƒ³';
                document.getElementById('schedule-constraint').textContent = scenarioData.constraints.maxSchedule + ' ãƒ¶æœˆ';
            }

            function updateUIFromParameters() {
                document.getElementById('room-length').value = designParameters.roomLength;
                document.getElementById('room-width').value = designParameters.roomWidth; 
                document.getElementById('room-height').value = designParameters.roomHeight;
                document.getElementById('main-wall-thickness').value = designParameters.wallThickness;
                document.getElementById('door-thickness').value = designParameters.doorThickness;
                document.getElementById('maze-length').value = designParameters.mazeLength;
                document.getElementById('wall-material').value = designParameters.wallMaterial;
                document.getElementById('door-material').value = designParameters.doorMaterial;

                document.getElementById('main-wall-value').textContent = designParameters.wallThickness + ' cm';
                document.getElementById('door-value').textContent = designParameters.doorThickness + ' cm';
            }

            function resetToDefaultDesign() {
                if (!currentScenario) return;

                const defaultDesign = scenarioDatabase[currentScenario].defaultDesign;
                
                designParameters = {
                    roomLength: defaultDesign.roomDimensions[0],
                    roomWidth: defaultDesign.roomDimensions[1],
                    roomHeight: defaultDesign.roomDimensions[2],
                    wallThickness: defaultDesign.wallThickness,
                    doorThickness: defaultDesign.doorThickness,
                    mazeLength: defaultDesign.mazeLength,
                    wallMaterial: scenarioDatabase[currentScenario].materials[0],
                    doorMaterial: 'lead'
                };

                updateUIFromParameters();
                
                if (visualizer) {
                    visualizer.createFacilityStructure(currentScenario, designParameters);
                }

                alert('ğŸ”„ è¨­è¨ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
            }
        });
    </script>
</body>
</html>