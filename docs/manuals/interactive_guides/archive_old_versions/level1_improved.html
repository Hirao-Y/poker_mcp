<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ Poker MCP Interactive Guide - Level 1: åŸºç¤ç¿’å¾—</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --primary-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --bg-light: #f8fafc;
            --bg-panel: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-physics: #7c3aed;
            --accent-success: #10b981;
            --accent-medical: #ec4899;
            --accent-nuclear: #f59e0b;
            --accent-research: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #e2e8f0 100%);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .main-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-physics) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container {
            flex: 1;
            max-width: 400px;
            margin: 0 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--accent-success);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .level-indicator {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 340px;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 140px);
        }

        .instruction-panel, .control-panel {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .visualization-panel {
            background: var(--bg-panel);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .step-indicator {
            background: linear-gradient(135deg, var(--accent-physics), #9333ea);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .concept-box {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border: 2px solid var(--accent-physics);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .physics-formula {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .key-insight {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border: 2px solid var(--warning-orange);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 5px solid var(--warning-orange);
        }

        .research-context {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid var(--primary-green);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .parameter-section {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
        }

        .parameter-section:last-child {
            border-bottom: none;
        }

        .parameter-section h3 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parameter-group {
            margin-bottom: 1.5rem;
        }

        .parameter-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .parameter-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .parameter-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .slider-container {
            margin: 0.5rem 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
        }

        .slider-value {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .primary-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-physics));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 1rem 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .primary-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .results-display {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid var(--primary-green);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .result-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-blue);
            margin: 0.5rem 0;
        }

        .result-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .result-status.excellent {
            background: var(--primary-green);
            color: white;
        }

        .result-status.good {
            background: var(--accent-success);
            color: white;
        }

        .result-status.warning {
            background: var(--warning-orange);
            color: white;
        }

        .result-status.danger {
            background: var(--danger-red);
            color: white;
        }

        .comparison-table {
            background: white;
            border-radius: 8px;
            margin: 1rem 0;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.85rem;
        }

        .comparison-table th {
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: #f8fafc;
        }

        .navigation-footer {
            background: var(--bg-panel);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .nav-btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .nav-btn.secondary {
            background: #e5e7eb;
            color: var(--text-primary);
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        #threejs-container {
            width: 100%;
            height: 100%;
        }

        .control-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .animation-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .play-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            background: #047857;
            transform: scale(1.05);
        }

        .material-properties {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 2px solid var(--danger-red);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.85rem;
        }

        .hvl-display {
            background: #1f2937;
            color: #10b981;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            text-align: center;
        }

        .educational-note {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-left: 4px solid var(--warning-orange);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 300px 1fr 320px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            
            .instruction-panel, .control-panel {
                height: auto;
                max-height: 400px;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">
            ğŸ›¡ï¸ Poker MCP Level 1: åŸºç¤ç¿’å¾—
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="main-progress" style="width: 0%"></div>
            </div>
            <div class="level-indicator">ç†è«–ç†è§£ â†’ ä½“é¨“å­¦ç¿’ â†’ å®Ÿè·µå¿œç”¨ (15åˆ†ç›®æ¨™)</div>
        </div>
        <div class="current-step" id="current-step-display">Step 1/4</div>
    </header>

    <main class="main-content">
        <div class="instruction-panel">
            <div class="step-indicator" id="step-indicator">Step 1: æ”¾å°„ç·šé®è”½ã®ç‰©ç†å­¦åŸç†</div>
            <div id="instruction-content">
                <h2>ğŸ”¬ æ”¾å°„ç·šé®è”½ã®åŸºæœ¬æ³•å‰‡</h2>
                
                <div class="concept-box">
                    <h3>ğŸ“ æ¸›è¡°ã®æŒ‡æ•°æ³•å‰‡</h3>
                    <p>æ”¾å°„ç·šã®å¼·åº¦ã¯é®è”½æã®åšã•ã«å¯¾ã—ã¦<strong>æŒ‡æ•°é–¢æ•°çš„ã«æ¸›è¡°</strong>ã—ã¾ã™ã€‚</p>
                    
                    <div class="physics-formula">
                        I = Iâ‚€ Ã— e^(-Î¼t) Ã— B(Î¼t)
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <strong>ğŸ§® å„é …ã®ç‰©ç†çš„æ„å‘³:</strong><br>
                        â€¢ <strong>Iâ‚€</strong>: å…¥å°„ç·šé‡ç‡ [Gy/s]<br>
                        â€¢ <strong>I</strong>: é€éç·šé‡ç‡ [Gy/s]<br>
                        â€¢ <strong>Î¼</strong>: ç·šæ¸›è¡°ä¿‚æ•° [cmâ»Â¹]<br>
                        â€¢ <strong>t</strong>: é®è”½åšã• [cm]<br>
                        â€¢ <strong>B(Î¼t)</strong>: ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ä¿‚æ•° [-]
                    </div>
                </div>

                <div class="key-insight">
                    <strong>ğŸ’¡ ç ”ç©¶è€…ã«ã¨ã£ã¦é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ</strong><br>
                    ç·šæ¸›è¡°ä¿‚æ•°Î¼ã¯ææ–™ã®<strong>å¯†åº¦ã¨åŸå­ç•ªå·</strong>ã«ä¾å­˜ã—ã¾ã™ã€‚<br>
                    Î¼ = (Î¼/Ï) Ã— Ï<br>
                    è³ªé‡æ¸›è¡°ä¿‚æ•°ã¯ææ–™å›ºæœ‰ã€ç·šæ¸›è¡°ä¿‚æ•°ã¯å¯†åº¦ã‚’å«ã‚€å®ŸåŠ¹å€¤ã§ã™ã€‚
                </div>

                <div class="research-context">
                    <strong>ğŸ”¬ ç¾ä»£ã®ç ”ç©¶å‹•å‘ (2024å¹´)</strong><br>
                    â€¢ <strong>ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•</strong>: PHITSãƒ»Geant4ã«ã‚ˆã‚‹é«˜ç²¾åº¦è¨ˆç®—<br>
                    â€¢ <strong>AIæœ€é©åŒ–</strong>: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹é®è”½è¨­è¨ˆè‡ªå‹•åŒ–<br>
                    â€¢ <strong>æ–°ææ–™</strong>: ãƒŠãƒã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆãƒ»è¤‡åˆé®è”½æã®é–‹ç™º<br>
                    â€¢ <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è§£æ</strong>: GPUä¸¦åˆ—è¨ˆç®—ã«ã‚ˆã‚‹å³åº§è©•ä¾¡
                </div>
            </div>
        </div>

        <div class="visualization-panel">
            <div id="threejs-container"></div>
            <div class="control-overlay">
                <button class="control-btn" id="view-3d" title="3Dè¡¨ç¤ºåˆ‡æ›¿">ğŸ”„ 3Då›è»¢</button>
                <button class="control-btn" id="view-cross" title="æ–­é¢è¡¨ç¤º">ğŸ“ æ–­é¢å›³</button>
                <button class="control-btn" id="reset-view" title="è¦–ç‚¹ãƒªã‚»ãƒƒãƒˆ">ğŸ  ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="animation-controls">
                <button class="play-btn" id="play-animation">â–¶ï¸ æ”¾å°„ç·šé£›è·¡</button>
                <button class="play-btn" id="pause-animation" style="display: none;">â¸ï¸ åœæ­¢</button>
                <button class="play-btn" id="show-field">ğŸŒŠ ç·šé‡åˆ†å¸ƒ</button>
            </div>
        </div>

        <div class="control-panel">
            <div class="parameter-section">
                <h3>ğŸ§ª é®è”½ææ–™ç‰¹æ€§</h3>
                
                <div class="parameter-group">
                    <label>ææ–™é¸æŠ</label>
                    <select class="parameter-input" id="shield-material">
                        <option value="lead">é‰› (Pb) - Z=82</option>
                        <option value="steel">é‰„ãƒ»é‹¼é‰„ (Fe) - Z=26</option>
                        <option value="concrete" selected>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ - è¤‡åˆæ</option>
                        <option value="aluminum">ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ  (Al) - Z=13</option>
                        <option value="tungsten">ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³ (W) - Z=74</option>
                        <option value="barite">ãƒãƒ©ã‚¤ãƒˆã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option>
                    </select>
                </div>

                <div class="material-properties" id="material-properties">
                    <strong>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ ã®ç‰¹æ€§:</strong><br>
                    â€¢ å¯†åº¦: 2.3 g/cmÂ³<br>
                    â€¢ è³ªé‡æ¸›è¡°ä¿‚æ•°: 0.0636 cmÂ²/g<br>
                    â€¢ ç·šæ¸›è¡°ä¿‚æ•°: 0.146 cmâ»Â¹<br>
                    â€¢ åŠä¾¡å±¤åš: 4.7 cm
                </div>

                <div class="parameter-group">
                    <label>åšã• (cm)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="thickness-slider" 
                               min="0" max="100" value="10" step="1">
                        <span class="slider-value" id="thickness-value">10 cm</span>
                    </div>
                    
                    <div class="hvl-display" id="hvl-display">
                        ç¾åœ¨ã®åšã•: 2.1 HVL (æ¸›è¡°ç‡: 76.9%)
                    </div>
                </div>
            </div>

            <div class="parameter-section">
                <h3>ğŸ“ å¹¾ä½•å­¦çš„é…ç½®</h3>
                
                <div class="parameter-group">
                    <label>ç·šæº-é®è”½ä½“è·é›¢ (cm)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="source-distance" 
                               min="10" max="100" value="50" step="5">
                        <span class="slider-value" id="source-distance-value">50 cm</span>
                    </div>
                </div>

                <div class="parameter-group">
                    <label>é®è”½ä½“-æ¤œå‡ºå™¨è·é›¢ (cm)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="detector-distance" 
                               min="10" max="100" value="50" step="5">
                        <span class="slider-value" id="detector-distance-value">50 cm</span>
                    </div>
                </div>
            </div>

            <div class="parameter-section">
                <h3>â˜¢ï¸ ç·šæºè¨­å®š</h3>
                
                <div class="parameter-group">
                    <label>æ ¸ç¨®ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼</label>
                    <select class="parameter-input" id="radiation-source">
                        <option value="cs137" selected>Cs-137 (662 keV)</option>
                        <option value="co60">Co-60 (1.25 MeVå¹³å‡)</option>
                        <option value="ir192">Ir-192 (380 keVå¹³å‡)</option>
                        <option value="generic_1mev">æ±ç”¨ (1 MeV)</option>
                    </select>
                </div>

                <div class="parameter-group">
                    <label>æ”¾å°„èƒ½ (Bq)</label>
                    <select class="parameter-input" id="source-activity">
                        <option value="3.7e9">3.7Ã—10â¹ (100 mCi)</option>
                        <option value="3.7e10" selected>3.7Ã—10Â¹â° (1 Ci)</option>
                        <option value="3.7e11">3.7Ã—10Â¹Â¹ (10 Ci)</option>
                        <option value="3.7e12">3.7Ã—10Â¹Â² (100 Ci)</option>
                    </select>
                </div>
            </div>

            <button class="primary-btn" id="calculate-btn">âš¡ é«˜ç²¾åº¦é®è”½è¨ˆç®—å®Ÿè¡Œ</button>

            <div class="results-display" id="results-display">
                <h4 style="text-align: center; margin-bottom: 1rem; color: var(--primary-blue);">ğŸ“Š è¨ˆç®—çµæœ</h4>
                
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-label">é€éç·šé‡ç‡</div>
                        <div class="result-value" id="dose-rate-result">-- Î¼Sv/h</div>
                        <div class="result-status" id="safety-status">--</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">æ¸›è¡°ç‡</div>
                        <div class="result-value" id="attenuation-result">-- %</div>
                        <div class="result-status" id="attenuation-status">--</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ä¿‚æ•°</div>
                        <div class="result-value" id="buildup-result">--</div>
                        <div class="result-status" id="buildup-status">--</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">åŠä¾¡å±¤åšæ¯”</div>
                        <div class="result-value" id="hvl-ratio">-- HVL</div>
                        <div class="result-status" id="hvl-status">--</div>
                    </div>
                </div>

                <div class="comparison-table" id="comparison-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>ææ–™</th>
                                <th>å¯†åº¦<br>[g/cmÂ³]</th>
                                <th>Î¼/Ï<br>[cmÂ²/g]</th>
                                <th>HVL<br>[cm]</th>
                                <th>ç›¸å¯¾åŠ¹ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="navigation-footer">
        <button class="nav-btn secondary" id="prev-step" disabled>â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—</button>
        <div style="display: flex; gap: 1rem;">
            <button class="nav-btn secondary" id="hint-btn">ğŸ’¡ ç‰©ç†è§£èª¬</button>
            <button class="nav-btn secondary" id="compare-materials">ğŸ“Š ææ–™æ¯”è¼ƒ</button>
            <button class="nav-btn secondary" id="restart-btn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <button class="nav-btn primary" id="next-step">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’</button>
    </footer>

    <script>
        // æ”¹è‰¯ã•ã‚ŒãŸç‰©ç†å®šæ•°ãƒ»ææ–™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (2024å¹´æœ€æ–°ãƒ‡ãƒ¼ã‚¿)
        const materialDatabase = {
            lead: { 
                density: 11.34, 
                muMass: 0.107, 
                color: 0x696969, 
                name: 'é‰›',
                atomicNumber: 82,
                cost: 8.5, // ç›¸å¯¾ã‚³ã‚¹ãƒˆ
                applications: 'åŒ»ç™‚é®è”½ãƒ»å·¥æ¥­æ¤œæŸ»'
            },
            steel: { 
                density: 7.87, 
                muMass: 0.0565, 
                color: 0x708090, 
                name: 'é‰„ãƒ»é‹¼é‰„',
                atomicNumber: 26,
                cost: 2.0,
                applications: 'æ§‹é€ æãƒ»äºŒæ¬¡é®è”½'
            },
            concrete: { 
                density: 2.3, 
                muMass: 0.0636, 
                color: 0xd2b48c, 
                name: 'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ',
                atomicNumber: 11.6, // å®ŸåŠ¹åŸå­ç•ªå·
                cost: 1.0,
                applications: 'å»ºç¯‰é®è”½ãƒ»å¤§å‹æ–½è¨­'
            },
            aluminum: { 
                density: 2.70, 
                muMass: 0.0820, 
                color: 0xc0c0c0, 
                name: 'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ',
                atomicNumber: 13,
                cost: 3.2,
                applications: 'è»½é‡é®è”½ãƒ»èˆªç©ºå®‡å®™'
            },
            tungsten: { 
                density: 19.25, 
                muMass: 0.0947, 
                color: 0x404040, 
                name: 'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³',
                atomicNumber: 74,
                cost: 25.0,
                applications: 'é«˜æ€§èƒ½é®è”½ãƒ»åŒ»ç™‚'
            },
            barite: { 
                density: 4.2, 
                muMass: 0.0620, 
                color: 0x8b7355, 
                name: 'ãƒãƒ©ã‚¤ãƒˆã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ',
                atomicNumber: 16.2,
                cost: 2.8,
                applications: 'åŒ»ç™‚æ–½è¨­ãƒ»é‡é®è”½'
            }
        };

        const sourceDatabase = {
            cs137: { energy: 0.662, name: 'Cs-137', gammaConstant: 0.325 },
            co60: { energy: 1.25, name: 'Co-60', gammaConstant: 1.32 },
            ir192: { energy: 0.38, name: 'Ir-192', gammaConstant: 0.48 },
            generic_1mev: { energy: 1.0, name: '1 MeV Î³ç·š', gammaConstant: 0.85 }
        };

        let scene, camera, renderer;
        let shieldGeometry, sourceGeometry, detectorGeometry;
        let currentStep = 1;
        let isAnimationPlaying = false;
        let particleSystem = null;

        // æ”¹è‰¯ã•ã‚ŒãŸå­¦ç¿’é€²è¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class AdvancedLearningManager {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 4;
                this.completedActions = new Set();
                this.startTime = Date.now();
                this.interactionCount = 0;
                this.calculationCount = 0;
            }

            updateProgress() {
                const progress = Math.max(0, (this.currentStep - 1) / (this.totalSteps - 1) * 100);
                document.getElementById('main-progress').style.width = progress + '%';
                document.getElementById('current-step-display').textContent = `Step ${this.currentStep}/${this.totalSteps}`;
            }

            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    this.updateStepContent();
                    this.updateProgress();
                } else {
                    this.completeLevel1();
                }
            }

            previousStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepContent();
                    this.updateProgress();
                }
            }

            updateStepContent() {
                const stepContents = {
                    1: {
                        title: 'Step 1: æ”¾å°„ç·šé®è”½ã®ç‰©ç†å­¦åŸç†',
                        content: `
                            <h2>ğŸ”¬ æ”¾å°„ç·šé®è”½ã®åŸºæœ¬æ³•å‰‡</h2>
                            
                            <div class="concept-box">
                                <h3>ğŸ“ æ¸›è¡°ã®æŒ‡æ•°æ³•å‰‡</h3>
                                <p>æ”¾å°„ç·šã®å¼·åº¦ã¯é®è”½æã®åšã•ã«å¯¾ã—ã¦<strong>æŒ‡æ•°é–¢æ•°çš„ã«æ¸›è¡°</strong>ã—ã¾ã™ã€‚</p>
                                
                                <div class="physics-formula">
                                    I = Iâ‚€ Ã— e^(-Î¼t) Ã— B(Î¼t)
                                </div>
                                
                                <div style="margin-top: 1rem;">
                                    <strong>ğŸ§® å„é …ã®ç‰©ç†çš„æ„å‘³:</strong><br>
                                    â€¢ <strong>Iâ‚€</strong>: å…¥å°„ç·šé‡ç‡ [Gy/s]<br>
                                    â€¢ <strong>I</strong>: é€éç·šé‡ç‡ [Gy/s]<br>
                                    â€¢ <strong>Î¼</strong>: ç·šæ¸›è¡°ä¿‚æ•° [cmâ»Â¹]<br>
                                    â€¢ <strong>t</strong>: é®è”½åšã• [cm]<br>
                                    â€¢ <strong>B(Î¼t)</strong>: ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ä¿‚æ•° [-]
                                </div>
                            </div>

                            <div class="key-insight">
                                <strong>ğŸ’¡ ç ”ç©¶è€…ã«ã¨ã£ã¦é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ</strong><br>
                                ç·šæ¸›è¡°ä¿‚æ•°Î¼ã¯ææ–™ã®<strong>å¯†åº¦ã¨åŸå­ç•ªå·</strong>ã«ä¾å­˜ã—ã¾ã™ã€‚<br>
                                Î¼ = (Î¼/Ï) Ã— Ï<br>
                                è³ªé‡æ¸›è¡°ä¿‚æ•°ã¯ææ–™å›ºæœ‰ã€ç·šæ¸›è¡°ä¿‚æ•°ã¯å¯†åº¦ã‚’å«ã‚€å®ŸåŠ¹å€¤ã§ã™ã€‚
                            </div>

                            <div class="research-context">
                                <strong>ğŸ”¬ ç¾ä»£ã®ç ”ç©¶å‹•å‘ (2024å¹´)</strong><br>
                                â€¢ <strong>ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•</strong>: PHITSãƒ»Geant4ã«ã‚ˆã‚‹é«˜ç²¾åº¦è¨ˆç®—<br>
                                â€¢ <strong>AIæœ€é©åŒ–</strong>: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹é®è”½è¨­è¨ˆè‡ªå‹•åŒ–<br>
                                â€¢ <strong>æ–°ææ–™</strong>: ãƒŠãƒã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆãƒ»è¤‡åˆé®è”½æã®é–‹ç™º<br>
                                â€¢ <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è§£æ</strong>: GPUä¸¦åˆ—è¨ˆç®—ã«ã‚ˆã‚‹å³åº§è©•ä¾¡
                            </div>
                        `
                    },
                    2: {
                        title: 'Step 2: ææ–™ç‰¹æ€§ã®å®šé‡çš„ç†è§£',
                        content: `
                            <h2>ğŸ§ª ææ–™ã«ã‚ˆã‚‹é®è”½æ€§èƒ½ã®é•ã„</h2>
                            
                            <div class="concept-box">
                                <h3>ğŸ“Š ææ–™é¸æŠã®ç§‘å­¦çš„æ ¹æ‹ </h3>
                                <p>é®è”½åŠ¹æœã¯<strong>åŸå­ç•ªå·Zã¨å¯†åº¦Ï</strong>ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ã€‚</p>
                                
                                <div class="physics-formula">
                                    Î¼/Ï âˆ Z^n / A
                                </div>
                                
                                <p style="text-align: center; margin-top: 0.5rem; color: #6b7280;">
                                    nã¯3-5ï¼ˆå…‰é›»åŠ¹æœå„ªå‹¢é ˜åŸŸï¼‰ã€Aã¯åŸå­è³ªé‡
                                </p>
                            </div>

                            <div class="key-insight">
                                <strong>ğŸ’¡ å®Ÿç”¨çš„ãªææ–™é¸æŠæŒ‡é‡</strong><br>
                                â€¢ <strong>é‰›ãƒ»ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³</strong>: å°ã‚¹ãƒšãƒ¼ã‚¹ãƒ»é«˜æ€§èƒ½ãŒå¿…è¦<br>
                                â€¢ <strong>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</strong>: å¤§å‹æ–½è¨­ãƒ»ã‚³ã‚¹ãƒˆé‡è¦–<br>
                                â€¢ <strong>è¤‡åˆæ</strong>: ç‰¹å®šç”¨é€”ã¸ã®æœ€é©åŒ–
                            </div>

                            <div class="educational-note">
                                <strong>ğŸ¯ å³å´ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</strong><br>
                                ææ–™ã‚’å¤‰æ›´ã—ã¦ã€åŠä¾¡å±¤åšã‚„æ¸›è¡°ç‡ã®å¤‰åŒ–ã‚’è¦³å¯Ÿã—ã¦ãã ã•ã„ã€‚
                                è¨ˆç®—å®Ÿè¡Œãƒœã‚¿ãƒ³ã§å®šé‡çš„ãªçµæœã‚‚ç¢ºèªã§ãã¾ã™ã€‚
                            </div>
                        `
                    },
                    3: {
                        title: 'Step 3: å¹¾ä½•å­¦çš„è¦å› ã¨è·é›¢åŠ¹æœ',
                        content: `
                            <h2>ğŸ“ è·é›¢ã¨å½¢çŠ¶ã®å½±éŸ¿</h2>
                            
                            <div class="concept-box">
                                <h3>ğŸ“ è·é›¢ã®é€†äºŒä¹—å‰‡</h3>
                                <p>ç‚¹ç·šæºã‹ã‚‰ã®ç·šé‡ç‡ã¯<strong>è·é›¢ã®äºŒä¹—ã«åæ¯”ä¾‹</strong>ã—ã¾ã™ã€‚</p>
                                
                                <div class="physics-formula">
                                    á¸Š = á¸Šâ‚€ Ã— (râ‚€/r)Â²
                                </div>
                                
                                <p style="text-align: center; margin-top: 0.5rem; color: #6b7280;">
                                    è·é›¢ã‚’2å€ã«ã™ã‚‹ã¨ç·šé‡ç‡ã¯1/4ã«æ¸›å°‘
                                </p>
                            </div>

                            <div class="key-insight">
                                <strong>ğŸ’¡ å®Ÿéš›ã®è¨­è¨ˆã§ã®è€ƒæ…®äº‹é …</strong><br>
                                â€¢ <strong>æ•£ä¹±ç·š</strong>: 1æ¬¡ç·šã¨ã¯ç•°ãªã‚‹è§’åº¦åˆ†å¸ƒ<br>
                                â€¢ <strong>ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—</strong>: åšã„é®è”½ã§ã®æ•£ä¹±ç·šè“„ç©<br>
                                â€¢ <strong>å½¢çŠ¶å› å­</strong>: ç·šæºãƒ»æ¤œå‡ºå™¨ã®å¤§ãã•ã¨å½¢çŠ¶
                            </div>

                            <div class="educational-note">
                                <strong>ğŸ¯ è·é›¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</strong><br>
                                ç·šæº-é®è”½ä½“ã€é®è”½ä½“-æ¤œå‡ºå™¨ã®è·é›¢ã‚’å¤‰ãˆã¦ã€
                                å…¨ä½“ã®é®è”½åŠ¹æœãŒã©ã†å¤‰åŒ–ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                            </div>
                        `
                    },
                    4: {
                        title: 'Step 4: å®Ÿç”¨è¨­è¨ˆã¸ã®å¿œç”¨',
                        content: `
                            <h2>ğŸ—ï¸ å®Ÿéš›ã®é®è”½è¨­è¨ˆæ‰‹é †</h2>
                            
                            <div class="concept-box">
                                <h3>ğŸ¯ è¨­è¨ˆç›®æ¨™ã®è¨­å®š</h3>
                                <p>è¦åˆ¶è¦æ±‚å€¤ã‚’æº€ãŸã™é®è”½åšã‚’åŠ¹ç‡çš„ã«æ±ºå®šã—ã¾ã™ã€‚</p>
                                
                                <div class="physics-formula">
                                    t = ln(Iâ‚€/I_target) / Î¼
                                </div>
                                
                                <p style="text-align: center; margin-top: 0.5rem; color: #6b7280;">
                                    ç°¡ç•¥åŒ–ï¼ˆãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ç„¡è¦–æ™‚ï¼‰ã®è¿‘ä¼¼å¼
                                </p>
                            </div>

                            <div class="key-insight">
                                <strong>ğŸ’¡ å®Ÿç”¨è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ</strong><br>
                                â€¢ <strong>å®‰å…¨ä¿‚æ•°</strong>: è¨ˆç®—å€¤ã®1.5-2å€ç¨‹åº¦<br>
                                â€¢ <strong>çµŒæ¸ˆæ€§è©•ä¾¡</strong>: ææ–™ã‚³ã‚¹ãƒˆãƒ»æ–½å·¥æ€§ãƒ»ä¿å®ˆæ€§<br>
                                â€¢ <strong>æ³•è¦åˆ¶å¯¾å¿œ</strong>: å„åˆ†é‡ã®è¦åˆ¶åŸºæº–å€¤éµå®ˆ
                            </div>

                            <div class="research-context">
                                <strong>ğŸ”¬ æœ€æ–°ã®è¨­è¨ˆæ‰‹æ³•</strong><br>
                                â€¢ <strong>æœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </strong>: å¤šç›®çš„æœ€é©åŒ–ã«ã‚ˆã‚‹è¨­è¨ˆ<br>
                                â€¢ <strong>ä¸ç¢ºå®Ÿæ€§è§£æ</strong>: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã«ã‚ˆã‚‹ä¿¡é ¼åŒºé–“<br>
                                â€¢ <strong>ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ„ã‚¤ãƒ³</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ»äºˆæ¸¬
                            </div>

                            <div class="educational-note">
                                <strong>ğŸ‰ Level 1 å®Œäº†æº–å‚™</strong><br>
                                æ§˜ã€…ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã¦ã€é®è”½è¨­è¨ˆã®æ„Ÿè¦šã‚’æ´ã¿ã¾ã—ã‚‡ã†ã€‚
                                æ¬¡ã®Level 2ã§ã¯ã€å®Ÿéš›ã®æ–½è¨­è¨­è¨ˆã‚’ä½“é¨“ã—ã¾ã™ï¼
                            </div>
                        `
                    }
                };

                const stepData = stepContents[this.currentStep];
                document.getElementById('step-indicator').textContent = stepData.title;
                document.getElementById('instruction-content').innerHTML = stepData.content;

                // ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ãŸãƒœã‚¿ãƒ³çŠ¶æ…‹
                document.getElementById('prev-step').disabled = this.currentStep === 1;
                document.getElementById('next-step').textContent = 
                    this.currentStep === this.totalSteps ? 'Level 2ã¸é€²ã‚€ â†’' : 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’';
            }

            completeLevel1() {
                const completionTime = (Date.now() - this.startTime) / 1000;
                const completionData = {
                    level: 1,
                    completionTime: completionTime,
                    interactionCount: this.interactionCount,
                    calculationCount: this.calculationCount,
                    completedAt: new Date().toISOString(),
                    finalStep: this.currentStep
                };

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('poker_mcp_level1_completion', JSON.stringify(completionData));
                localStorage.setItem('poker_mcp_level1_completed', 'true');

                alert(`ğŸ‰ Level 1 åŸºç¤ç¿’å¾—å®Œäº†ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n` +
                      `å®Œäº†æ™‚é–“: ${Math.round(completionTime)}ç§’\n` +
                      `æ“ä½œå›æ•°: ${this.interactionCount}å›\n` +
                      `è¨ˆç®—å®Ÿè¡Œ: ${this.calculationCount}å›\n\n` +
                      `Level 2: å®Ÿç”¨è¨­è¨ˆ ã§æ›´ãªã‚‹ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ï¼`);

                // Level 2ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ï¼‰
                if (confirm('Level 2: å®Ÿç”¨è¨­è¨ˆã«é€²ã¿ã¾ã™ã‹ï¼Ÿ')) {
                    window.location.href = 'interactive_guide_level2.html';
                }
            }

            trackInteraction(type, data) {
                this.interactionCount++;
                this.completedActions.add(`${type}_${Date.now()}`);
                console.log('Interaction tracked:', type, data);
            }

            trackCalculation(results) {
                this.calculationCount++;
                this.trackInteraction('calculation', results);
            }
        }

        // é«˜åº¦ãª3Då¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ 
        class Advanced3DVisualizer {
            constructor(container) {
                this.container = container;
                this.initializeScene();
                this.createObjects();
                this.setupControls();
                this.animate();
            }

            initializeScene() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f4f8);

                camera = new THREE.PerspectiveCamera(75, 
                    this.container.clientWidth / this.container.clientHeight, 0.1, 1000);
                camera.position.set(8, 6, 12);
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.container.appendChild(renderer.domElement);

                // æ”¹è‰¯ã•ã‚ŒãŸãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 20, 10);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);

                // åº§æ¨™ç³»ã¨ã‚°ãƒªãƒƒãƒ‰
                const axesHelper = new THREE.AxesHelper(5);
                scene.add(axesHelper);

                const gridHelper = new THREE.GridHelper(20, 20, 0xcccccc, 0xeeeeee);
                scene.add(gridHelper);
            }

            createObjects() {
                this.createSource();
                this.createShield();
                this.createDetector();
                this.createEnvironment();
                this.updatePositions();
            }

            createSource() {
                const sourceGeom = new THREE.SphereGeometry(0.3, 32, 32);
                const sourceMat = new THREE.MeshLambertMaterial({ 
                    color: 0xff4444,
                    emissive: 0x330000
                });
                sourceGeometry = new THREE.Mesh(sourceGeom, sourceMat);
                sourceGeometry.position.set(-5, 1, 0);
                sourceGeometry.castShadow = true;
                scene.add(sourceGeometry);

                // ç·šæºãƒ©ãƒ™ãƒ«ï¼ˆç°¡ç•¥åŒ–ï¼‰
                this.addObjectLabel(sourceGeometry, 'â˜¢ï¸ ç·šæº', 0xff4444);
            }

            createShield() {
                // åˆæœŸé®è”½æä½œæˆï¼ˆå¾Œã§æ›´æ–°ï¼‰
                this.updateShield('concrete', 1.0);
            }

            updateShield(material, thickness) {
                if (shieldGeometry) {
                    scene.remove(shieldGeometry);
                }

                if (thickness > 0) {
                    const materialData = materialDatabase[material];
                    const shieldGeom = new THREE.BoxGeometry(thickness, 4, 3);
                    const shieldMat = new THREE.MeshLambertMaterial({ 
                        color: materialData.color,
                        transparent: true,
                        opacity: 0.7
                    });
                    shieldGeometry = new THREE.Mesh(shieldGeom, shieldMat);
                    shieldGeometry.position.set(0, 2, 0);
                    shieldGeometry.castShadow = true;
                    shieldGeometry.receiveShadow = true;
                    scene.add(shieldGeometry);

                    this.addObjectLabel(shieldGeometry, 
                        `ğŸ›¡ï¸ ${materialData.name}\n${thickness.toFixed(1)} cm`, 
                        materialData.color);
                }
            }

            createDetector() {
                const detectorGeom = new THREE.SphereGeometry(0.25, 24, 24);
                const detectorMat = new THREE.MeshLambertMaterial({ 
                    color: 0x44ff44,
                    emissive: 0x002200
                });
                detectorGeometry = new THREE.Mesh(detectorGeom, detectorMat);
                detectorGeometry.position.set(5, 1, 0);
                detectorGeometry.castShadow = true;
                scene.add(detectorGeometry);

                this.addObjectLabel(detectorGeometry, 'ğŸ“¡ æ¤œå‡ºå™¨', 0x44ff44);
            }

            createEnvironment() {
                // åºŠé¢
                const floorGeometry = new THREE.PlaneGeometry(30, 20);
                const floorMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xf5f5f5,
                    transparent: true,
                    opacity: 0.3
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.position.y = -1;
                floor.receiveShadow = true;
                scene.add(floor);
            }

            addObjectLabel(object, text, color) {
                // ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«è¡¨ç¤ºï¼ˆå®Ÿéš›ã«ã¯CSS3Dãªã©ã‚’ä½¿ç”¨ï¼‰
                console.log(`Label for ${object.constructor.name}: ${text}`);
            }

            updatePositions() {
                const sourceDistance = parseFloat(document.getElementById('source-distance')?.value || 50);
                const detectorDistance = parseFloat(document.getElementById('detector-distance')?.value || 50);
                
                if (sourceGeometry) {
                    sourceGeometry.position.x = -(sourceDistance / 10);
                }
                
                if (detectorGeometry) {
                    detectorGeometry.position.x = detectorDistance / 10;
                }

                this.createRadiationPaths();
            }

            createRadiationPaths() {
                // æ”¾å°„ç·šçµŒè·¯ã®å¯è¦–åŒ–
                const pathMaterial = new THREE.LineBasicMaterial({ 
                    color: 0xff6666,
                    transparent: true,
                    opacity: 0.6
                });

                // æ—¢å­˜ã®ãƒ‘ã‚¹ã‚’å‰Šé™¤
                scene.children.forEach(child => {
                    if (child.userData.isRadiationPath) {
                        scene.remove(child);
                    }
                });

                // æ–°ã—ã„ãƒ‘ã‚¹ä½œæˆ
                const points = [];
                points.push(sourceGeometry.position.clone());
                points.push(detectorGeometry.position.clone());

                const pathGeometry = new THREE.BufferGeometry().setFromPoints(points);
                const pathLine = new THREE.Line(pathGeometry, pathMaterial);
                pathLine.userData.isRadiationPath = true;
                scene.add(pathLine);
            }

            setupControls() {
                let isMouseDown = false;
                let mouseX = 0, mouseY = 0;
                let targetRotationX = 0.2, targetRotationY = 0.5;
                let currentDistance = 15;

                this.container.addEventListener('mousedown', (event) => {
                    isMouseDown = true;
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });

                this.container.addEventListener('mousemove', (event) => {
                    if (!isMouseDown) return;
                    
                    const deltaX = event.clientX - mouseX;
                    const deltaY = event.clientY - mouseY;
                    
                    targetRotationY += deltaX * 0.01;
                    targetRotationX += deltaY * 0.01;
                    targetRotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, targetRotationX));
                    
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });

                this.container.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });

                this.container.addEventListener('wheel', (event) => {
                    event.preventDefault();
                    currentDistance += event.deltaY * 0.02;
                    currentDistance = Math.max(5, Math.min(30, currentDistance));
                });

                // ã‚«ãƒ¡ãƒ©ä½ç½®æ›´æ–°
                const updateCamera = () => {
                    const x = currentDistance * Math.sin(targetRotationY) * Math.cos(targetRotationX);
                    const y = currentDistance * Math.sin(targetRotationX) + 3;
                    const z = currentDistance * Math.cos(targetRotationY) * Math.cos(targetRotationX);
                    
                    camera.position.x = x;
                    camera.position.y = y;
                    camera.position.z = z;
                    camera.lookAt(0, 2, 0);
                    
                    requestAnimationFrame(updateCamera);
                };
                updateCamera();
            }

            animate() {
                const render = () => {
                    requestAnimationFrame(render);
                    
                    if (sourceGeometry) {
                        sourceGeometry.rotation.y += 0.02;
                    }
                    
                    renderer.render(scene, camera);
                };
                render();
            }

            playRadiationAnimation() {
                if (isAnimationPlaying || !sourceGeometry || !detectorGeometry) return;
                
                isAnimationPlaying = true;
                
                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä½œæˆ
                const particleCount = 20;
                const particles = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                
                for (let i = 0; i < particleCount; i++) {
                    positions[i * 3] = sourceGeometry.position.x;
                    positions[i * 3 + 1] = sourceGeometry.position.y;
                    positions[i * 3 + 2] = sourceGeometry.position.z;
                }
                
                particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const particleMaterial = new THREE.PointsMaterial({
                    color: 0xff6666,
                    size: 0.2,
                    transparent: true,
                    opacity: 0.8
                });
                
                particleSystem = new THREE.Points(particles, particleMaterial);
                scene.add(particleSystem);
                
                this.animateParticles();
            }

            animateParticles() {
                if (!isAnimationPlaying || !particleSystem) return;
                
                const positions = particleSystem.geometry.attributes.position.array;
                const sourcePos = sourceGeometry.position;
                const detectorPos = detectorGeometry.position;
                const direction = detectorPos.clone().sub(sourcePos).normalize();
                
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i] += direction.x * 0.1;
                    positions[i + 1] += direction.y * 0.1;
                    positions[i + 2] += direction.z * 0.1;
                    
                    // ãƒªã‚»ãƒƒãƒˆæ¡ä»¶
                    if (positions[i] > detectorPos.x) {
                        positions[i] = sourcePos.x;
                        positions[i + 1] = sourcePos.y;
                        positions[i + 2] = sourcePos.z;
                    }
                }
                
                particleSystem.geometry.attributes.position.needsUpdate = true;
                
                setTimeout(() => this.animateParticles(), 50);
            }

            stopRadiationAnimation() {
                isAnimationPlaying = false;
                if (particleSystem) {
                    scene.remove(particleSystem);
                    particleSystem = null;
                }
            }
        }

        // é«˜ç²¾åº¦è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³
        class AdvancedShieldingCalculator {
            constructor() {
                this.safetyLimits = {
                    general: 2.5, // Î¼Sv/h
                    occupational: 25.0, // Î¼Sv/h
                    medical: 10.0 // Î¼Sv/h
                };
            }

            calculate(materialKey, thickness, sourceDistance, detectorDistance, sourceKey, activity) {
                const material = materialDatabase[materialKey];
                const source = sourceDatabase[sourceKey];
                
                // ç·šæ¸›è¡°ä¿‚æ•°
                const mu = material.muMass * material.density;
                
                // ã‚¨ãƒãƒ«ã‚®ãƒ¼ä¾å­˜æ€§ã‚’è€ƒæ…®ï¼ˆç°¡ç•¥åŒ–ï¼‰
                const energyFactor = this.getEnergyDependence(source.energy, material.atomicNumber);
                const effectiveMu = mu * energyFactor;
                
                // åŸºæœ¬æ¸›è¡°
                const basicAttenuation = Math.exp(-effectiveMu * thickness);
                
                // ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ä¿‚æ•°ï¼ˆBerger-Seltzerè¿‘ä¼¼ï¼‰
                const buildup = this.calculateBuildup(effectiveMu, thickness);
                
                // è·é›¢ã«ã‚ˆã‚‹å¹¾ä½•å­¦çš„æ¸›è¡°
                const totalDistance = sourceDistance + detectorDistance;
                const geometricFactor = Math.pow(totalDistance / 100, -2); // 1måŸºæº–
                
                // ç·šé‡ç‡è¨ˆç®—
                const gammaConstant = source.gammaConstant; // RÂ·cmÂ²/hÂ·Ci
                const activityCi = activity / 3.7e10;
                
                const unshieldedRate = activityCi * gammaConstant * geometricFactor * 10; // Î¼Sv/hæ›ç®—
                const shieldedRate = unshieldedRate * basicAttenuation * buildup;
                
                // åŠä¾¡å±¤åšï¼ˆHVLï¼‰
                const hvl = Math.log(2) / effectiveMu;
                const hvlRatio = thickness / hvl;
                
                return {
                    unshieldedRate: unshieldedRate,
                    shieldedRate: Math.max(shieldedRate, 0.001),
                    basicAttenuation: basicAttenuation,
                    buildup: buildup,
                    totalAttenuation: basicAttenuation * buildup,
                    attenuationPercent: (1 - basicAttenuation * buildup) * 100,
                    hvl: hvl,
                    hvlRatio: hvlRatio,
                    geometricFactor: geometricFactor,
                    safetyStatus: this.evaluateSafety(shieldedRate),
                    materialEfficiency: this.calculateEfficiency(material, thickness)
                };
            }

            getEnergyDependence(energy, atomicNumber) {
                // ç°¡ç•¥åŒ–ã•ã‚ŒãŸã‚¨ãƒãƒ«ã‚®ãƒ¼ä¾å­˜æ€§
                // å®Ÿéš›ã«ã¯NISTãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ã‚’å‚ç…§
                const photoelectricFactor = Math.pow(atomicNumber, 3.8) / Math.pow(energy, 3.2);
                const comptonFactor = 1 / energy;
                return Math.max(0.1, photoelectricFactor + comptonFactor);
            }

            calculateBuildup(mu, thickness) {
                // Taylor-Bergerè¿‘ä¼¼
                const muT = mu * thickness;
                if (muT < 0.01) return 1.0;
                
                const a = 1.0;
                const b = 1.5;
                return 1 + a * muT * Math.exp(-b * muT) + (muT - 1 + Math.exp(-muT)) / 2;
            }

            evaluateSafety(doseRate) {
                if (doseRate <= this.safetyLimits.general) {
                    return { level: 'excellent', text: 'âœ“ åŸºæº–å€¤ä»¥ä¸‹' };
                } else if (doseRate <= this.safetyLimits.medical) {
                    return { level: 'good', text: 'â–³ è¦æ¤œè¨' };
                } else if (doseRate <= this.safetyLimits.occupational) {
                    return { level: 'warning', text: 'âš  åŸºæº–è¶…é' };
                } else {
                    return { level: 'danger', text: 'âœ— å±é™º' };
                }
            }

            calculateEfficiency(material, thickness) {
                // åšã•ãƒ»é‡é‡ãƒ»ã‚³ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸåŠ¹ç‡æŒ‡æ¨™
                const volume = thickness; // å˜ä½é¢ç©ã‚ãŸã‚Š
                const weight = volume * material.density;
                const cost = weight * material.cost;
                
                return {
                    volume: volume,
                    weight: weight,
                    cost: cost,
                    costEfficiency: 1 / cost // å˜ç´”åŒ–
                };
            }
        }

        // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            const learningManager = new AdvancedLearningManager();
            const calculator = new AdvancedShieldingCalculator();
            let visualizer = null;

            // 3Då¯è¦–åŒ–ã®åˆæœŸåŒ–
            setTimeout(() => {
                const container = document.getElementById('threejs-container');
                if (container) {
                    visualizer = new Advanced3DVisualizer(container);
                    updateAllVisualization();
                }
            }, 100);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
            
            // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
            learningManager.updateProgress();
            updateMaterialProperties();
            updateHVLDisplay();

            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            setTimeout(() => {
                alert('ğŸ›¡ï¸ Poker MCP Level 1: åŸºç¤ç¿’å¾—ã¸ã‚ˆã†ã“ãï¼\n\n' +
                      'ğŸ¯ å­¦ç¿’ç›®æ¨™:\n' +
                      'â€¢ æ”¾å°„ç·šé®è”½ã®ç‰©ç†å­¦çš„åŸç†ã®ç†è§£\n' +
                      'â€¢ ææ–™ç‰¹æ€§ã¨é®è”½åŠ¹æœã®å®šé‡çš„é–¢ä¿‚\n' +
                      'â€¢ å®Ÿç”¨çš„ãªé®è”½è¨­è¨ˆã®åŸºç¤çŸ¥è­˜\n\n' +
                      'å³å´ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ãªãŒã‚‰ã€3Då¯è¦–åŒ–ã§\n' +
                      'é®è”½åŠ¹æœã‚’ä½“æ„Ÿã—ã¦ãã ã•ã„ï¼');
            }, 1000);

            function setupEventListeners() {
                // ææ–™å¤‰æ›´
                document.getElementById('shield-material').addEventListener('change', function() {
                    updateMaterialProperties();
                    updateHVLDisplay();
                    updateAllVisualization();
                    learningManager.trackInteraction('material_change', this.value);
                });

                // åšã•èª¿æ•´
                document.getElementById('thickness-slider').addEventListener('input', function() {
                    document.getElementById('thickness-value').textContent = this.value + ' cm';
                    updateHVLDisplay();
                    updateAllVisualization();
                    learningManager.trackInteraction('thickness_change', this.value);
                });

                // è·é›¢èª¿æ•´
                document.getElementById('source-distance').addEventListener('input', function() {
                    document.getElementById('source-distance-value').textContent = this.value + ' cm';
                    updateAllVisualization();
                    learningManager.trackInteraction('distance_change', this.value);
                });

                document.getElementById('detector-distance').addEventListener('input', function() {
                    document.getElementById('detector-distance-value').textContent = this.value + ' cm';
                    updateAllVisualization();
                    learningManager.trackInteraction('distance_change', this.value);
                });

                // ç·šæºãƒ»æ”¾å°„èƒ½å¤‰æ›´
                document.getElementById('radiation-source').addEventListener('change', function() {
                    learningManager.trackInteraction('source_change', this.value);
                });

                document.getElementById('source-activity').addEventListener('change', function() {
                    learningManager.trackInteraction('activity_change', this.value);
                });

                // è¨ˆç®—å®Ÿè¡Œ
                document.getElementById('calculate-btn').addEventListener('click', performCalculation);

                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                document.getElementById('next-step').addEventListener('click', function() {
                    if (learningManager.currentStep === learningManager.totalSteps) {
                        learningManager.completeLevel1();
                    } else {
                        learningManager.nextStep();
                    }
                });

                document.getElementById('prev-step').addEventListener('click', function() {
                    learningManager.previousStep();
                });

                // è£œåŠ©æ©Ÿèƒ½
                document.getElementById('hint-btn').addEventListener('click', showPhysicsHint);
                document.getElementById('compare-materials').addEventListener('click', showMaterialComparison);
                document.getElementById('restart-btn').addEventListener('click', resetAllParameters);

                // 3Dåˆ¶å¾¡
                document.getElementById('play-animation').addEventListener('click', function() {
                    if (visualizer) {
                        visualizer.playRadiationAnimation();
                        this.style.display = 'none';
                        document.getElementById('pause-animation').style.display = 'inline-block';
                        learningManager.trackInteraction('animation_play');
                    }
                });

                document.getElementById('pause-animation').addEventListener('click', function() {
                    if (visualizer) {
                        visualizer.stopRadiationAnimation();
                        this.style.display = 'none';
                        document.getElementById('play-animation').style.display = 'inline-block';
                        learningManager.trackInteraction('animation_pause');
                    }
                });

                document.getElementById('reset-view').addEventListener('click', function() {
                    if (camera) {
                        camera.position.set(8, 6, 12);
                        camera.lookAt(0, 0, 0);
                        learningManager.trackInteraction('view_reset');
                    }
                });
            }

            function updateMaterialProperties() {
                const materialKey = document.getElementById('shield-material').value;
                const material = materialDatabase[materialKey];
                
                const propertiesDiv = document.getElementById('material-properties');
                propertiesDiv.innerHTML = `
                    <strong>${material.name} ã®ç‰¹æ€§:</strong><br>
                    â€¢ åŸå­ç•ªå·: Z=${material.atomicNumber}<br>
                    â€¢ å¯†åº¦: ${material.density} g/cmÂ³<br>
                    â€¢ è³ªé‡æ¸›è¡°ä¿‚æ•°: ${material.muMass.toFixed(4)} cmÂ²/g<br>
                    â€¢ ç·šæ¸›è¡°ä¿‚æ•°: ${(material.muMass * material.density).toFixed(3)} cmâ»Â¹<br>
                    â€¢ ä¸»ãªç”¨é€”: ${material.applications}
                `;
            }

            function updateHVLDisplay() {
                const materialKey = document.getElementById('shield-material').value;
                const thickness = parseFloat(document.getElementById('thickness-slider').value);
                const material = materialDatabase[materialKey];
                
                const mu = material.muMass * material.density;
                const hvl = Math.log(2) / mu;
                const hvlRatio = thickness / hvl;
                const attenuationPercent = (1 - Math.exp(-mu * thickness)) * 100;
                
                const hvlDisplay = document.getElementById('hvl-display');
                hvlDisplay.innerHTML = `
                    åšã•: ${hvlRatio.toFixed(1)} HVL<br>
                    æ¸›è¡°ç‡: ${attenuationPercent.toFixed(1)}%<br>
                    åŠä¾¡å±¤åš: ${hvl.toFixed(1)} cm
                `;
            }

            function updateAllVisualization() {
                if (!visualizer) return;

                const materialKey = document.getElementById('shield-material').value;
                const thickness = parseFloat(document.getElementById('thickness-slider').value) / 10; // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
                
                visualizer.updateShield(materialKey, thickness);
                visualizer.updatePositions();
            }

            function performCalculation() {
                const materialKey = document.getElementById('shield-material').value;
                const thickness = parseFloat(document.getElementById('thickness-slider').value);
                const sourceDistance = parseFloat(document.getElementById('source-distance').value);
                const detectorDistance = parseFloat(document.getElementById('detector-distance').value);
                const sourceKey = document.getElementById('radiation-source').value;
                const activity = parseFloat(document.getElementById('source-activity').value);

                // è¨ˆç®—å®Ÿè¡Œ
                const results = calculator.calculate(
                    materialKey, thickness, sourceDistance, detectorDistance, sourceKey, activity
                );

                // çµæœè¡¨ç¤º
                displayResults(results);
                
                // å­¦ç¿’è¿½è·¡
                learningManager.trackCalculation(results);

                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
                provideFeedback(results, materialKey);
            }

            function displayResults(results) {
                const resultsPanel = document.getElementById('results-display');
                resultsPanel.style.display = 'block';

                // é€éç·šé‡ç‡
                document.getElementById('dose-rate-result').textContent = 
                    results.shieldedRate.toFixed(2) + ' Î¼Sv/h';

                // æ¸›è¡°ç‡
                document.getElementById('attenuation-result').textContent = 
                    results.attenuationPercent.toFixed(1) + '%';

                // ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ä¿‚æ•°
                document.getElementById('buildup-result').textContent = 
                    results.buildup.toFixed(2);

                // HVLæ¯”
                document.getElementById('hvl-ratio').textContent = 
                    results.hvlRatio.toFixed(1) + ' HVL';

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                updateResultStatuses(results);
            }

            function updateResultStatuses(results) {
                // å®‰å…¨çŠ¶æ…‹
                const safetyStatus = document.getElementById('safety-status');
                safetyStatus.textContent = results.safetyStatus.text;
                safetyStatus.className = `result-status ${results.safetyStatus.level}`;

                // æ¸›è¡°ç‡è©•ä¾¡
                const attenuationStatus = document.getElementById('attenuation-status');
                if (results.attenuationPercent > 99) {
                    attenuationStatus.textContent = 'å„ªç§€';
                    attenuationStatus.className = 'result-status excellent';
                } else if (results.attenuationPercent > 90) {
                    attenuationStatus.textContent = 'è‰¯å¥½';
                    attenuationStatus.className = 'result-status good';
                } else if (results.attenuationPercent > 50) {
                    attenuationStatus.textContent = 'æ™®é€š';
                    attenuationStatus.className = 'result-status warning';
                } else {
                    attenuationStatus.textContent = 'ä¸è¶³';
                    attenuationStatus.className = 'result-status danger';
                }

                // ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—è©•ä¾¡
                const buildupStatus = document.getElementById('buildup-status');
                if (results.buildup < 1.5) {
                    buildupStatus.textContent = 'ä½';
                    buildupStatus.className = 'result-status excellent';
                } else if (results.buildup < 3.0) {
                    buildupStatus.textContent = 'ä¸­';
                    buildupStatus.className = 'result-status good';
                } else {
                    buildupStatus.textContent = 'é«˜';
                    buildupStatus.className = 'result-status warning';
                }

                // HVLè©•ä¾¡
                const hvlStatus = document.getElementById('hvl-status');
                if (results.hvlRatio > 5) {
                    hvlStatus.textContent = 'ååˆ†';
                    hvlStatus.className = 'result-status excellent';
                } else if (results.hvlRatio > 2) {
                    hvlStatus.textContent = 'é©åˆ‡';
                    hvlStatus.className = 'result-status good';
                } else {
                    hvlStatus.textContent = 'ä¸è¶³';
                    hvlStatus.className = 'result-status warning';
                }
            }

            function provideFeedback(results, materialKey) {
                const material = materialDatabase[materialKey];
                let feedback = '';

                if (results.safetyStatus.level === 'excellent') {
                    feedback = `ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼${material.name}ã«ã‚ˆã‚‹é®è”½ãŒåŠ¹æœçš„ã«æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚`;
                    if (results.hvlRatio > 10) {
                        feedback += '\nğŸ’¡ åšã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
                    }
                } else if (results.safetyStatus.level === 'good') {
                    feedback = `âœ… åŸºæœ¬çš„ãªé®è”½ã¯é”æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ç”¨é€”ã«å¿œã˜ã¦ã•ã‚‰ãªã‚‹æ”¹å–„ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚`;
                } else if (results.safetyStatus.level === 'warning') {
                    feedback = `âš ï¸ é®è”½ãŒä¸ååˆ†ã§ã™ã€‚åšã•ã‚’å¢—åŠ ã™ã‚‹ã‹ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªææ–™ã¸ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    feedback = `ğŸš« å±é™ºãƒ¬ãƒ™ãƒ«ã§ã™ï¼é®è”½ã®å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™ã€‚`;
                }

                // ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ãŒé«˜ã„å ´åˆã®è¿½åŠ ã‚¢ãƒ‰ãƒã‚¤ã‚¹
                if (results.buildup > 3) {
                    feedback += `\nğŸ”¬ ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—åŠ¹æœãŒé¡•è‘—ã§ã™ã€‚æ•£ä¹±ç·šã®è“„ç©ã«ã‚ˆã‚Šã€å˜ç´”è¨ˆç®—ã‚ˆã‚Šé€éãŒå¢—åŠ ã—ã¦ã„ã¾ã™ã€‚`;
                }

                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                setTimeout(() => {
                    alert(feedback);
                }, 500);
            }

            function showPhysicsHint() {
                const hints = {
                    1: `ğŸ”¬ ç‰©ç†å­¦çš„èƒŒæ™¯\n\n` +
                       `æ”¾å°„ç·šé®è”½ã¯ä¸»ã«3ã¤ã®ç›¸äº’ä½œç”¨ã§èµ·ã“ã‚Šã¾ã™ï¼š\n` +
                       `â€¢ å…‰é›»åŠ¹æœ: ä½ã‚¨ãƒãƒ«ã‚®ãƒ¼é ˜åŸŸã§æ”¯é…çš„\n` +
                       `â€¢ ã‚³ãƒ³ãƒ—ãƒˆãƒ³æ•£ä¹±: ä¸­ã‚¨ãƒãƒ«ã‚®ãƒ¼é ˜åŸŸ\n` +
                       `â€¢ é›»å­å¯¾ç”Ÿæˆ: é«˜ã‚¨ãƒãƒ«ã‚®ãƒ¼é ˜åŸŸ\n\n` +
                       `ææ–™ã®åŸå­ç•ªå·ZãŒé«˜ã„ã»ã©å…‰é›»åŠ¹æœãŒå¼·ããªã‚Šã€\n` +
                       `ä½ã‚¨ãƒãƒ«ã‚®ãƒ¼Î³ç·šã«å¯¾ã—ã¦åŠ¹æœçš„ã§ã™ã€‚`,
                    
                    2: `ğŸ§ª ææ–™é¸æŠã®ç§‘å­¦\n\n` +
                       `é®è”½åŠ¹ç‡ã¯ä»¥ä¸‹ã§æ±ºã¾ã‚Šã¾ã™ï¼š\n` +
                       `â€¢ å¯†åº¦Ï: å˜ä½ä½“ç©ã‚ãŸã‚Šã®åŸå­æ•°\n` +
                       `â€¢ åŸå­ç•ªå·Z: å…‰é›»åŠ¹æœã¸ã®å½±éŸ¿\n` +
                       `â€¢ ä¾¡æ ¼: å®Ÿç”¨æ€§ã¸ã®å½±éŸ¿\n\n` +
                       `é‰›ã¯é«˜Zãƒ»é«˜å¯†åº¦ã§å„ªç§€ã§ã™ãŒã€\n` +
                       `ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¯å®‰ä¾¡ã§å¤§å‹æ–½è¨­ã«é©ã—ã¦ã„ã¾ã™ã€‚`,
                    
                    3: `ğŸ“ å¹¾ä½•å­¦çš„è€ƒæ…®äº‹é …\n\n` +
                       `è·é›¢ã®åŠ¹æœã¯é€†äºŒä¹—å‰‡ã«å¾“ã„ã¾ã™ï¼š\n` +
                       `â€¢ è·é›¢2å€ â†’ ç·šé‡ç‡1/4\n` +
                       `â€¢ è·é›¢3å€ â†’ ç·šé‡ç‡1/9\n\n` +
                       `ãŸã ã—æ•£ä¹±ç·šã‚„ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚Šã€\n` +
                       `å®Ÿéš›ã®æ¸›è¡°ã¯è¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚`,
                    
                    4: `ğŸ—ï¸ å®Ÿç”¨è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ\n\n` +
                       `å®Ÿéš›ã®è¨­è¨ˆã§ã¯ä»¥ä¸‹ã‚’è€ƒæ…®ï¼š\n` +
                       `â€¢ è¦åˆ¶åŸºæº–å€¤ï¼ˆä¸€èˆ¬å…¬è¡†: 1mSv/å¹´ï¼‰\n` +
                       `â€¢ å®‰å…¨ä¿‚æ•°ï¼ˆé€šå¸¸1.5-2å€ï¼‰\n` +
                       `â€¢ çµŒæ¸ˆæ€§ï¼ˆææ–™ãƒ»æ–½å·¥ã‚³ã‚¹ãƒˆï¼‰\n` +
                       `â€¢ ä¿å®ˆæ€§ï¼ˆç‚¹æ¤œãƒ»äº¤æ›ã®å®¹æ˜“ã•ï¼‰\n\n` +
                       `ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã«ã‚ˆã‚‹è©³ç´°è¨ˆç®—ã‚‚é‡è¦ã§ã™ã€‚`
                };

                alert(hints[learningManager.currentStep] || hints[1]);
            }

            function showMaterialComparison() {
                const comparisonTable = document.getElementById('comparison-table');
                const tbody = document.getElementById('comparison-tbody');
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹ã®ç”Ÿæˆ
                tbody.innerHTML = '';
                Object.entries(materialDatabase).forEach(([key, material]) => {
                    const mu = material.muMass * material.density;
                    const hvl = Math.log(2) / mu;
                    const efficiency = material.density / material.cost; // ç°¡æ˜“åŠ¹ç‡æŒ‡æ¨™
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${material.name}</strong></td>
                        <td>${material.density}</td>
                        <td>${material.muMass.toFixed(4)}</td>
                        <td>${hvl.toFixed(1)}</td>
                        <td>${efficiency.toFixed(2)}</td>
                    `;
                    
                    // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ææ–™ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (key === document.getElementById('shield-material').value) {
                        row.style.backgroundColor = '#e0f2fe';
                        row.style.fontWeight = 'bold';
                    }
                });
                
                comparisonTable.style.display = 'block';
                
                // å­¦ç¿’è¿½è·¡
                learningManager.trackInteraction('material_comparison');
                
                setTimeout(() => {
                    alert('ğŸ“Š ææ–™æ¯”è¼ƒè¡¨ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼\n\n' +
                          'å„ææ–™ã®å¯†åº¦ã€è³ªé‡æ¸›è¡°ä¿‚æ•°ã€åŠä¾¡å±¤åšã€\n' +
                          'ç›¸å¯¾åŠ¹ç‡ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚\n\n' +
                          'ç¾åœ¨é¸æŠä¸­ã®ææ–™ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚');
                }, 200);
            }

            function resetAllParameters() {
                if (confirm('ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    document.getElementById('shield-material').value = 'concrete';
                    document.getElementById('thickness-slider').value = '10';
                    document.getElementById('source-distance').value = '50';
                    document.getElementById('detector-distance').value = '50';
                    document.getElementById('radiation-source').value = 'cs137';
                    document.getElementById('source-activity').value = '3.7e10';
                    
                    // è¡¨ç¤ºæ›´æ–°
                    document.getElementById('thickness-value').textContent = '10 cm';
                    document.getElementById('source-distance-value').textContent = '50 cm';
                    document.getElementById('detector-distance-value').textContent = '50 cm';
                    
                    // çµæœãƒ‘ãƒãƒ«éè¡¨ç¤º
                    document.getElementById('results-display').style.display = 'none';
                    document.getElementById('comparison-table').style.display = 'none';
                    
                    // æ›´æ–°å‡¦ç†
                    updateMaterialProperties();
                    updateHVLDisplay();
                    updateAllVisualization();
                    
                    learningManager.trackInteraction('reset_all');
                }
            }

            // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', function() {
                if (camera && renderer) {
                    const container = document.getElementById('threejs-container');
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
            });
        });